{% extends "cyano/base.html" %}

{% comment %}
List template

Author: Jonathan Karr, jkarr@stanford.edu
Affiliation: Covert Lab, Department of Bioengineering, Stanford University
Last updated: 2012-07-17

Copyright (c) 2013 Gabriel Kind <gkind@hs-mittweida.de>
Hochschule Mittweida, University of Applied Sciences

Released under the MIT license
{% endcomment %}

{% load static %}
{% load templatetags %}
{% load filters %}

{% block head_title %}{{ block.super }} :: {{ model_verbose_name_plural }}{% endblock %}
{% block page_title %}{{ model_verbose_name_plural }}{% endblock %}

{% block head %}
{{ block.super }}
<meta name="entry_type" content="{{ model_verbose_name }}" />

<script language="javascript" type="text/javascript" src="{% get_static_prefix %}cyano/js/endless.js"></script>
<script language="javascript" type="text/javascript" src="{% get_static_prefix %}cyano/js/endless_on_scroll.js"></script>
<script language="javascript" type="text/javascript" charset="utf-8">var endless_on_scroll_margin = 200;</script>

<script language="javascript" type="text/javascript" charset="utf-8">

$(document).ready(function() {
    var basket_list = $("#basket-list");
    var no_click = false;

    basket_list.multiselect({header: false});
    basket_list.multiselect("getButton").hide();

    basket_list.on("multiselectclick", function(event, ui) {
        if (no_click) {
            return;
        }

        $.ajax({
            type: "POST",
            url: "{% url "cyano-basket-op" species_wid=species.wid %}",
            context: document.body,
            data: {
                "id": ui.value.substring(6),
                "wid": basket_list.data("wid"),
                "op": ui.checked ? "add" : "remove"
            }
        });
    });

	$("table#list").on("click", ".cart-add-button", function (event) {
		event.preventDefault();

        //$("#basket-list").clone().multiselect({'element': $(event.target), 'selectedText': ''});

        var target = $(event.target);
        var parent = target.parents("tr");

         $.ajax({
            type: "POST",
            url: "{% url "cyano-basket-op" species_wid=species.wid %}",
            context: document.body,
            async: false,
            data: {
                "id": parent.data("pk"),
                "op": "list_item"
            }
        }).done(function(result) {
			var json = jQuery.parseJSON(result);

            no_click = true;
            basket_list.multiselect("widget").find(":input:checked").each(function() {
                this.click();
            });

            basket_list.find("option").each(function(index, value) {
                var val = $(value);
                if (json.baskets.indexOf(val.data("pk")) >= 0) {
                    basket_list.multiselect("widget").find(":input:eq(" + (index) + ")").each(function(){
                        this.click();
                    });
                }
            });
            no_click = false;
		});

        basket_list.data("wid", parent.data("pk"));
        basket_list.multiselect("option", "position", {my: "center bottom", of: $(event.target)});
        basket_list.multiselect("refresh");
        basket_list.multiselect("open");
	});
});

</script>
{% endblock %}

{% block action_icons_edit %}
<li><a href="{% url "cyano.views.add" species_wid=species.wid model_type=model_type %}"><img src="{% get_static_prefix %}public/img/add.png" title="Add" alt="Add" />Add new {{ model_verbose_name }}</a></li>
{{ block.super }}
{% endblock %}
{% block action_icons_export %}
<li><a href="?{% makeurl queryargs 'format' 'xlsx' %}"><img src="{% get_static_prefix %}public/img/excel.gif" title="Download in Excel format" alt="Download in Excel format" />Download {{ model_verbose_name_plural }} in Excel format</a></li>
<li><a href="?{% makeurl queryargs 'format' 'json' %}"><img src="{% get_static_prefix %}public/img/json.png" title="Download in JSON format" alt="Download in JSON format" />Download {{ model_verbose_name_plural }} in JSON format</a></li>
<li><a href="?{% makeurl queryargs 'format' 'xml' %}"><img src="{% get_static_prefix %}public/img/xml.gif" title="Download in XML format" alt="Download in XML format" />Download {{ model_verbose_name_plural }} in XML format</a></li>
<li><a href="?{% makeurl queryargs 'format' 'fasta' %}">Download {{ model_verbose_name_plural }} in FASTA format</a></li>
{{ block.super }}
{% endblock %}

{% block extrastyles %}
#listfilter .nofilters{
	font-style:italic;
	text-align:center;
}

#feedback { font-size: 1.4em; }
#selectable .ui-selecting { background: #FECA40; }
#selectable .ui-selected { background: #F39814; color: white; }
#selectable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
#selectable li { margin: 3px; padding: 0.4em; font-size: 1.4em; height: 18px; }

input.text { margin-bottom:12px; width:95%; padding: .4em; }
fieldset { padding:0; border:0; margin-top:25px; }
div#users-contain { width: 350px; margin: 20px 0; }
div#users-contain table { margin: 1em 0; border-collapse: collapse; width: 100%; }
div#users-contain table td, div#users-contain table th { border: 1px solid #eee; padding: .6em 10px; text-align: left; }
.ui-dialog .ui-state-error { padding: .3em; }
.validateTips { border: 1px solid transparent; padding: 0.3em }

{% if facet_fields|length == 0 %}
#list{
	width:100%;
}
#listfilter{
	display:none;
}

{% endif %}
{% endblock %}

{% block content %}

{% if groups %}
<table id="list">
{% for key, value in groups.items %}
<thead>
	<tr>
		<th>WID</th>
		<th>Name</th>
		{% if not request.user.is_anonymous %}
		<th>&nbsp;</th>
		{% endif %}
	</tr>
</thead>
<tbody>
{% for object in value %}
{% with item=basket_object %}
<tr data-pk="{{ object.pk }}">
	<th><a href="{{ object|get_absolute_url:species }}">{{ object.wid }}</a></th>
	<td><a href="{{ object|get_absolute_url:species }}">{% autoescape off %}{{ object.name|truncatechars:80 }}{% endautoescape %}</a></td>
	{% if not request.user.is_anonymous %}
	<td>
		<a href="#" class="cart-add-button" title="Add to basket"><img src="{% get_static_prefix %}cyano/img/cart/cart.png" /></a>
		<a href="{% url "cyano.views.edit" species_wid=species.wid model_type=model_type wid=object.wid %}"><img src="{% get_static_prefix %}public/img/pencil.png" /></a>
		<a href="{% url "cyano.views.delete" species_wid=species.wid model_type=model_type wid=object.wid %}"><img src="{% get_static_prefix %}public/img/delete.png" /></a>
	</td>
	{% endif %}
</tr>
{% endwith %}
{% endfor %}
</tbody>
<tbody class="spacing">
    <tr><td colspan="2">&nbsp;</td></tr>
</tbody>
{% endfor %}
</table>
{% else %}
<table id="list">
<thead>
	<tr>
		<th>WID</th>
		<th>Name</th>
		{% if not request.user.is_anonymous %}
		<th>&nbsp;</th>
		{% endif %}
	</tr>
</thead>
<tbody>
{% include "cyano/list_page.html" %}
</tbody>
</table>
{% endif %}

<div id="listfilter">
<h1>Filter</h1>
{% for field in facet_fields %}
	{% with field_name=field.name field_verbose_name=field.verbose_name %}
	<div class="block">
	<h2>{% autoescape off %}{{ field_verbose_name }}{% endautoescape %}</h2>
	<ul>
		<li{% if not queryargs|getattribute:field_name %} class="selected"{% endif %}><a href="{% url "cyano.views.listing" species_wid=species.wid model_type=model_type %}?{% makeurl queryargs field_name '' %}">All</a></li>
		{% for facet in field.facets %}
		<li
				{% if queryargs|getattribute:field_name %}
					{% if facet.id in queryargs|getattribute:field_name %}
			class="selected"
					{% endif %}
				{% endif %}>
			<a href="{% url "cyano.views.listing" species_wid=species.wid model_type=model_type %}?{% makeurl queryargs field_name facet.id %}">{% autoescape off %}{{ facet.name }}{% endautoescape %} ({{ facet.count }})</a></li>
		{% endfor %}
	</ul>
	</div>
	{% endwith %}
{% endfor %}
</div>

<div style="clear:both;"></div>

<select id="basket-list" multiple="multiple" style="visibility:hidden">
{% for basket in baskets %}
<option value="basket{{ basket.pk }}" data-pk="{{ basket.pk }}">{{ basket.name }}</option>
{% endfor %}
</select>

{% endblock %}
