{% extends "cyano/base.html" %}

{% comment %}
Detail page template

Author: Jonathan Karr, jkarr@stanford.edu
Affiliation: Covert Lab, Department of Bioengineering, Stanford University
Last updated: 2012-07-17

Copyright (c) 2013 Gabriel Kind <gkind@hs-mittweida.de>
Hochschule Mittweida, University of Applied Sciences

Released under the MIT license
{% endcomment %}

{% load static %}
{% load templatetags %}

{% block head_title %}{% with object=queryset.0 %}{{ block.super }} :: {{ object.wid }}{% endwith %}{% endblock %}
{% block page_title %}{% with object=queryset.0 %}{{ object.wid }}{% if object.name|length > 0 %} &ndash; {{ object.name }}{% endif %}{% endwith %}{% endblock %}

{% block head %}
{{ block.super }}
{% with object=queryset.0 %}
<meta name="entry_created" content="{{ object.created_date }}" />
<meta name="entry_last_updated" content="{{ object.last_updated_date }}" />
<meta name="entry_type" content="{{ model_verbose_name }}" />
<meta name="entry_wid" content="{{ object.wid }}" />
{% if object.name|length > 0 %}
<meta name="entry_name" content="{{ object.name }}" />
{% else %}
<meta name="entry_name" content="{{ object.wid }}" />
{% endif %}
{% endwith %}

<script language="javascript" type="text/javascript" charset="utf-8">

$(document).ready(function() {
    var dialog_error = $("#dialog-error");
    var basket_list = $("#basket-list");
    var no_click = false;

    basket_list.multiselect({header: false});
    basket_list.multiselect("getButton").hide();

    basket_list.on("multiselectclick", function(event, ui) {
        if (no_click) {
            return;
        }

        $.ajax({
            type: "POST",
            url: "{% url "cyano-basket-op" species_wid=species.wid %}",
            context: document.body,
            data: {
                "id": ui.value.substring(6),
                "wid": basket_list.data("wid"),
                "op": ui.checked ? "add" : "remove"
            }
        });
    });

	$("li#action_icons_edit").on("click", ".cart-add-button", function (event) {
		event.preventDefault();

        {% if not request.user.is_authenticated %}
        dialog_error.dialog("open");
        return;
        {% endif %}

        //$("#basket-list").clone().multiselect({'element': $(event.target), 'selectedText': ''});

        var target = $(event.target);
        var parent = target.parents("li");

         $.ajax({
            type: "POST",
            url: "{% url "cyano-basket-op" species_wid=species.wid %}",
            context: document.body,
            async: false,
            data: {
                "id": parent.data("pk"),
                "op": "list_item"
            }
        }).done(function(result) {
			var json = jQuery.parseJSON(result);

            no_click = true;
            basket_list.multiselect("widget").find(":input:checked").each(function() {
                this.click();
            });

            basket_list.find("option").each(function(index, value) {
                var val = $(value);
                if (json.baskets.indexOf(val.data("pk")) >= 0) {
                    basket_list.multiselect("widget").find(":input:eq(" + (index) + ")").each(function(){
                        this.click();
                    });
                }
            });
            no_click = false;
		});

        basket_list.data("wid", parent.data("pk"));
        basket_list.multiselect("option", "position", {my: "top left", of: $(event.target)});
        basket_list.multiselect("refresh");
        basket_list.multiselect("open");
	});

    dialog_error.dialog({
        autoOpen: false,
        height: 200,
        width: 350,
        modal: true,
        buttons: {
            "OK": function () {
                $(this).dialog("close");
            }
        }
    });
});

</script>
{% endblock %}

{% block action_icons_edit %}
{% with object=queryset.0 %}
<li data-pk="{{ object.pk }}"><a href="#" class="cart-add-button" title="Add to basket"><img src="{% get_static_prefix %}cyano/img/cart/cart.png" />Add to basket</a></li>
<li><a href="{% url "cyano.views.edit" species_wid=species.wid model_type=model_type wid=object.wid %}"><img src="{% get_static_prefix %}public/img/pencil.png" title="Edit" alt="Edit" />Edit {{ object.wid }}</a></li>
<li><a href="{% url "cyano.views.delete" species_wid=species.wid model_type=model_type wid=object.wid %}"><img src="{% get_static_prefix %}public/img/delete.png" title="Delete" alt="Delete" />Delete {{ object.wid }}</a></li>
<li><a href="{% url "cyano.views.permission" species_wid=species.wid model_type=model_type wid=object.wid %}"><img src="{% get_static_prefix %}public/img/lock.png" title="View permissions" alt="View permissions" />View permissions of {{ object.wid }}</a></li>
{% endwith %}
{% endblock %}
{% block action_icons_export %}
{% with object=queryset.0 %}
<li><a href="?{% makeurl queryargs 'format' 'xlsx' %}"><img src="{% get_static_prefix %}public/img/excel.gif" title="Download in Excel format" alt="Download in Excel format" />Download {{ object.wid }} in Excel format</a></li>
<li><a href="?{% makeurl queryargs 'format' 'json' %}"><img src="{% get_static_prefix %}public/img/json.png" title="Download in JSON format" alt="Download in JSON format" />Download {{ object.wid }} in JSON format</a></li>
<li><a href="?{% makeurl queryargs 'format' 'xml' %}"><img src="{% get_static_prefix %}public/img/xml.gif" title="Download in XML format" alt="Download in XML format" />Download {{ object.wid }} in XML format</a></li>
<li><a href="?{% makeurl queryargs 'format' 'fasta' %}">Download {{ object.wid }} in FASTA format</a></li>
<li><a href="?{% makeurl queryargs 'format' 'genbank' %}">Download {{ object.wid }} in GenBank format</a></li>
{{ block.super }}
{% endwith %}
{% endblock %}

{% block content %}
{% autoescape off %}
{% with object=queryset.0 %}
<table id="detail">	
	{% with object=queryset.0 %}
	{% for fieldset in fieldsets %}
		{% if not forloop.first %}
	<tbody class="spacing">
		<tr><td colspan="2">&nbsp;</td></tr>
	</tbody>
		{% endif %}
	<tbody class="data">
		<tr>
			<th colspan="2">{{ fieldset.0 }}</th>
		</tr>				
		{% for field in fieldset.1.fields %}
		<tr>			
			<th>{{ field.verbose_name }}</th>
			<td>{{ field.data }}</td>
		</tr>
		{% endfor %}
	</tbody>
	{% endfor %}
	{% endwith %}	
</table>
{% endwith %}
{% endautoescape %}

<select id="basket-list" multiple="multiple" style="visibility:hidden">
{% for basket in baskets %}
<option value="basket{{ basket.pk }}" data-pk="{{ basket.pk }}">{{ basket.name }}</option>
{% endfor %}
</select>

<div id="dialog-error" title="Login required">
    Please login first.
</div>
{% endblock %}
