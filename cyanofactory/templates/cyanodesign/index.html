{% extends "cyano/base.html" %}

{% comment %}
Cyanodesign index page

Copyright (c) 2013 Gabriel Kind <gkind@hs-mittweida.de>
Hochschule Mittweida, University of Applied Sciences

Released under the MIT license
{% endcomment %}

{% load static %}
{% load staticfiles %}
{% load templatetags %}
{% load filters %}

{% block head_title %}{{ block.super }} :: Cyanodesign{% endblock %}
{% block page_title %}Cyanodesign{% endblock %}

{% block head %}
{{ block.super }}

<script type="text/javascript">
    var enzymes = [];
    var metabolites = [];
    var design_objective;
    var dialog_metabolite_edit;
    var dialog_enzyme;
    var dialog_metabolite_add;
    var cyano_design_objective_select;
    var cyano_design_enzymes;
    var constraints_div;
    var simulation_result;
    var add_button;
    var delete_button;
    var create_new_enzyme = false;
    var metabolite_combobox;

    function Enzyme(name) {
        this.name = name;
        this.reversible = false;
        this.substrates = [];
        this.products = [];
        this.stoichiometric_substrates = [];
        this.stoichiometric_products = [];
        this.constraints = [0, null];

        this.isConstrained = function() {
            return this.constraints[1] !== null;
        }

        this.makeUnconstrained = function() {
            this.constraints[0] = this.reversible ? null : 0;
            this.constraints[1] = null;
        }

        this.toHTML = function() {
            var reac = function(substrates) {
                return function(value, index) {
                    var elem = substrates[index] + " ";
                    if (value.external) {
                        return elem + $("<span></span>").addClass("external-metabolite").text(value.name)[0].outerHTML;
                    }
                    return elem + value.name;
                }
            }

            var element = $("<div>").addClass("cyano-reaction").data("object", this);
            element.append(this.name + ": ");
            element.append(this.substrates.map(reac(this.stoichiometric_substrates)).join(" + "));
            element.append(this.reversible ? " <-> " : " -> ");
            element.append(this.products.map(reac(this.stoichiometric_products)).join(" + "));

            if (this.isConstrained()) {
                element.append(" [" + this.constraints[0] + ", " + this.constraints[1] + "]");
            } else {
                element.append(" <i>unconstrained</i>");
            }
            element.append("</div>");

            return element;
        }

        this.toString = function() {
             var reac = function(substrates) {
                return function(value, index) {
                    var elem = substrates[index] + " ";
                    return elem + value.name;
                }
            }

            var element = "";
            element = element.concat(this.name + " : ");
            element = element.concat(this.substrates.map(reac(this.stoichiometric_substrates)).join(" + "));
            element = element.concat(this.reversible ? " <-> " : " -> ");
            element = element.concat(this.products.map(reac(this.stoichiometric_products)).join(" + "));
            return element;
        }

        this.constraintsToString = function() {
            if (!this.isConstrained()) {
                return "";
            } else {
                return this.name + " [" + this.constraints.join(", ") + "]";
            }
        }
    }

    function Metabolite(name, external) {
        this.external = external;
        this.name = name;

        this.updateName = function(new_name) {
            var idx = indexOfMetabolite(new_name);

            if (idx === -1 ||
                metabolites[idx] == this) {
                this.name = new_name;
                metabolites[idx] = this;
                return true;
            }
            return false;
        }
    }

    function indexOfMetabolite(value) {
        for (var index = 0; index < metabolites.length; ++index) {
            if (metabolites[index].name == value) {
                return index;
            }
        }
        return -1;
    }

    function createMetabolites(reaction) {
        var metabolite_fn = function(value) {
            var idx = indexOfMetabolite(value);
            if (idx == -1) {
                metabolites.push(new Metabolite(value, false));
            }
        }

        reaction["substrates"].forEach(metabolite_fn);
        reaction["products"].forEach(metabolite_fn);
    }

    function createExternalMetabolites(external) {
        var metabolite_fn = function(value) {
           var idx = indexOfMetabolite(value);
            if (idx == -1) {
                metabolites.push(new Metabolite(value, true));
            } else {
                metabolites[idx].external = true;
            }
        }
        external.forEach(metabolite_fn);
    }

    function getExternalMetabolites() {
        return metabolites.filter(function(value) {
            return value.external;
        });
    }

    function createEnzyme(reaction) {
        var enzyme = new Enzyme(reaction["name"]);

        enzyme.products = reaction.products.map(
            function(value) {
                return metabolites[indexOfMetabolite(value)];
            }
        );

        enzyme.substrates = reaction.substrates.map(
            function(value) {
                return metabolites[indexOfMetabolite(value)];
            }
        );

        enzyme.stoichiometric_substrates = reaction.stoichiometric[0];
        enzyme.stoichiometric_products = reaction.stoichiometric[1];
        enzyme.reversible = reaction.reversible;
        enzyme.constraints = reaction.constraints;

        return enzyme;
    }

    $(function () {
        dialog_metabolite_edit = $("#dialog-edit-metabolite");
        dialog_enzyme = $("#dialog-reaction");
        dialog_metabolite_add = $("#dialog-add-metabolite");
        cyano_design_objective_select = $("#cyano-design-objective-select");
        cyano_design_enzymes = $(".cyano-design-enzymes");
        constraints_div = $("#constraints-min-max");
        simulation_result = $("#simulation-result");
        add_button = $("#add-button");
        delete_button = $("#delete-button");
        metabolite_combobox = $("#metabolite-combobox");

        add_button.hide();
        delete_button.hide();

        $( ".check" ).button();

        $.ajax({
            url: "{% url "cyanodesign.views.get_reactions" %}",
            context: document.body,
            async: false
        }).done(function(x) {
            x["enzymes"].forEach(function(value) {
                //$('<div>' + this + '</div>').appendTo('#content')
                //$('<li>' + value + '</li>').addClass("ui-widget-content").appendTo('#reactions');
                createMetabolites(value);
            });

            createExternalMetabolites(x["external"]);

            x["enzymes"].forEach(function(value) {
                var enz = createEnzyme(value);
                enz.toHTML().appendTo(cyano_design_enzymes);
                enzymes.push(enz);
                $("<option></option>").text(enz.name).appendTo(cyano_design_objective_select);
            });

            cyano_design_objective_select.val(x.objective[0].split(" ")[0])
        });

        $(".spinner").spinner();
        $(".checkbox").button();
        $("input[type=submit], button")
            .button()
            .click(function( event ) {
                event.preventDefault();
            });

        $("#design-submit").click(function(event) {
            $.ajax({
                url: "{% url "cyanodesign.views.simulate" %}",
                context: document.body,
                async: false,
                data: {
                    "enzymes": JSON.stringify(enzymes.map(function(value) { return value.toString(); })),
                    "constraints": JSON.stringify(enzymes.map(function(value) { return value.constraintsToString(); }).filter(function(value) { return value != ''; })),
                    "external": JSON.stringify(getExternalMetabolites().map(function(value) {
                        return value.name;
                    })),
                    "objective": JSON.stringify([cyano_design_objective_select.val() + " 1 1"])
                }
            }).done(function(x) {
                simulation_result.text("");
                $("<pre></pre>").text(x).appendTo(simulation_result);
            });
        });


        function updateTips(dialog, t) {
            dialog.find($(".validateTips"))
                    .text(t)
                    .addClass("ui-state-highlight");
            setTimeout(function () {
                tips.removeClass("ui-state-highlight", 1500);
            }, 500);
        }

        function checkLength(dialog, o, n, min, max) {
            if (o.val().length > max || o.val().length < min) {
                o.addClass("ui-state-error");
                updateTips(dialog, "Length of " + n + " must be between " +
                        min + " and " + max + ".");
                return false;
            } else {
                return true;
            }
        }

        function checkPredicate(dialog, o, predicate, error) {
            if (predicate(o.val)) {
                return true;
            } else {
                o.addClass("ui-state-error");
                updateTips(dialog, error);
                return false;
            }
        }

        function checkBool(dialog, bool, error) {
            if (bool) {
                return true;
            } else {
                o.addClass("ui-state-error");
                updateTips(dialog, error);
                return false;
            }
        }

        function checkRegexp(dialog, o, regexp, n) {
            if (!( regexp.test(o.val()) )) {
                o.addClass("ui-state-error");
                updateTips(dialog, n);
                return false;
            } else {
                return true;
            }
        }

        function updateEnzymeList() {
            $(cyano_design_enzymes).text("");
            $(cyano_design_objective_select).text("");

            enzymes.forEach(function(value) {
                value.toHTML().appendTo(cyano_design_enzymes);
                $("<option></option>").text(value.name).appendTo(cyano_design_objective_select);
            });
        }

        function showEnzymeDialog(enzyme, create_new) {
            if (create_new === undefined) {
                create_new = create_new_enzyme;
            }
            create_new_enzyme = create_new;

            dialog_enzyme.data("object", enzyme);
            dialog_enzyme.find("input.name").val(enzyme.name);
            dialog_enzyme.find("#reversible").prop("checked", enzyme.reversible);

            var substrates = dialog_enzyme.find("div#reaction-substrates");
            var products = dialog_enzyme.find("div#reaction-products");
            var constrained = dialog_enzyme.find("#constrained");
            var constrained_min = dialog_enzyme.find("#constrained-min");
            var constrained_max = dialog_enzyme.find("#constrained-max");

            $(substrates).text("");
            $(products).text("");
            enzyme.substrates.forEach(function(item) {
                $("<div></div>").text(item.name).addClass("cyano-metabolite").data("object", item).appendTo(substrates);
            });
            enzyme.products.forEach(function(item) {
                $("<div></div>").text(item.name).addClass("cyano-metabolite").data("object", item).appendTo(products);
            });

            constrained.prop("checked", enzyme.isConstrained());
            constrained_min.val(enzyme.constraints[0]);
            constrained_max.val(enzyme.constraints[1]);

            if (enzyme.isConstrained()) {
                constraints_div.show();
            } else {
                constraints_div.hide();
            }

            dialog_enzyme.dialog("open");
        }

        function showAddMetaboliteDialog(enzyme, isSubstrate) {
            dialog_metabolite_add.data("object", enzyme);
            dialog_metabolite_add.data("substrate", isSubstrate);
            dialog_metabolite_add.dialog("open");
        }

        dialog_enzyme.dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "OK": function () {
                    var name = $(this).find(".name");
                    var reversible = $(this).find("#reversible");
                    var constrained = dialog_enzyme.find("#constrained");
                    var constrained_min = dialog_enzyme.find("#constrained-min");
                    var constrained_max = dialog_enzyme.find("#constrained-max");

                    var bValid = true;
                    $(this).find("input").removeClass("ui-state-error");
                    bValid &= checkRegexp($(this), name, /^[a-zA-Z0-9_]+$/, "Name must only contain A-Z, a-z, 0-9 and _");
                    bValid &= checkLength($(this), name, "Name", 1, 50);

                    if (constrained.prop("checked")) {
                        bValid &= checkRegexp($(this), constrained_min, /^\-?[0-9]+$/, "Min constraint must be numeric");
                        bValid &= checkRegexp($(this), constrained_max, /^\-?[0-9]+$/, "Max constraint must be numeric");
                        if (bValid) {
                            bValid &= checkBool($(this), constrained_min <= constrained_max, "Min constraint > Max constraint");
                        }
                    }

                    if (bValid) {
                        var reaction = $(this).data("object");
                        reaction.name = name.val();
                        reaction.reversible = reversible.prop("checked");
                        if (constrained.prop("checked")) {
                            reaction.constraints[0] = constrained_min.val();
                            reaction.constraints[1] = constrained_max.val();
                        } else {
                            reaction.makeUnconstrained();
                        }

                        if (create_new_enzyme) {
                            enzymes.push(reaction);
                        }

                        $(this).dialog("close");
                    }
                },
                Cancel: function () {
                    $(this).dialog("close");
                }
            },
            close: function () {
                $(this).find("input").removeClass("ui-state-error");
                updateEnzymeList();
            }
        });

        dialog_metabolite_edit.dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "OK": function () {
                    var name = $(this).find(".name");
                    var external = $(this).find("#external");

                    var valid = checkLength($(this), name, "Name", 1, 50);
                    if (valid) {
                        var metabolite = $(this).data("object");
                        metabolite.updateName(name.val());
                        metabolite.external = external.prop("checked");
                        showEnzymeDialog(dialog_enzyme.data("object"));
                        $(this).dialog("close");
                    }
                },
                Cancel: function () {
                    $(this).dialog("close");
                }
            },
            close: function () {
                $(this).find("input").removeClass("ui-state-error");
            }
        });

        dialog_metabolite_add.dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "OK": function () {
                    var name = $(this).find($(".custom-combobox-input"));
                    var valid = checkLength($(this), name, "Name", 1, 50);
                    if (valid) {
                        var enzyme = $(this).data("object");
                        var isSubstrate = $(this).data("substrate");
                        // Check if metabolite already exists
                        var idx = indexOfMetabolite(name.val())
                        if (idx == -1) {
                            metabolites.push(new Metabolite(name.val(), false));
                            idx = metabolites.length - 1;
                        }
                        if (isSubstrate) {
                            enzyme.substrates.push(metabolites[idx]);
                            enzyme.stoichiometric_substrates.push(1);
                        } else {
                            enzyme.products.push(metabolites[idx]);
                            enzyme.stoichiometric_products.push(1);
                        }
                        showEnzymeDialog(dialog_enzyme.data("object"));
                        $(this).dialog("close");
                    }
                },
                Cancel: function () {
                    $(this).dialog("close");
                }
            },
            close: function () {
                $(this).find("input").removeClass("ui-state-error");
            }
        });
        $("#create-user")
                .button()
                .click(function () {
                    $("#dialog-form").dialog("open");
                });
        cyano_design_enzymes.on("click", "div.cyano-reaction", function(event) {
            showEnzymeDialog($(event.target).data("object"), false);
        });
        $("#add-enzyme-button").click(function (event) {
            showEnzymeDialog(new Enzyme(""), true);
        });
        $("#add-substrate-button").click(function (event) {
            showAddMetaboliteDialog(dialog_enzyme.data("object"), true);
        });
        $("#add-product-button").click(function (event) {
            showAddMetaboliteDialog(dialog_enzyme.data("object"), false);
        });
        dialog_enzyme.on("click", "div#reaction-substrates,div#reaction-products", function(event) {
            var item = $(event.target).data("object");
            dialog_metabolite_edit.find("input.name").val(item.name);
            dialog_metabolite_edit.find("#external").prop("checked", item.external);
            dialog_metabolite_edit.data("object", item);

            dialog_metabolite_edit.dialog("open");
        });
        dialog_enzyme.find("#constrained:checkbox").change(function() {
            if ($(this).is(":checked")) {
                constraints_div.show();
            } else {
                constraints_div.hide();
            }
        });

        $.widget("custom.combobox", {
            _create: function () {
                this.wrapper = $("<span>")
                        .addClass("custom-combobox")
                        .insertAfter(this.element);
                this.element.hide();
                this._createAutocomplete();
                this._createShowAllButton();
            },
            _createAutocomplete: function () {
                var selected = this.element.children(":selected"),
                        value = selected.val() ? selected.text() : "";
                this.input = $("<input>")
                        .appendTo(this.wrapper)
                        .val(value)
                        .attr("title", "")
                        .addClass("custom-combobox-input ui-widget ui-widget-content ui-state-default ui-corner-left")
                        .autocomplete({
                            delay: 0,
                            minLength: 0,
                            source: $.proxy(this, "_source")
                        })
                        .tooltip({
                            tooltipClass: "ui-state-highlight"
                        });
                        /*.data("ui-autocomplete")._renderItem = function(ul, item) {
                            return $("<li>").append("<i>" + item.value.name + "</i>").appendTo(ul);
                        };*/
                this._on(this.input, {
                    autocompleteselect: function (event, ui) {
                        ui.item.option.selected = true;
                        this._trigger("select", event, {
                            item: ui.item.option
                        });
                    },
                    autocompletechange: "_removeIfInvalid"
                });
            },
            _createShowAllButton: function () {
                var input = this.input,
                        wasOpen = false;
                $("<a>")
                        .attr("tabIndex", -1)
                        .attr("title", "Show All Items")
                        .tooltip()
                        .appendTo(this.wrapper)
                        .button({
                            icons: {
                                primary: "ui-icon-triangle-1-s"
                            },
                            text: false
                        })
                        .removeClass("ui-corner-all")
                        .addClass("custom-combobox-toggle ui-corner-right")
                        .mousedown(function () {
                            wasOpen = input.autocomplete("widget").is(":visible");
                        })
                        .click(function () {
                            input.focus();
// Close if already visible
                            if (wasOpen) {
                                return;
                            }
// Pass empty string as value to search for, displaying all results
                            input.autocomplete("search", "");
                        });
            },
            _source: function (request, response) {
                var matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                response(metabolites.map(function (value) {
                    var text = value.name;
                    if (!request.term || matcher.test(text))
                        return {
                            label: text,
                            value: text,
                            option: this
                        };
                }));
            },
            _removeIfInvalid: function (event, ui) {
// Selected an item, nothing to do
                var creation = dialog_metabolite_add.find(".creationState");
                creation.text("");
                if (ui.item) {
                    return;
                }
// Search for a match (case-insensitive)
                var value = this.input.val(),
                        valueLowerCase = value.toLowerCase(),
                        valid = false;
                this.element.children("option").each(function () {
                    if ($(this).text().toLowerCase() === valueLowerCase) {
                        this.selected = valid = true;
                        return false;
                    }
                });
// Found a match, nothing to do
                if (valid) {
                    return;
                }

                //this.input.attr("title", "New metabolite will be created").tooltip("open");

                var creation = dialog_metabolite_add.find(".creationState");
                creation.text("A new metabolite will be created");
            },
            _destroy: function () {
                this.wrapper.remove();
                this.element.show();
            }
        });
        metabolite_combobox.combobox();
        $("#toggle").click(function () {
            metabolite_combobox.toggle();
        });
    });
</script>

{% endblock %}

{% block extrastyles %}
#feedback { font-size: 1.4em; }
#selectable .ui-selecting { background: #FECA40; }
#selectable .ui-selected { background: #F39814; color: white; }
#selectable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
#selectable li { margin: 3px; padding: 0.4em; font-size: 1.4em; height: 18px; }

body { font-size: 62.5%; }
input.text { margin-bottom:12px; width:95%; padding: .4em; }
fieldset { padding:0; border:0; margin-top:25px; }
div#users-contain { width: 350px; margin: 20px 0; }
div#users-contain table { margin: 1em 0; border-collapse: collapse; width: 100%; }
div#users-contain table td, div#users-contain table th { border: 1px solid #eee; padding: .6em 10px; text-align: left; }
.ui-dialog .ui-state-error { padding: .3em; }
.validateTips { border: 1px solid transparent; padding: 0.3em; }

div.cyano-reaction:hover,div.cyano-metabolite:hover {
    background-color: #E3E3E3;
    cursor: pointer;
}

span.external-metabolite { color: blue }

.hoverable {
    cursor: pointer;
}

.custom-combobox {
    position: relative;
    display: inline-block;
}
.custom-combobox-toggle {
    position: absolute;
    top: 0;
    bottom: 0;
    margin-left: -1px;
    padding: 0;
    /* support: IE7 */
    *height: 1.7em;
    *top: 0.1em;
}
.custom-combobox-input {
    margin: 0;
    padding: 0.3em;
}
.ui-autocomplete {
    max-height: 100px;
    overflow-y: auto;
    /* prevent horizontal scrollbar */
    overflow-x: hidden;
}
{% endblock %}

{% block content %}

<img src="{% static "public/img/delete.png" %}" id="delete-button" alt="Delete"/>
<img src="{% static "public/img/add.png" %}" id="add-button" alt="Add"/>


<div id="dialog-reaction" title="Edit Reaction">
    <p class="validateTips">All form fields are required.</p>

    <form>
        <fieldset>
            <label for="name">Name</label>
            <input type="text" name="name" id="name" class="name text ui-widget-content ui-corner-all">
            <label for="substrates">Substrates</label>
            <div id="reaction-substrates"></div>
            <img src="{% static "public/img/add.png" %}" id="add-substrate-button" class="hoverable" alt="Add"/>
            <input type="text" class="text ui-widget-content ui-corner-all">
            <input type="text" class="text ui-widget-content ui-corner-all">
            <label for="products">Products</label>
            <div id="reaction-products"></div>
            <img src="{% static "public/img/add.png" %}" id="add-product-button" class="hoverable" alt="Add"/>
            <input type="text" class="text ui-widget-content ui-corner-all">
            <input type="text" class="text ui-widget-content ui-corner-all">
            <label for="reversible">Reversible</label>
            <input type="checkbox" name="reversible" id="reversible">
            <label for="constrained">Constrained</label>
            <input type="checkbox" name="constrained" id="constrained">
            <div id="constraints-min-max">
                <label for="constrained-min">Min</label>
                <input type="text" name="email" id="constrained-min" value="" class="spinner text ui-widget-content ui-corner-all">
                <label for="constrained-max">Max</label>
                <input type="text" name="constrained_max" id="constrained-max" class="spinner text ui-widget-content ui-corner-all">
            </div>
            </div>
        </fieldset>
    </form>
</div>

<div id="dialog-add-metabolite" title="Add Metabolite">
    <p class="validateTips">Select existing metabolite or create new one.</p>
    <form>
        <fieldset>
            <select id="metabolite-combobox">
            </select>
        </fieldset>
    </form>
    <p class="creationState"></p>
</div>

<div id="dialog-edit-metabolite" title="Edit Metabolite">
    <p class="validateTips">All form fields are required.</p>

    <form>
        <fieldset>
            <label for="name">Name</label>
            <input type="text" name="name" id="name" class="name text ui-widget-content ui-corner-all">
            <label for="external">External</label>
            <input type="checkbox" name="external" id="external">
        </fieldset>
    </form>
</div>

<div class="cyano-design-enzymes">
</div>
<img src="{% static "public/img/add.png" %}" id="add-enzyme-button" class="hoverable" alt="Add"/>

<div class="cyano-design-objective">
Design objective: <select id="cyano-design-objective-select"></select>
</div>

<div class="cyano-design-submit">
<input type="submit" id="design-submit" value="Simulate"></div>

<div id="products">
    <h1 class="ui-widget-header">Results</h1>

    <div id="simulation-result">

    </div>
</div>

{% endblock %}
