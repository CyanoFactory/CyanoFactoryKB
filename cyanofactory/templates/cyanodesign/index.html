{% extends "cyano/base.html" %}

{% comment %}
Cyanodesign index page

Copyright (c) 2013 Gabriel Kind <gkind@hs-mittweida.de>
Hochschule Mittweida, University of Applied Sciences

Released under the MIT license
{% endcomment %}

{% load static %}
{% load templatetags %}
{% load filters %}

{% block head_title %}{{ block.super }} :: Cyanodesign{% endblock %}
{% block page_title %}Cyanodesign{% endblock %}

{% block head %}
{{ block.super }}

<script type="text/javascript">
    var enzymes = [];
    var metabolites = {};
    var dialog_metabolite;
    var dialog_enzyme;
    var cyano_design_objective_select;
    var cyano_design_enzymes;
    var constraints_div;

    function Enzyme(name) {
        this.name = name;
        this.reversible = false;
        this.substrates = [];
        this.products = [];
        this.stoichiometric_substrates = [];
        this.stoichiometric_products = [];
        this.constraints = [];

        this.isConstrained = function() {
            return this.constraints[1] !== null;
        }

        this.makeUnconstrained = function() {
            this.constraints[0] = this.reversible ? null : 0;
            this.constraints[1] = null;
        }

        this.toHTML = function() {
            var reac = function(substrates) {
                return function(value, index) {
                    var elem = substrates[index] + " ";
                    if (value.external) {
                        return elem + $("<span></span>").addClass("external-metabolite").text(value.name)[0].outerHTML;
                    }
                    return elem + value.name;
                }
            }

            var element = $("<div>").addClass("cyano-reaction").data("object", this);
            element.append(this.name + ": ");
            element.append(this.substrates.map(reac(this.stoichiometric_substrates)).join(" + "));
            element.append(this.reversible ? " <-> " : " -> ");
            element.append(this.products.map(reac(this.stoichiometric_products)).join(" + "));

            if (this.isConstrained()) {
                element.append(" [" + this.constraints[0] + ", " + this.constraints[1] + "]");
            } else {
                element.append(" <i>unconstrained</i>");
            }
            element.append("</div>");

            return element;
        }

        this.toString = function() {
             var reac = function(substrates) {
                return function(value, index) {
                    var elem = substrates[index] + " ";
                    return elem + value.name;
                }
            }

            var element = "";
            element = element.concat(this.name + " : ");
            element = element.concat(this.substrates.map(reac(this.stoichiometric_substrates)).join(" + "));
            element = element.concat(this.reversible ? " <-> " : " -> ");
            element = element.concat(this.products.map(reac(this.stoichiometric_products)).join(" + "));
            return element;
        }

        this.constraintsToString = function() {
            if (!this.isConstrained()) {
                return "";
            } else {
                return this.name + " [" + this.constraints.join(", ") + "]";
            }
        }
    }

    function Metabolite(name, external) {
        this.external = external;
        this.name = name;

        this.updateName = function(new_name) {
            if (typeof metabolites[new_name] === 'undefined' ||
                    metabolites[new_name] == this) {
                delete metabolites[this.name];
                this.name = new_name;
                metabolites[this.name] = this;
                return true;
            }
            return false;
        }
    }

    function createMetabolites(reaction) {
        var metabolite_fn = function(value) {
            metabolites[value] = new Metabolite(value, false);
        }

        reaction["substrates"].forEach(metabolite_fn);
        reaction["products"].forEach(metabolite_fn);
    }

    function createExternalMetabolites(external) {
        var metabolite_fn = function(value) {
            metabolites[value] = new Metabolite(value, true);
        }
        external.forEach(metabolite_fn);
    }

    function getExternalMetabolites() {
        var ext_metas = []
        for (var m in metabolites) {
            if (metabolites[m].external) {
                ext_metas.push(m);
            }
        }
        return ext_metas;
    }

    function createEnzyme(reaction) {
        var enzyme = new Enzyme(reaction["name"]);

        enzyme.products = reaction.products.map(
            function(value) {
                return metabolites[value];
            }
        );

        enzyme.substrates = reaction.substrates.map(
            function(value) {
                return metabolites[value];
            }
        );

        enzyme.stoichiometric_substrates = reaction.stoichiometric[0];
        enzyme.stoichiometric_products = reaction.stoichiometric[1];
        enzyme.reversible = reaction.reversible;
        enzyme.constraints = reaction.constraints;

        return enzyme;
    }

    $(function () {
        dialog_metabolite = $("#dialog-metabolite");
        dialog_enzyme = $("#dialog-reaction");
        cyano_design_objective_select = $("#cyano-design-objective-select");
        cyano_design_enzymes = $(".cyano-design-enzymes");
        constraints_div = $("#constraints-min-max");

        $( ".check" ).button();

        $.ajax({
            url: "{% url "cyanodesign.views.get_reactions" %}",
            context: document.body,
            async: false
        }).done(function(x) {
            x["enzymes"].forEach(function(value) {
                //$('<div>' + this + '</div>').appendTo('#content')
                //$('<li>' + value + '</li>').addClass("ui-widget-content").appendTo('#reactions');
                createMetabolites(value);
            });

            createExternalMetabolites(x["external"]);

            x["enzymes"].forEach(function(value) {
                var enz = createEnzyme(value);
                enz.toHTML().appendTo(cyano_design_enzymes);
                enzymes.push(enz);
                $("<option></option>").text(enz.name).appendTo(cyano_design_objective_select);
            });
        });

        // via https://stackoverflow.com/questions/4396042/
        $("#selectable").bind("mousedown", function(e) {
            e.metaKey = true;
        }).selectable();

        $( "#check1" ).position({
            my: "right",
            at: "right",
            of: "#item1"
        });

        $(".spinner").spinner();
        $(".checkbox").button();
        $("input[type=submit], button")
            .button()
            .click(function( event ) {
                event.preventDefault();
            });
          /*"name": enzyme.name,
            "stoichiometric": enzyme.stoic,
            "substrates": enzyme.substrates,
            "products": enzyme.products,
            "reversible": enzyme.reversible,
            "constraints": constr*/
        /*
            data = design["enzymes"]
    constr = design["constraints"]
    ext = design["external"]
    objective = design["objective"]
         */
        $("#design-submit").click(function(event) {
            $.ajax({
                url: "{% url "cyanodesign.views.simulate" %}",
                context: document.body,
                async: false,
                data: {
                    "enzymes": JSON.stringify(enzymes.map(function(value) { return value.toString(); })),
                    "constraints": JSON.stringify(enzymes.map(function(value) { return value.constraintsToString(); }).filter(function(value) { return value != ''; })),
                    "external": JSON.stringify(getExternalMetabolites()),
                    "objective": JSON.stringify([cyano_design_objective_select.val() + " 1"])
                }
            }).done(function(x) {
                alert(x);
            });
        });

        /* Dialog */
        var name = $("#name"),
                email = $("#email"),
                password = $("#password"),
                allFields = $([]).add(name).add(email).add(password),
                tips = $(".validateTips");

        function updateTips(dialog, t) {
            dialog.find($(".validateTips"))
                    .text(t)
                    .addClass("ui-state-highlight");
            setTimeout(function () {
                tips.removeClass("ui-state-highlight", 1500);
            }, 500);
        }

        function checkLength(dialog, o, n, min, max) {
            if (o.val().length > max || o.val().length < min) {
                o.addClass("ui-state-error");
                updateTips(dialog, "Length of " + n + " must be between " +
                        min + " and " + max + ".");
                return false;
            } else {
                return true;
            }
        }

        function checkPredicate(dialog, o, predicate, error) {
            if (predicate(o.val)) {
                return true;
            } else {
                updateTips(dialog, error);
                return false;
            }
        }

        function checkRegexp(dialog, o, regexp, n) {
            if (!( regexp.test(o.val()) )) {
                o.addClass("ui-state-error");
                updateTips(dialog, n);
                return false;
            } else {
                return true;
            }
        }

        function updateEnzymeList() {
            $(cyano_design_enzymes).text("");
            $(cyano_design_objective_select).text("");

            enzymes.forEach(function(value) {
                value.toHTML().appendTo(cyano_design_enzymes);
                $("<option></option>").text(value.name).appendTo(cyano_design_objective_select);
            });
        }

        function showEnzymeDialog(enzyme) {
            dialog_enzyme.data("object", enzyme);
            dialog_enzyme.find("input.name").val(enzyme.name);
            dialog_enzyme.find("#reversible").prop("checked", enzyme.reversible);

            var substrates = dialog_enzyme.find("div#reaction-substrates");
            var products = dialog_enzyme.find("div#reaction-products");
            var constrained = dialog_enzyme.find("#constrained");
            var constrained_min = dialog_enzyme.find("#constrained-min");
            var constrained_max = dialog_enzyme.find("#constrained-max");

            $(substrates).text("");
            $(products).text("");
            enzyme.substrates.forEach(function(item) {
                $("<div></div>").text(item.name).addClass("cyano-metabolite").data("object", item).appendTo(substrates);
            });
            enzyme.products.forEach(function(item) {
                $("<div></div>").text(item.name).addClass("cyano-metabolite").data("object", item).appendTo(products);
            });

            constrained.prop("checked", enzyme.isConstrained());
            constrained_min.val(enzyme.constraints[0]);
            constrained_max.val(enzyme.constraints[1]);

            if (enzyme.isConstrained()) {
                constraints_div.show();
            } else {
                constraints_div.hide();
            }

            dialog_enzyme.dialog("open");
        }

        dialog_enzyme.dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "OK": function () {
                    var name = $(this).find(".name");
                    var reversible = $(this).find("#reversible");
                    var constrained = dialog_enzyme.find("#constrained");
                    var constrained_min = dialog_enzyme.find("#constrained-min");
                    var constrained_max = dialog_enzyme.find("#constrained-max");

                    var bValid = true;
                    allFields.removeClass("ui-state-error");
                    bValid &= checkRegexp($(this), name, /^[a-zA-Z0-9_]+$/, "Name must only contain A-Z, a-z, 0-9 and _");
                    bValid &= checkLength($(this), name, "Name", 1, 50);

                    // TODO: Test for numeric

                    if (bValid) {
                        var reaction = $(this).data("object");
                        reaction.name = name.val();
                        reaction.reversible = reversible.prop("checked");
                        if (constrained.prop("checked")) {
                            reaction.constraints[0] = constrained_min.val();
                            reaction.constraints[1] = constrained_max.val();
                        } else {
                            reaction.makeUnconstrained();
                        }
                        $(this).dialog("close");
                    }
                },
                Cancel: function () {
                    $(this).dialog("close");
                }
            },
            close: function () {
                allFields.val("").removeClass("ui-state-error");
                updateEnzymeList();
            }
        });
        dialog_metabolite.dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "OK": function () {
                    var name = $(this).find(".name");
                    var external = $(this).find("#external");

                    var valid = checkLength($(this), name, "Name", 1, 50);
                    if (valid) {
                        var metabolite = $(this).data("object");
                        metabolite.updateName(name.val());
                        metabolite.external = external.prop("checked");
                        showEnzymeDialog(dialog_enzyme.data("object"));
                        $(this).dialog("close");
                    }
                },
                Cancel: function () {
                    $(this).dialog("close");
                }
            },
            close: function () {
                allFields.val("").removeClass("ui-state-error");
            }
        });
        $("#create-user")
                .button()
                .click(function () {
                    $("#dialog-form").dialog("open");
                });
        cyano_design_enzymes.on("click", "div.cyano-reaction", function(event) {
            showEnzymeDialog($(event.target).data("object"));
        });
        dialog_enzyme.on("click", "div#reaction-substrates,div#reaction-products", function(event) {
            var item = $(event.target).data("object");
            dialog_metabolite.find("input.name").val(item.name);
            dialog_metabolite.find("#external").prop("checked", item.external);
            dialog_metabolite.data("object", item);

            dialog_metabolite.dialog("open");
        });
        dialog_enzyme.find("#constrained:checkbox").change(function() {
            if ($(this).is(":checked")) {
                constraints_div.show();
            } else {
                constraints_div.hide();
            }
        });
    });
</script>

{% endblock %}

{% block extrastyles %}
#feedback { font-size: 1.4em; }
#selectable .ui-selecting { background: #FECA40; }
#selectable .ui-selected { background: #F39814; color: white; }
#selectable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
#selectable li { margin: 3px; padding: 0.4em; font-size: 1.4em; height: 18px; }

body { font-size: 62.5%; }
input.text { margin-bottom:12px; width:95%; padding: .4em; }
fieldset { padding:0; border:0; margin-top:25px; }
div#users-contain { width: 350px; margin: 20px 0; }
div#users-contain table { margin: 1em 0; border-collapse: collapse; width: 100%; }
div#users-contain table td, div#users-contain table th { border: 1px solid #eee; padding: .6em 10px; text-align: left; }
.ui-dialog .ui-state-error { padding: .3em; }
.validateTips { border: 1px solid transparent; padding: 0.3em; }

div.cyano-reaction:hover,div.cyano-metabolite:hover {
    background-color: #E3E3E3;
    cursor: pointer;
}

span.external-metabolite { color: blue }

{% endblock %}

{% block content %}

<div id="dialog-reaction" title="Create new user">
    <p class="validateTips">All form fields are required.</p>

    <form>
        <fieldset>
            <label for="name">Name</label>
            <input type="text" name="name" id="name" class="name text ui-widget-content ui-corner-all">
            <label for="substrates">Substrates</label>
            <div id="reaction-substrates">

            </div>
            <input type="text" class="text ui-widget-content ui-corner-all">
            <input type="text" class="text ui-widget-content ui-corner-all">
            <label for="products">Products</label>
            <div id="reaction-products"></div>
            <input type="text" class="text ui-widget-content ui-corner-all">
            <input type="text" class="text ui-widget-content ui-corner-all">
            <label for="reversible">Reversible</label>
            <input type="checkbox" name="reversible" id="reversible">
            <label for="constrained">Constrained</label>
            <input type="checkbox" name="constrained" id="constrained">
            <div id="constraints-min-max">
                <label for="constrained-min">Min</label>
                <input type="text" name="email" id="constrained-min" value="" class="spinner text ui-widget-content ui-corner-all">
                <label for="constrained-max">Max</label>
                <input type="text" name="constrained_max" id="constrained-max" class="spinner text ui-widget-content ui-corner-all">
            </div>
            </div>
        </fieldset>
    </form>
</div>


<div id="dialog-metabolite" title="Metabolite">
    <p class="validateTips">All form fields are required.</p>

    <form>
        <fieldset>
            <label for="name">Name</label>
            <input type="text" name="name" id="name" class="name text ui-widget-content ui-corner-all">
            <label for="external">External</label>
            <input type="checkbox" name="external" id="external">
        </fieldset>
    </form>
</div>

<div class="cyano-design-enzymes">
</div>

<div class="cyano-design-objective">
Design objective: <select id="cyano-design-objective-select">
</select>
</div>

<div class="cyano-design-submit">
<input type="submit" id="design-submit" value="Simulate">
<button id="create-user">Create new user</button>
</div>

{% endblock %}
