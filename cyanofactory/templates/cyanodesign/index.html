{% extends "cyano/base.html" %}

{% comment %}
Cyanodesign index page

Copyright (c) 2013 Gabriel Kind <gkind@hs-mittweida.de>
Hochschule Mittweida, University of Applied Sciences

Released under the MIT license
{% endcomment %}

{% load static %}
{% load staticfiles %}
{% load templatetags %}
{% load filters %}

{% block head_title %}{{ block.super }} :: Cyanodesign{% endblock %}
{% block page_title %}Cyanodesign{% endblock %}

{% block head %}
{{ block.super }}
<script src="{% get_static_prefix %}stringdb/d3/d3.v3.min.js"></script>
<script src="{% get_static_prefix %}cyano/js/viz.js"></script>
<script type="text/javascript">
    var enzymes = [];
    var metabolites = [];
    var design_objective;
    var dialog_metabolite_edit;
    var dialog_enzyme;
    var dialog_metabolite_add;
    var dialog_progressbar;
    var cyano_design_objective_select;
    var cyano_design_enzymes;
    var constraints_div;
    var simulation_result;
    var add_button;
    var delete_button;
    var create_new_enzyme = false;
    var metabolite_combobox;
    var svg;

    function Enzyme(name) {
        this.name = name;
        this.reversible = false;
        this.substrates = [];
        this.products = [];
        this.stoichiometric_substrates = [];
        this.stoichiometric_products = [];
        this.constraints = [0, null];
        this.enabled = true;

        this.isConstrained = function() {
            return this.constraints[1] !== null;
        }

        this.makeUnconstrained = function() {
            this.constraints[0] = this.reversible ? null : 0;
            this.constraints[1] = null;
        }

        this.toHTML = function() {
            var reac = function(substrates) {
                return function(value, index) {
                    var elem = substrates[index] + " ";
                    if (value.external) {
                        return elem + $("<span></span>").addClass("external-metabolite").text(value.name)[0].outerHTML;
                    }
                    return elem + value.name;
                }
            }

            var outer = $("<div></div");
            var checkbox = $("<input>")
                    .addClass("reaction-checkbox")
                    .attr("type", "checkbox")
                    .attr("checked", this.enabled)
                    .data("object", this)
                    .appendTo(outer);
            var element = $("<div>").addClass("cyano-reaction").data("object", this);
            if (!this.enabled) {
                element.addClass("cyano-reaction-disabled");
            }
            element.append(this.name + ": ");
            element.append(this.substrates.map(reac(this.stoichiometric_substrates)).join(" + "));
            element.append(this.reversible ? " <-> " : " -> ");
            element.append(this.products.map(reac(this.stoichiometric_products)).join(" + "));

            if (this.isConstrained()) {
                element.append(" [" + this.constraints[0] + ", " + this.constraints[1] + "]");
            } else {
                element.append(" <i>unconstrained</i>");
            }
            element.append("</div>");
            element.appendTo(outer);

            return outer;
        }

        this.toString = function() {
             var reac = function(substrates) {
                return function(value, index) {
                    var elem = substrates[index] + " ";
                    return elem + value.name;
                }
            }

            var element = "";
            element = element.concat(this.name + " : ");
            element = element.concat(this.substrates.map(reac(this.stoichiometric_substrates)).join(" + "));
            element = element.concat(this.reversible ? " <-> " : " -> ");
            element = element.concat(this.products.map(reac(this.stoichiometric_products)).join(" + "));
            return element;
        }

        this.constraintsToString = function() {
            if (!this.isConstrained()) {
                return "";
            } else {
                return this.name + " [" + this.constraints.join(", ") + "]";
            }
        }
    }

    function Metabolite(name, external) {
        this.external = external;
        this.name = name;

        this.updateName = function(new_name) {
            var idx = indexOfMetabolite(new_name);

            if (idx === -1 ||
                metabolites[idx] == this) {
                this.name = new_name;
                metabolites[idx] = this;
                return true;
            }
            return false;
        }
    }

    function indexOfMetabolite(value) {
        for (var index = 0; index < metabolites.length; ++index) {
            if (metabolites[index].name == value) {
                return index;
            }
        }
        return -1;
    }

    function createMetabolites(reaction) {
        var metabolite_fn = function(value) {
            var idx = indexOfMetabolite(value);
            if (idx == -1) {
                metabolites.push(new Metabolite(value, false));
            }
        }

        reaction["substrates"].forEach(metabolite_fn);
        reaction["products"].forEach(metabolite_fn);
    }

    function createExternalMetabolites(external) {
        var metabolite_fn = function(value) {
           var idx = indexOfMetabolite(value);
            if (idx == -1) {
                metabolites.push(new Metabolite(value, true));
            } else {
                metabolites[idx].external = true;
            }
        }
        external.forEach(metabolite_fn);
    }

    function getExternalMetabolites() {
        return metabolites.filter(function(value) {
            return value.external;
        });
    }

    function createEnzyme(reaction) {
        var enzyme = new Enzyme(reaction["name"]);

        enzyme.products = reaction.products.map(
            function(value) {
                return metabolites[indexOfMetabolite(value)];
            }
        );

        enzyme.substrates = reaction.substrates.map(
            function(value) {
                return metabolites[indexOfMetabolite(value)];
            }
        );

        enzyme.stoichiometric_substrates = reaction.stoichiometric[0];
        enzyme.stoichiometric_products = reaction.stoichiometric[1];
        enzyme.reversible = reaction.reversible;
        enzyme.constraints = reaction.constraints;

        return enzyme;
    }

    $(function () {
        dialog_metabolite_edit = $("#dialog-edit-metabolite");
        dialog_enzyme = $("#dialog-reaction");
        dialog_metabolite_add = $("#dialog-add-metabolite");
        dialog_progressbar = $("#dialog-progressbar");
        cyano_design_objective_select = $("#cyano-design-objective-select");
        cyano_design_enzymes = $(".cyano-design-enzymes");
        constraints_div = $("#constraints-min-max");
        simulation_result = $("#simulation-result");
        add_button = $("#add-button");
        delete_button = $("#delete-button");
        metabolite_combobox = $("#metabolite-combobox");

        add_button.hide();
        delete_button.hide();

        $( ".check" ).button();

        // Array Remove - By John Resig (MIT Licensed)
        Array.prototype.remove = function(from, to) {
          var rest = this.slice((to || from) + 1 || this.length);
          this.length = from < 0 ? this.length + from : from;
          return this.push.apply(this, rest);
        };

        $(".spinner").spinner();
        $(".checkbox").button();
        $(".validateTips").hide();
        $("input[type=submit], button")
            .button()
            .click(function( event ) {
                event.preventDefault();
            });

        $("#design-submit").click(function(event) {
            $.ajax({
                url: "{% url "cyanodesign.views.simulate" %}",
                context: document.body,
                beforeSend: function() {
                    dialog_progressbar.dialog("open");
                },
                data: {
                    "enzymes": JSON.stringify(
                            enzymes.
                            filter(function(value) { return value.enabled; }).
                            map(function(value) { return value.toString(); })
                    ),
                    "constraints": JSON.stringify(enzymes.map(function(value) { return value.constraintsToString(); }).filter(function(value) { return value != ''; })),
                    "external": JSON.stringify(getExternalMetabolites().map(function(value) {
                        return value.name;
                    })),
                    "objective": JSON.stringify([cyano_design_objective_select.val() + " 1 1"])
                }
            }).done(function(x) {
                simulation_result.text("");
                $("<pre></pre>").text(x).appendTo(simulation_result);
                dialog_progressbar.dialog("close");
            });
        });


        function updateTips(dialog, t) {
            dialog.find($(".validateTips").show());
            dialog.find($(".validateTips"))
                    .text(t)
                    .addClass("ui-state-highlight");
            setTimeout(function () {
                //t.removeClass("ui-state-highlight", 1500);
            }, 500);
        }

        function checkLength(dialog, o, n, min, max) {
            if (o.val().length > max || o.val().length < min) {
                o.addClass("ui-state-error");
                updateTips(dialog, "Length of " + n + " must be between " +
                        min + " and " + max + ".");
                return false;
            } else {
                return true;
            }
        }

        function checkPredicate(dialog, o, predicate, error) {
            if (predicate(o.val)) {
                return true;
            } else {
                o.addClass("ui-state-error");
                updateTips(dialog, error);
                return false;
            }
        }

        function checkBool(dialog, o, bool, error) {
            if (bool) {
                return true;
            } else {
                o.addClass("ui-state-error");
                updateTips(dialog, error);
                return false;
            }
        }

        function checkRegexp(dialog, o, regexp, n) {
            if (!( regexp.test(o.val()) )) {
                o.addClass("ui-state-error");
                updateTips(dialog, n);
                return false;
            } else {
                return true;
            }
        }

        function updateEnzymeList() {
            $(cyano_design_enzymes).text("");
            $(cyano_design_objective_select).text("");

            for (var i = 0; i < enzymes.length; ++i) {
                var enzyme = enzymes[i];
                if (typeof enzyme.backup != 'undefined') {
                    enzymes[i] = enzyme.backup;
                    enzyme = enzymes[i];
                }
                enzyme.toHTML().appendTo(cyano_design_enzymes);
                $("<option></option>").text(enzyme.name).appendTo(cyano_design_objective_select);
            }
        }

        function showEnzymeDialog(enzyme, create_new) {
            if (typeof create_new == 'undefined') {
                create_new = create_new_enzyme;
            }
            create_new_enzyme = create_new;

            if (typeof enzyme == 'undefined') {
                enzyme = dialog_enzyme.data("object");
            } else {
                enzyme.backup = jQuery.extend(true, {}, enzyme);
            }

            dialog_enzyme.data("object", enzyme);
            dialog_enzyme.data("substrates_del", []);
            dialog_enzyme.data("products_del", []);
            dialog_enzyme.find("input.name").val(enzyme.name);
            dialog_enzyme.find("#reversible").prop("checked", enzyme.reversible);

            var substrates = dialog_enzyme.find("div#reaction-substrates");
            var products = dialog_enzyme.find("div#reaction-products");
            var constrained = dialog_enzyme.find("#constrained");
            var constrained_min = dialog_enzyme.find("#constrained-min");
            var constrained_max = dialog_enzyme.find("#constrained-max");

            $(substrates).text("");
            $(products).text("");

            var each_func = function(target) {
                return function(item, value) {
                    var element = $("<div></div>");
                    delete_button.clone().show().addClass("hoverable").data("count", value).appendTo(element);
                    var spinner = $("<input>").attr("type", "text").appendTo(element);
                    spinner.spinner();
                    $("<div></div>").text(item.name).addClass("cyano-metabolite").data("object", item).appendTo(element);
                    element.appendTo(target);
                }
            }

            enzyme.substrates.forEach(each_func(substrates));
            enzyme.products.forEach(each_func(products));

            substrates.find("input.ui-spinner-input").each(function(index, value) {
                $(value).val(enzyme.stoichiometric_substrates[index]);
            });
            products.find("input.ui-spinner-input").each(function(index, value) {
                $(value).val(enzyme.stoichiometric_products[index]);
            });

            constrained.prop("checked", enzyme.isConstrained());
            constrained_min.val(enzyme.constraints[0]);
            constrained_max.val(enzyme.constraints[1]);

            if (enzyme.isConstrained()) {
                constraints_div.show();
            } else {
                constraints_div.hide();
            }

            dialog_enzyme.dialog("open");
        }

        function showAddMetaboliteDialog(enzyme, isSubstrate) {
            dialog_metabolite_add.data("object", enzyme);
            dialog_metabolite_add.data("substrate", isSubstrate);
            dialog_metabolite_add.dialog("open");
        }

        dialog_enzyme.dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "OK": function () {
                    var name = $(this).find(".name");
                    var reversible = $(this).find("#reversible");
                    var constrained = dialog_enzyme.find("#constrained");
                    var constrained_min = dialog_enzyme.find("#constrained-min");
                    var constrained_max = dialog_enzyme.find("#constrained-max");
                    var substrates = dialog_enzyme.find("div#reaction-substrates");
                    var products = dialog_enzyme.find("div#reaction-products");

                    var bValid = true;

                    var numeric = /^\-?[0-9]+$/;

                    var self = $(this);

                    self.find("input").removeClass("ui-state-error");

                    for (var i = 0; i < enzymes.length; ++i) {
                        var enz = enzymes[i];
                        if (name.val() == enz.name) {
                             bValid &= checkBool($(this), name, enz == dialog_enzyme.data("object"), "Name already in use");
                        }
                    }

                    bValid &= checkRegexp($(this), name, /^[a-zA-Z0-9_]+$/, "Name must only contain A-Z, a-z, 0-9 and _");
                    bValid &= checkLength($(this), name, "Name", 1, 50);

                    if (constrained.prop("checked")) {
                        bValid &= checkRegexp($(this), constrained_min, numeric, "Min constraint must be numeric");
                        bValid &= checkRegexp($(this), constrained_max, numeric, "Max constraint must be numeric");
                        if (bValid) {
                            bValid &= checkBool($(this), constrained_min, constrained_min.val() <= constrained_max.val(), "Min constraint > Max constraint");
                        }
                    }

                    substrates.find("input.ui-spinner-input").each(function(index, value) {
                        bValid &= checkRegexp(self, $(value), numeric, "Stoichiometry must be numeric");
                    });
                    products.find("input.ui-spinner-input").each(function(index, value) {
                        bValid &= checkRegexp(self, $(value), numeric, "Stoichiometry must be numeric");
                    });

                    if (bValid) {
                        var reaction = $(this).data("object");
                        reaction.backup = undefined;
                        reaction.name = name.val();
                        reaction.reversible = reversible.prop("checked");
                        if (constrained.prop("checked")) {
                            reaction.constraints[0] = constrained_min.val();
                            reaction.constraints[1] = constrained_max.val();
                        } else {
                            reaction.makeUnconstrained();
                        }

                        substrates.find("input.ui-spinner-input").each(function(index, value) {
                            reaction.stoichiometric_substrates[index] = $(value).val();
                        });
                        products.find("input.ui-spinner-input").each(function(index, value) {
                            reaction.stoichiometric_products[index] = $(value).val();
                        });

                        if (create_new_enzyme) {
                            enzymes.push(reaction);
                        }

                        $(this).dialog("close");
                    }
                },
                Cancel: function () {
                    $(this).dialog("close");
                }
            },
            close: function () {
                $(this).find("input").removeClass("ui-state-error");
                updateEnzymeList();
                $(".validateTips").hide();
            }
        });

        dialog_metabolite_edit.dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "OK": function () {
                    var name = $(this).find(".name");
                    var external = $(this).find("#external");

                    var valid = checkLength($(this), name, "Name", 1, 50);
                    if (valid) {
                        var metabolite = $(this).data("object");
                        metabolite.updateName(name.val());
                        metabolite.external = external.prop("checked");
                        showEnzymeDialog(dialog_enzyme.data("object"));
                        $(this).dialog("close");
                    }
                },
                Cancel: function () {
                    $(this).dialog("close");
                }
            },
            close: function () {
                $(this).find("input").removeClass("ui-state-error");
                $(".validateTips").hide();
            }
        });

        dialog_metabolite_add.dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "OK": function () {
                    var name = $(this).find($(".custom-combobox-input"));
                    var valid = checkLength($(this), name, "Name", 1, 50);

                    if (valid) {
                        var enzyme = $(this).data("object");
                        var isSubstrate = $(this).data("substrate");
                        // Check if metabolite already exists
                        var idx = indexOfMetabolite(name.val())
                        if (idx == -1) {
                            metabolites.push(new Metabolite(name.val(), false));
                            idx = metabolites.length - 1;
                        }
                        if (isSubstrate) {
                            enzyme.substrates.push(metabolites[idx]);
                            enzyme.stoichiometric_substrates.push(1);
                        } else {
                            enzyme.products.push(metabolites[idx]);
                            enzyme.stoichiometric_products.push(1);
                        }
                        showEnzymeDialog(undefined);
                        $(this).dialog("close");
                    }
                },
                Cancel: function () {
                    $(this).dialog("close");
                }
            },
            close: function () {
                $(this).find("input").removeClass("ui-state-error");
                $(".validateTips").hide();
                $(this).find(".creationState").text("");
            }
        });
        $("#create-user")
                .button()
                .click(function () {
                    $("#dialog-form").dialog("open");
                });
        cyano_design_enzymes.on("click", "div.cyano-reaction", function(event) {
            showEnzymeDialog($(event.target).data("object"), false);
        });
        $("#add-enzyme-button").click(function (event) {
            showEnzymeDialog(new Enzyme(""), true);
        });
        $("#add-substrate-button").click(function (event) {
            showAddMetaboliteDialog(dialog_enzyme.data("object"), true);
        });
        $("#add-product-button").click(function (event) {
            showAddMetaboliteDialog(dialog_enzyme.data("object"), false);
        });
        dialog_enzyme.on("click", "div.cyano-metabolite", function(event) {
            var item = $(event.target).data("object");
            dialog_metabolite_edit.find("input.name").val(item.name);
            dialog_metabolite_edit.find("#external").prop("checked", item.external);
            dialog_metabolite_edit.data("object", item);

            dialog_metabolite_edit.dialog("open");
        });
        dialog_enzyme.find("#constrained:checkbox").change(function() {
            if ($(this).is(":checked")) {
                constraints_div.show();
            } else {
                constraints_div.hide();
            }
        });
        cyano_design_enzymes.on("change", ".reaction-checkbox:checkbox", function(event) {
            var target = $(event.target);
            var obj = target.data("object");
            obj.enabled = $(this).is(":checked");
            var reac = target.next();
            if (obj.enabled) {
                reac.removeClass("cyano-reaction-disabled");
            } else {
                reac.addClass("cyano-reaction-disabled");
            }
        });
        dialog_enzyme.find("#reaction-substrates").on("click", ".delete-button", function(event) {
            var target = $(event.target);
            var index = target.data("count");
            dialog_enzyme.data("substrates_del").push(index);
            target.parent().remove();
        })
dialog_enzyme.find("#reaction-products").on("click", ".delete-button", function(event) {
            var target = $(event.target);
            var index = target.data("count");
            dialog_enzyme.data("products_del").push(index);
            target.parent().remove();
        })
        dialog_progressbar.dialog({
            autoOpen: false,
            height: 'auto',
            width: 350,
            modal: true,
            closeOnEscape: false,
            dialogClass: "no-close"
        });
        var pbar = dialog_progressbar.find("#progressbar");
        pbar.progressbar();
        pbar.progressbar( "option", "value", false );

        $.widget("custom.combobox", {
            _create: function () {
                this.wrapper = $("<span>")
                        .addClass("custom-combobox")
                        .insertAfter(this.element);
                this.element.hide();
                this._createAutocomplete();
                this._createShowAllButton();
            },
            _createAutocomplete: function () {
                var selected = this.element.children(":selected"),
                        value = selected.val() ? selected.text() : "";
                this.input = $("<input>")
                        .appendTo(this.wrapper)
                        .val(value)
                        .attr("title", "")
                        .addClass("custom-combobox-input ui-widget ui-widget-content ui-state-default ui-corner-left")
                        .autocomplete({
                            delay: 0,
                            minLength: 0,
                            source: $.proxy(this, "_source")
                        })
                        .tooltip({
                            tooltipClass: "ui-state-highlight"
                        });
                /*this.input.data("ui-autocomplete")._renderItem = function(ul, item) {
                    $("<li>").append("<i>" + item.label + "</i>").appendTo(ul);
                    return ul;
                };*/
                this._on(this.input, {
                    autocompleteselect: function (event, ui) {
                        ui.item.option.selected = true;
                        this._trigger("select", event, {
                            item: ui.item.option
                        });
                    },
                    autocompletechange: "_removeIfInvalid"
                });
            },
            _createShowAllButton: function () {
                var input = this.input,
                        wasOpen = false;
                $("<a>")
                        .attr("tabIndex", -1)
                        .attr("title", "Show All Items")
                        .tooltip()
                        .appendTo(this.wrapper)
                        .button({
                            icons: {
                                primary: "ui-icon-triangle-1-s"
                            },
                            text: false
                        })
                        .removeClass("ui-corner-all")
                        .addClass("custom-combobox-toggle ui-corner-right")
                        .mousedown(function () {
                            wasOpen = input.autocomplete("widget").is(":visible");
                        })
                        .click(function () {
                            input.focus();
// Close if already visible
                            if (wasOpen) {
                                return;
                            }
// Pass empty string as value to search for, displaying all results
                            input.autocomplete("search", "");
                        });
            },
            _source: function (request, response) {
                var matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                response(metabolites.filter(function (value) {
                    var text = value.name;
                    return true;
                    return !request.term || matcher.test(text);
                }).map(function(value) {
                    return {
                        label: value.name,
                        value: value.name,
                        option: this
                    };
                }));
            },
            _removeIfInvalid: function (event, ui) {
// Selected an item, nothing to do
                var creation = dialog_metabolite_add.find(".creationState");
                creation.text("");
                if (ui.item) {
                    return;
                }
// Search for a match (case-insensitive)
                var value = this.input.val(),
                        valueLowerCase = value.toLowerCase(),
                        valid = false;
                this.element.children("option").each(function () {
                    if ($(this).text().toLowerCase() === valueLowerCase) {
                        this.selected = valid = true;
                        return false;
                    }
                });
// Found a match, nothing to do
                if (valid) {
                    return;
                }

                //this.input.attr("title", "New metabolite will be created").tooltip("open");

                var creation = dialog_metabolite_add.find(".creationState");
                creation.text("A new metabolite will be created");
            },
            _destroy: function () {
                this.wrapper.remove();
                this.element.show();
            }
        });
        metabolite_combobox.combobox();
        $("#toggle").click(function () {
            metabolite_combobox.toggle();
        });

        $.ajax({
            url: "{% url "cyanodesign.views.get_reactions" %}",
            context: document.body,
            beforeSend: function() {
                dialog_progressbar.dialog("open");
            }
        }).done(function(x) {
            x["enzymes"].forEach(function(value) {
                //$('<div>' + this + '</div>').appendTo('#content')
                //$('<li>' + value + '</li>').addClass("ui-widget-content").appendTo('#reactions');
                createMetabolites(value);
            });

            createExternalMetabolites(x["external"]);

            x["enzymes"].forEach(function(value) {
                var enz = createEnzyme(value);
                enz.toHTML().appendTo(cyano_design_enzymes);
                enzymes.push(enz);
                $("<option></option>").text(enz.name).appendTo(cyano_design_objective_select);
            });

            if (x.objective.length > 0) {
                cyano_design_objective_select.val(x.objective[0].split(" ")[0])
            }
            var graph = Viz(x["graph"], "svg", "fdp");
            document.getElementById("visual").innerHTML = graph;
            visualize();
            dialog_progressbar.dialog("close");
        });
    });

//Visualization

            //var json_file = "{'directed': False, 'graph': [], 'nodes': [{'enzyme': True, 'reversible': False, 'id': 1, 'label': 'reac1'}, {'enzyme': False, 'id': 2, 'label': 'A_ext'}, {'enzyme': False, 'id': 3, 'label': 'A'}, {'enzyme': True, 'reversible': True, 'id': 4, 'label': 'reac2'}, {'enzyme': False, 'id': 6, 'label': 'B'}, {'enzyme': True, 'reversible': False, 'id': 7, 'label': 'reac3'}, {'enzyme': False, 'id': 9, 'label': 'C'}, {'enzyme': True, 'reversible': False, 'id': 10, 'label': 'reac4'}, {'enzyme': False, 'id': 13, 'label': 'D'}, {'enzyme': True, 'reversible': False, 'id': 14, 'label': 'reac5'}, {'enzyme': False, 'id': 16, 'label': 'D_ext'}, {'enzyme': True, 'reversible': False, 'id': 17, 'label': 'reac6'}, {'enzyme': False, 'id': 18, 'label': 'E_ext'}, {'enzyme': False, 'id': 19, 'label': 'E'}, {'enzyme': True, 'reversible': False, 'id': 20, 'label': 'reac7'}], 'links': [{'source': 0, 'target': 1}, {'source': 0, 'target': 2}, {'source': 2, 'target': 3}, {'source': 2, 'target': 5}, {'source': 3, 'target': 4}, {'source': 4, 'target': 7}, {'source': 5, 'target': 6}, {'source': 6, 'target': 7}, {'source': 7, 'target': 8}, {'source': 8, 'target': 14}, {'source': 8, 'target': 9}, {'source': 9, 'target': 10}, {'source': 11, 'target': 12}, {'source': 11, 'target': 13}, {'source': 13, 'target': 14}], 'multigraph': False}";
            //var info = JSON.parse(json_file)
    function visualize() {
        var edges = d3.selectAll(".edge");

        var graph = d3.select(".graph").select("polygon")
                .attr("stroke", "blue")
                .on("click", function (d) {
                    nodes.select("polygon").attr("fill", "lightgrey");
                    nodes.select("ellipse").attr("fill", "lightgrey");
                    showAll();
                });
        var texts = d3.selectAll("text")
                .on("click", function (d) {
                    var parent = d3.select(this.parentNode);
                    nodes.filter(function (d) {
                        var anode = d3.select(this);
                        if (anode.attr("id") == parent.attr("id")) {
                            highlight(anode);
                        }
                    })

                })

        function highlight(anode) {
            nodes.selectAll("polygon").attr("fill", "lightgrey")
            nodes.selectAll("ellipse").attr("fill", "lightgrey")
            anode.select("polygon")
                    .attr("fill", "orange");
            anode.select("ellipse")
                    .attr("fill", "orange");
            showPath(anode, [], [])
        }

        function showAll() {
            nodes.transition().duration(750).attr("opacity", 1);
            edges.transition().duration(750).attr("opacity", 1);
        }

        /** Shows the Path from selected Node as far as it gets.
         *  Only using svg information.*/
        function showPath(anode, nodeworkedList, edgeworkedList) {
            var anodeID = anode.attr("id")
            var nodeTitle = anode.select("title").text();
            if (nodeworkedList.indexOf(anodeID) == -1) {
                nodeworkedList.push(anodeID)
                edges.each(
                        function (d) {
                            if (edgeworkedList.indexOf(d3.select(this).select("title").text()) == -1) {
                                var aedge = d3.select(this),
                                        edgeTitle = aedge.select("title").text(),
                                        edgeID = aedge.attr("id"),
                                        re = /(\d+)->(\d+)/,
                                        hit = re.exec(edgeTitle);
                                if (hit[1] == nodeTitle) {
                                    aedge.attr("opacity", "1")
                                    var nextNode = "";
                                    nodes.each(function (d) {
                                        var viewedNode = d3.select(this);
                                        if (viewedNode.select("title").text() == hit[2]) {
                                            showPath(viewedNode, nodeworkedList, edgeworkedList)
                                        }
                                    })
                                    edgeworkedList.push(edgeID);
                                }
                                else if (hit[2] == nodeTitle) {
                                    var polygons = d3.select(this).selectAll("polygon");
                                    if (polygons.size() > 1) {
                                        var nextNode = "";
                                        nodes.each(function (d) {
                                            var viewedNode = d3.select(this);
                                            if (viewedNode.select("title").text() == hit[1]) {
                                                showPath(viewedNode, nodeworkedList, edgeworkedList);
                                            }
                                        })
                                        edgeworkedList.push(edgeID);
                                    }
                                }
                            }
                        }
                )
            }
            nodes.each(
                    function (d) {
                        var aNode = d3.select(this);
                        if (nodeworkedList.indexOf(aNode.attr("id")) > -1) {
                            aNode.transition().duration(750).attr("opacity", 1)
                        }
                        else {
                            aNode.transition().duration(750).attr("opacity", 0)
                        }
                    }
            )
            edges.each(
                    function (d) {
                        var aEdge = d3.select(this);
                        if (edgeworkedList.indexOf(aEdge.attr("id")) > -1) {
                            aEdge.transition().duration(750).attr("opacity", 1);
                        }
                        else {
                            aEdge.transition().duration(750).attr("opacity", 0);
                        }
                    }
            )

        }
    }
    /**
    function drawflux(enzymes, metabolites) {

        var color = d3.scale.category20()

        var div = "#visual",
                width = 800,
                height = 600;

        var links = [],
                nodes = [];

        function getMetobolites(source, metabolites) {
            var list = new Array();
            for (var sor in source) {
                for (var met in metabolites) {
                    if (metabolites[met].name == source[sor].name) {
                        list.push(metabolites[met]);
                        break;
                    }
                }
            }
            return list;
        }

        enzymes.forEach(
                function (d) {
                    d["typ"] = "protein";
                    nodes.push.apply(nodes, getMetobolites(d.substrates, metabolites));
                    nodes.push.apply(nodes, getMetobolites(d.products, metabolites));
                })

        nodes.push.apply(nodes, enzymes);
        nodes.forEach(function (d, i) {
            d.id = i;
        })

        nodes.forEach(function (d) {
            if (d.typ == "protein") {
                for (var i in d.substrates) {
                    var asubstrate = d.substrates[i]
                    asubstrate = nodes.filter(function (d) {
                        return d.name == asubstrate.name
                    })
                    links.push({source: asubstrate[0].id, target: d.id, bigraph: d.reversible})
                }
                for (var i in d.products) {
                    var aproduct = d.products[i]
                    aproduct = nodes.filter(function (d) {
                        return d.name == aproduct.name
                    })
                    links.push({source: d.id, target: aproduct[0].id, bigraph: d.reversible})
                }
            }
        })
        var graph = [nodes, links]
        var graph_json = JSON.stringify(graph);
        var nodesize = 10;

        nodes.push.apply(nodes, enzymes.products);

        var force = d3.layout.force()
                .charge(-300)
                .gravity(0.1)
                .size([width, height])
                .nodes(nodes)
                .links(links)
                .linkDistance(250)
                .friction(0)
                .start();

        function zoomed() {
            if (d3.select(this)) {
                design.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
            }
        }

        var design = d3.select(div).append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("pointer-events", "all")
                .call(d3.behavior.zoom().on("zoom", zoomed))
                .append("svg:g");

        design.append("rect")
                .attr("class", "overlay")
                .attr("width", width)
                .attr("height", height)
                .attr("fill", "white");

        // Definition Arrows

        // Setting for Arrows
        var marker = design.append("svg:defs").selectAll("marker");
        marker.data(["end"])
                .enter().append("svg:marker")
                .attr("id", String)
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 0)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("svg:path")
                .attr("d", "M 0 -5 L 10 0 L 0 5");

        marker.data(["start"])
                .enter().append("svg:marker")
                .attr("id", String)
                .attr("viewBox", "0 0 10 10")
                .attr("refX", 0)
                .attr("refY", 5)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("svg:path")
                .attr("d", "M -2 5 L 8 0 L 8 10 z");

        // add the links and the arrows
        var link = design.append("svg:g").selectAll("path")
                .data(links)
                .enter().append("svg:path")
                .attr("class", "link")
                .attr("marker-start", function (d) {
                    if (d.bigraph) {
                        return "url(#start)"
                    }
                    else {
                        return ""
                    }
                })
                .attr("marker-end", "url(#end)");

        var node = design.selectAll(".node")
                .data(nodes)
                .enter().append("g");
        node.append("path")
                .attr("class", "node")
                .call(force.drag)
                .attr("id", function (d) {
                    return d.id
                })
                .attr("transform", function (d) {
                    return "translate(" + d + ")";
                })
                .attr("d", d3.svg.symbol()
                        .size(200)
                        .type(function (d) {
                            if (d.typ == "protein") {
                                return d3.svg.symbolTypes[6];
                            }
                            else {
                                return d3.svg.symbolTypes[3];
                            }
                        })
        )
                .style("fill", function (d, i) {
                    return color(i)
                });

        node.append("text")
                .text(function (d) {
                    return d.name
                });

        function collide(node) {
            var r = 15*2,
            nx1 = node.x - r,
            nx2 = node.x + r,
            ny1 = node.y - r,
            ny2 = node.y + r;
            return function(quad, x1, y1, x2, y2){
                if (quad.point && (quad.point !== node)){

                    var x = node.x - quad.point.x,
                        y = node.y - quad.point.y,
                        l = Math.sqrt(x * x + y * y),
                        r =  15*6;
                    if (l < r) {
                        l = (l - r) / l * 0.5;
                        node.x -= x *= l;
                        node.y -= y *= l;
                        quad.point.x += x;
                        quad.point.y += y;
                    }
                }
                return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
            };
        }

        force.on("tick", function (d) {
            var qtree = d3.geom.quadtree(nodes),
                  i = 0,
                  n = nodes.length;
//
            while (++i < n) qtree.visit(collide(nodes[i]));

            link.attr("d", function (d) {
                var dx = d.target.x - d.source.x,
                        dy = d.target.y - d.source.y,
                //dr = Math.sqrt(dx * dx + dy * dy);
                        mx = d.target.x - d.source.x,
                        my = d.target.y - d.source.y,
                        m = my / mx,
                        b = d.source.y - m * d.source.x,
                        dy = Math.pow((d.source.y - d.target.y), 2),
                        dx = Math.pow((d.source.y - d.target.y), 2),
                        newx_source = 0,
                        newy_source = 0,
                        newx_target = 0,
                        newy_target = 0;

                if (dx >= dy) {
                    var changex = d.source.x > d.target.x ? -15 : 15,
                            newx_source = d.source.x + changex
                    newy_source = m * newx_source + b
                    newx_target = d.target.x - changex
                    newy_target = m * newx_target + b
                }
                else {
                    var changey = d.source.y > d.target.y ? -15 : 15,
                            newy_source = d.source.y + changey
                    newx_source = (newy_source - b) / m
                    newy_target = d.target.y - changey
                    newx_target = (newy_target - b) / m
                }
                return "M" +
                        newx_source + "," +
                        newy_source + "," +
                        newx_target + "," +
                        newy_target;
            });

            node.attr("transform", function (d) {
                return "translate(" + d.x + "," + d.y + ")";
            })
                    .attr("cx", function (d) {
                        return d.x = Math.max(nodesize, Math.min(width - (nodesize), d.x));
                    })
                    .attr("cy", function (d) {
                        return d.y = Math.max(nodesize, Math.min(height - (nodesize), d.y));
                    });
        });
    }
    */
</script>

{% endblock %}

{% block extrastyles %}
#feedback { font-size: 1.4em; }
#selectable .ui-selecting { background: #FECA40; }
#selectable .ui-selected { background: #F39814; color: white; }
#selectable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
#selectable li { margin: 3px; padding: 0.4em; font-size: 1.4em; height: 18px; }

body { font-size: 62.5%; }
input.text { margin-bottom:12px; width:95%; padding: .4em; }
fieldset { padding:0; border:0; margin-top:25px; }
div#users-contain { width: 350px; margin: 20px 0; }
div#users-contain table { margin: 1em 0; border-collapse: collapse; width: 100%; }
div#users-contain table td, div#users-contain table th { border: 1px solid #eee; padding: .6em 10px; text-align: left; }
.ui-dialog .ui-state-error { padding: .3em; }
.validateTips { border: 1px solid transparent; padding: 0.3em }

.no-close .ui-dialog-titlebar-close {
    display: none;
}

div.cyano-reaction {
    display: inline;
}

div.cyano-reaction-disabled {
    color: #BBBBBB;
}

div.cyano-reaction:hover {
    display: inline;
}

span.ui-spinner {
    width: 20%;
}

div.cyano-metabolite {
    display: inline;
}

div.cyano-reaction:hover,div.cyano-metabolite:hover {
    background-color: #E3E3E3;
    cursor: pointer;
}

span.external-metabolite { color: blue }

.hoverable {
    cursor: pointer;
}

.custom-combobox {
    position: relative;
    display: inline-block;
}
.custom-combobox-toggle {
    position: absolute;
    top: 0;
    bottom: 0;
    margin-left: -1px;
    padding: 0;
    /* support: IE7 */
    *height: 1.7em;
    *top: 0.1em;
}
.custom-combobox-input {
    margin: 0;
    padding: 0.3em;
}
.ui-autocomplete {
    max-height: 100px;
    overflow-y: auto;
    /* prevent horizontal scrollbar */
    overflow-x: hidden;
}

.ui-progressbar-value {
    background: rgb(61, 128, 179);
}

path.link {
  fill: black;
  stroke: #666;
  stroke-width: 1.5px;
}
{% endblock %}

{% block content %}

<img src="{% static "public/img/delete.png" %}" id="delete-button" class="delete-button" alt="Delete"/>
<img src="{% static "public/img/add.png" %}" id="add-button" class="add-button" alt="Add"/>


<div id="dialog-reaction" title="Edit Reaction">
    <p class="validateTips"></p>

    <form>
        <fieldset>
            <label for="name">Name</label>
            <input type="text" name="name" id="name" class="name text ui-widget-content ui-corner-all">
            <div>
                <label for="substrates">Substrates</label>
                <div id="reaction-substrates"></div>
                <img src="{% static "public/img/add.png" %}" id="add-substrate-button" class="hoverable" alt="Add"/>
            </div>
            <div>
                <label for="products">Products</label>
                <div id="reaction-products"></div>
                <img src="{% static "public/img/add.png" %}" id="add-product-button" class="hoverable" alt="Add"/>
            </div>
            <div>
                <input type="checkbox" name="reversible" id="reversible">
                <label for="reversible">Reversible</label>
            </div>
            <div>
                <input type="checkbox" name="constrained" id="constrained">
                <label for="constrained">Constrained</label>
            </div>
            <div id="constraints-min-max">
                <div>
                    <label for="constrained-min">Min</label>
                    <input type="text" name="constrained_min" id="constrained-min" class="spinner">
                </div>
                <div>
                    <label for="constrained-max">Max</label>
                    <input type="text" name="constrained_max" id="constrained-max" class="spinner">
                </div>
            </div>
        </fieldset>
    </form>
</div>

<div id="dialog-add-metabolite" title="Add Metabolite">
    <p>Select an existing metabolite or create a new one by providing a new name.</p>
    <p class="validateTips"></p>
    <form>
        <fieldset>
            <select id="metabolite-combobox">
            </select>
        </fieldset>
    </form>
    <p class="creationState"></p>
</div>

<div id="dialog-edit-metabolite" title="Edit Metabolite">
    <p>The metabolite is modified in all reactions.</p>
    <p class="validateTips"></p>

    <form>
        <fieldset>
            <label for="name">Name</label>
            <input type="text" name="name" id="name" class="name text ui-widget-content ui-corner-all">
            <label for="external">External</label>
            <input type="checkbox" name="external" id="external">
        </fieldset>
    </form>
</div>

<div id="dialog-progressbar" title="Please wait...">
<div id="progressbar"></div>
</div>

<div class="cyano-design-enzymes">
</div>
<img src="{% static "public/img/add.png" %}" id="add-enzyme-button" class="hoverable" alt="Add"/>

<div class="cyano-design-objective">
Design objective: <select id="cyano-design-objective-select"></select>
</div>

<div class="cyano-design-submit">
<input type="submit" id="design-submit" value="Simulate"></div>

<div id="products">
    <h1 class="ui-widget-header">Results</h1>

    <div id="simulation-result">

    </div>
    <div id="visual">

    </div>
</div>

{% endblock %}
