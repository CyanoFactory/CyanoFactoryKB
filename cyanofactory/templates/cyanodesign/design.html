{% extends "cyano/base.html" %}

{% comment %}
Cyanodesign index page

Copyright (c) 2013 Gabriel Kind <gkind@hs-mittweida.de>
Hochschule Mittweida, University of Applied Sciences

Released under the MIT license
{% endcomment %}

{% load static %}
{% load staticfiles %}
{% load templatetags %}
{% load filters %}
{% load crispy_forms_tags %}

{% block head_title %}{{ block.super }} :: WeDesign{% endblock %}
{% block page_title %}WeDesign &ndash; {{ name }}{% endblock %}
{% block head %}
{{ block.super }}
<script src="{% get_static_prefix %}cyanodesign/js/d3.v3.js"></script>
<link href="{% get_static_prefix %}cyanodesign/css/c3.css" rel="stylesheet" type="text/css">
<script src="{% get_static_prefix %}cyanodesign/js/c3.js"></script>
<script src="{% get_static_prefix %}cyanodesign/node_modules/viz.js/viz.js"></script>
<script type="text/javascript" src="{% get_static_prefix %}boehringer/js/svg-pan-zoom.js"></script>
<script src="{% get_static_prefix %}cyanodesign/node_modules/requirejs/require.js"
        data-main="{% get_static_prefix %}cyanodesign/js/main"></script>
<!--<script src="{% get_static_prefix %}cyanodesign/js/metabolic_model.js"></script>-->
<script src="{% get_static_prefix %}cyanodesign/js/mba_chart.js"></script>
<script src="{% get_static_prefix %}cyanodesign/js/selectize_plugin.js"></script>

<script type="text/javascript">
    "use strict";

    var app = undefined;
    var startup = undefined;
    var revision = {% if revision %}{{ revision.pk }}{% else %}undefined{% endif %};

    $(function () {
        $($("#filter_row_flux").text()).appendTo($("#cyano-flux-list_wrapper").children()[1]);

        /*$.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                if (settings.nTable == table_flux[0]) {
                    var min = parseFloat($("#filter-flux-min").val());
                    var max = parseFloat($("#filter-flux-max").val());

                    var d = datatable_flux.data()[dataIndex];

                    // Check flux values
                    if (!isNaN(min) && d[1] < min) {
                        return false;
                    }

                    if (!isNaN(max) && d[1] > max) {
                        return false;
                    }

                    return true;
                }

                return true;
            }
        );*/

        $( ".check" ).button();

        var selectize_options = {
            valueField: 'id',
            searchField: ['id'],
            delimiter: '\x00', // impossible delimiter,
            plugins: ['drag_drop', 'remove_button', 'restore_on_backspace'],
            render: {
                option: function(item, escape) {
                    return $("<div>").addClass("option").text(item.id).wrap("<p>").parent().html();
                },
                item: function(item, escape) {
                    if (typeof item.item === "undefined") {
                        // workaround firefox remembering old input
                        return "<div></div>";
                    }
                    var amount = item.item.amount;
                    return $("<div>").addClass("item").attr("data-type", "text").attr("data-item", item.id).text(amount + " " + item.id).wrap("<p>").parent().html();
                }
            }
        };

        var item_add = function(elements) {
            return function(value, item) {
                item.data("dialog", elements);
                item.data("value", elements.selectize.options[value].item.amount);
                item.editable({
                    type: "text",
                    container: dialog_enzyme[0],
                    title: "Enter amount",
                    unsavedclass: null,
                    success: function (response, newValue) {
                        if (!isFinite(newValue)) {
                            return "Not a number";
                        }

                        var sel;
                        sel = elements.selectize;
                        sel.options[$(this).data("item")].item.amount = newValue;
                        // no this doesn't rerender selected items only flushes render cache...
                        sel.clearCache("item");
                        // readd items
                        // braindead api returns delimited string in get but expects array in set m(
                        sel.setValue(sel.getValue().split('\x00').map(function (a) {
                            return a;
                        }));
                        return {"newValue": newValue};
                    }
                });
            };
        };

        //$(".spinner").spinedit();
        $(".checkbox").button();
        $(".validateTips").hide();
        $("input[type=submit], button")
            .button()
            .click(function( event ) {
                event.preventDefault();
            });

        var doExport = function(format) {
            var data = beginRequest();
            data["dry_run"] = true;

            $.ajax({
                url: "{% url "cyanodesign:simulate" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                if (x["solution"] == "Optimal") {
                    notifyInfo("The solution is " + x["solution"] + ". The download starts in a few seconds. To update the result below press \"Run simulation\".");

                    delete data["dry_run"];
                    data["format"] = format;

                    for (var d in data) {
                        submit_form.append($("<input/>", {type:"text", name:d}).val(data[d]))
                    }

                    submit_form.submit();

                } else {
                    notifyWarning("The solution is " + x["solution"] + ". Check if your constraints are too strict.");
                }

                endRequest();
            }).fail(function(x) {
                $("#visual_graph").hide();
                $("#visual_fba").hide();
                notifyError(x.responseText);
                endRequest();
            });
        };

        var endRequest = function(wait_position) {
            if (wait_position === undefined)
                waitIndicator.hide($("#content"));
            else
                waitIndicator.hide(wait_position);
        };

        $("#design-saveas").click(function(event) {
            var txt = "";

            if (revision !== undefined) {
                txt = "Rollback to revision " + revision;
            }

            $("#id_saveas_summary").val(txt);
            $("#dialog-saveas-model").modal("show");
        });

        $("#dialog-saveas-model").on("click", ".btn-primary", function(event) {
            var form = $("#dialog-saveas-model").find("form");
            var data = beginRequest($("#dialog-saveas-model").find(".modal-content"));
            data["saveas_name"] = form.find("#id_saveas_name").val();
            data["saveas_summary"] = form.find("#id_saveas_summary").val();
            $.ajax({
                url: "{% url "cyanodesign:save_as" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                if (!(x['success'])) {
                    form.replaceWith(x['form_html']);
                } else {
                    location.replace(x['url'])
                }
                endRequest($("#dialog-saveas-model").find(".modal-content"));
            }).fail(function(x) {
                $("#visual_graph").hide();
                $("#visual_fba").hide();
                notifyError(x.responseText);
                endRequest($("#dialog-saveas-model").find(".modal-content"));
            });
        });

        $("#export-png").click(function(event) {
            if (last_symtype == "mba" || last_symtype == "sa") {
                $("#visual_graph > svg").find(".c3-axis path, .c3-axis line").css({"fill":"none","stroke":"black"});
                $("#visual_graph > svg").css({"font":"10px sans-serif"});
                $("#visual_graph > svg").find(".c3-legend-item").css({"font":"12px sans-serif"});

                downloadPNG();
            } else {
                // save old style
                var g = $("#visual_fba > svg > g");
                var g_style = g.attr("style");
                var g_transform = g.attr("transform");

                // Clear style, otherwise SVG only shows a viewport
                g.attr("style", "").attr("transform", "");

                downloadPNG();

                // Reset style
                g.attr("style", g_style).attr("transform", g_transform);
            }
        });

        $("#export-svg").click(function(event) {
            if (last_symtype == "mba" || last_symtype == "sa") {
                $("#visual_graph > svg").find(".c3-axis path, .c3-axis line").css({"fill":"none","stroke":"black"});
                $("#visual_graph > svg").css({"font":"10px sans-serif"});
                $("#visual_graph > svg").find(".c3-legend-item").css({"font":"12px sans-serif"});

                downloadSVG();
            } else {
                // save old style
                var g = $("#visual_fba > svg > g");
                var g_style = g.attr("style");
                var g_transform = g.attr("transform");

                // Clear style, otherwise SVG only shows a viewport
                g.attr("style", "").attr("transform", "");

                downloadSVG();

                // Reset style
                g.attr("style", g_style).attr("transform", g_transform);
            }
        });

        $("#export-csv").click(function(event) {
            doExport("csv");
        });

        let startup_handler = function(callback, metabolic_model_cls, urls) {
            urls.simulate = "{% url "cyanodesign:simulate" pk=pk %}";
            urls.save = "{% url "cyanodesign:save" pk=pk %}";
            urls.save_as = "{% url "cyanodesign:save_as" pk=pk %}";
            urls.design = "{% url "cyanodesign:design" pk=pk %}";
            urls.get_reactions = "{% url "cyanodesign:get_reactions" pk=pk %}{% if revision %}?revision={{ revision.pk }}{% endif %}";
            urls.viz_full_render = "{% get_static_prefix %}cyanodesign/node_modules/viz.js/full.render.js";

            callback(metabolic_model_cls, urls);
        };

        let load_model = function(callback) {
            $.ajax({
                url: "{% url "cyanodesign:get_reactions" pk=pk %}{% if revision %}?revision={{ revision.pk }}{% endif %}",
                context: document.body
            }).done(function(x) {
                let model = new MetabolicModel.Model();
                model.fromJson(x);

                callback(model);

                waitIndicator.hide($("#content"));
            });
        };

        //table_enzymes.css("width", "");
        //table_metabolites.css("width", "");

        $("#enzyme_regex").click(function() {
            datatable_enzymes.search("", $(this).prop("checked"), true).draw();
        });

        $("#flux_regex").click(function() {
            datatable_flux.search("", $(this).prop("checked"), true).draw();
        });

        waitIndicator.show($("#content"));
        startup = startup_handler;
    });
</script>

{% endblock %}

{% block extrastyles %}
span.cyano-external-metabolite { color: green }

.cyano-metabolite-list tr td:first-child,
.cyano-enzyme-list tr td:first-child {
    font-weight: bold;
}

.hoverable,
.cyano-metabolite-list .cyano-enzyme,
.cyano-metabolite-list tr td:first-child,
.cyano-enzyme-list tr td:first-child,
.cyano-enzyme-list .cyano-metabolite,
svg g.node,
svg text
{
    cursor: pointer;
}
.hoverable:hover,
.cyano-metabolite-list .cyano-enzyme:hover,
.cyano-metabolite-list tr td:first-child:hover,
.cyano-enzyme-list tr.odd td:first-child:hover,
.cyano-enzyme-list tr.even td:first-child:hover,
.cyano-enzyme-list .cyano-metabolite:hover
{
    color: blue;
}

.cyano-enzyme-disabled
{
    color: grey;
}

.submit-form
{
    display: none;
}

.tab-content
{
    margin-top: 5px;
    margin-bottom: 5px;
}

.visual-graph {
  width: 300px;
  height: 300px;
}

{% endblock %}

{% block content %}

{% if not request.user.is_authenticated %}
<div class="alert alert-info" role="alert">
        <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
        <span class="sr-only">Info:</span>You are not logged in. Making permanent changes to models or uploading new ones is disabled.</div>
</div>
{% endif %}

{% if revision %}
<div class="alert alert-info" role="alert">
Viewing old model from {{ revision.date }}. Simulating and saving will be based on this old version of the model.
</div>
{% endif %}

<div role="tabpanel">
<ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#reaction-tab" role="tab" data-toggle="tab">Reactions</a></li>
    <li role="presentation"><a href="#metabolite-tab" role="tab" data-toggle="tab">Metabolites</a></li>
    <li role="presentation"><a href="#settings-tab" role="tab" data-toggle="tab">Settings</a></li>
    <!--<li role="presentation"><a href="#chemical-tab" role="tab" data-toggle="tab">Stoichiometry</a></li>-->
    <!--<li role="presentation"><a href="#history-tab" role="tab" data-toggle="tab">History</a></li>-->
    <li role="presentation"><a href="#simulation-tab" role="tab" data-toggle="tab">Simulation</a></li>
</ul>

<div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="reaction-tab">
    </div>
    <div role="tabpanel" class="tab-pane" id="metabolite-tab">
    </div>

    <div role="tabpanel" class="tab-pane" id="settings-tab">
    </div>

    <!--<div role="tabpanel" class="tab-pane" id="chemical-tab">
    </div>-->

    <div role="tabpanel" class="tab-pane" id="history-tab">
    </div>

    <div role="tabpanel" class="tab-pane" id="simulation-tab">
    </div>
</div>
</div>

<!-- Modal -->
<div class="modal fade" id="dialog-delete-metabolites" tabindex="-1" role="dialog" aria-labelledby="dialog-delete-metabolites-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-delete-metabolites-label">Delete unused metabolites</h4>
            </div>
            <div class="modal-body">
                Do you really want to delete all unused metabolites?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-danger">Delete</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="dialog-save-model" tabindex="-1" role="dialog" aria-labelledby="dialog-save-model-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            {% crispy save_form %}
        </div>
    </div>
</div>

<div class="modal fade" id="dialog-saveas-model" tabindex="-1" role="dialog" aria-labelledby="dialog-saveas-model-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            {% crispy saveas_form %}
        </div>
    </div>
</div>

{% if request.user.is_authenticated %}
<input type="submit" id="design-save" class="btn btn-primary" value="Save">
<input type="submit" id="design-saveas" class="btn btn-primary" value="Save As">
{% endif %}

<form method="post" action="{% url "cyanodesign:simulate" pk=pk %}" id="submit-form">
{% csrf_token %}
</form>

{% endblock %}
