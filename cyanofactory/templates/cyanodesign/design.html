{% extends "cyano/base.html" %}

{% comment %}
Cyanodesign index page

Copyright (c) 2013 Gabriel Kind <gkind@hs-mittweida.de>
Hochschule Mittweida, University of Applied Sciences

Released under the MIT license
{% endcomment %}

{% load static %}
{% load staticfiles %}
{% load templatetags %}
{% load filters %}
{% load crispy_forms_tags %}

{% block head_title %}{{ block.super }} :: CyanoDesign{% endblock %}
{% block page_title %}CyanoDesign &ndash; {{ name }}{% endblock %}

{% block head %}
{{ block.super }}
<script src="{% get_static_prefix %}cyanointeraction/d3/d3.v3.min.js"></script>
<script src="{% get_static_prefix %}cyano/js/viz.js"></script>
<script type="text/javascript" src="{% get_static_prefix %}boehringer/js/svg-pan-zoom.js"></script>
<script src="{% get_static_prefix %}cyanodesign/js/enzyme.js"></script>
<script type="text/javascript">
    "use strict";
    var enzymes_design = [];
    var design_objective = undefined;
    var dialog_metabolite_edit;
    var dialog_enzyme;
    var dialog_metabolite_add;
    var cyano_design_objective_select;
    var design_objective_visible_combobox;
    var constraints_div;
    var create_new_enzyme = false;
    var command_list = [];
    var svg;
    var table_enzymes;
    var datatable_enzymes;
    var table_metabolites;
    var datatable_metabolites;
    var submit_form;
    var revision = {% if revision %}{{ revision.pk }}{% else %}undefined{% endif %};

    Enzyme.prototype.invalidate = function() {
        this.getMetabolites().forEach(function (obj) {
            datatable_metabolites.row(Metabolite.metabolites.indexOf(obj)).invalidate();
        });

        datatable_enzymes.row(Enzyme.enzymes.indexOf(this)).invalidate();
    };

    Enzyme.prototype.removeFromList = function() {
        var that = this;
        datatable_enzymes.row(function(idx, data, node) {
            return data.name == that.name;
        }).remove();
    };

    Metabolite.prototype.invalidate = function() {
        this.getEnzymes().forEach(function (obj) {
            datatable_enzymes.row(Enzyme.enzymes.indexOf(obj)).invalidate();
        });

        datatable_metabolites.row(Metabolite.metabolites.indexOf(this)).invalidate();
    };

    Metabolite.prototype.removeFromList = function() {
        var that = this;
        datatable_metabolites.row(function(idx, data, node) {
            return data.name == that.name;
        }).remove();
    };

    var reaction_filter = [
        function(e) { return !e.disabled },
        function(e) { return e.disabled },
        function(e) { return e.isConstrained() },
        function(e) { return !e.isConstrained() },
        function(e) { return e.reversible },
        function(e) { return !e.reversible }
    ];

    var metabolite_filter = [
        function(e) { return !e.external },
        function(e) { return e.external }
    ];

    function notifyInfo(text) {
        $("#simulation-result").html('<div class="alert alert-info" role="alert">\
            <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>\
            <span class="sr-only">Info:</span>' + text + '</div>');
    }

    function notifyWarning(text) {
        $("#simulation-result").html('<div class="alert alert-warning" role="alert">\
            <span class="glyphicon glyphicon-warning-sign" aria-hidden="true"></span>\
            <span class="sr-only">Info:</span>' + text + '</div>');
    }

    function notifyError(text) {
        $("#simulation-result").html('<div class="alert alert-danger" role="alert">\
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>\
            <span class="sr-only">Error:</span>' + text + '</div>');
    }

    $(function () {
        dialog_metabolite_edit = $("#dialog-edit-metabolite");
        dialog_enzyme = $("#dialog-reaction");
        dialog_metabolite_add = $("#dialog-add-metabolite");
        cyano_design_objective_select = $("#cyano-design-objective-select");
        design_objective_visible_combobox = $("#design-objective-visible-combobox");
        constraints_div = $("#constraints-min-max");
        table_enzymes = $('#cyano-enzyme-list');
        table_metabolites = $('#cyano-metabolite-list');
        submit_form = $('#submit-form');

        datatable_enzymes = table_enzymes.DataTable({
            "deferRender": true,
            columns: [
                    {},
                    {},
                    {},
                    {},
                    {},
                    {}
                ],
            columnDefs: [
                {
                    "targets": 0,
                    "width": "25%",
                    "data": function (rowData, type, set, meta) {
                        return rowData;
                    },
                    render: function(data, type, row, meta) {
                        var e = $("<span>");

                        if (data.disabled) {
                            e.addClass("cyano-enzyme-disabled");
                        }

                        return e.text(data.name).wrap("<p>").parent().html();
                    }
                },
                {
                    "targets": 1,
                    "width": "45%",
                    "orderable": false,
                    "data": function (rowData, type, set, meta) {
                        return rowData;
                    },
                    render: function(data, type, row, meta) {
                        return $(data.toHTML()).wrap("<p>").parent().html();
                    }
                },
                {
                    "targets": 2,
                    "width": "10%",
                    "orderable": false,
                    "searchable": false,
                    "data": function (rowData, type, set, meta) {
                        return rowData.constraintsToString();
                    }
                },
                {
                    "targets": 3,
                    "width": "12%",
                    "orderable": false,
                    "searchable": false,
                    "data": function (rowData, type, set, meta) {
                        return !rowData.disabled;
                    },
                    render: function(data, type, row, meta) {
                        return "<div class='checkbox'> \
                        <input type='checkbox' id='enabled" + meta.row + "' " + (data ? "checked='checked'" : "") + "> \
                        <label for='enabled"  + meta.row + "'>Enabled</label> \
                        </div>";
                    }
                },
                {
                    "targets": 4,
                    "width": "8%",
                    "orderable": false,
                    "searchable": false,
                    "data": function (rowData, type, set, meta) {
                        return rowData;
                    },
                    "render": function(data, type, row, meta) {
                        return "<a class='btn btn-default btn-xs delete-button'>Delete</a>"
                    }
                },
                {
                    "targets": 5,
                    "visible": false,
                    "orderable": true,
                    "data": function (rowData, type, set, meta) {
                        return rowData.pathway.length == 0 ? "No Pathway" : rowData.pathway;
                    }
                }
            ],
            drawCallback: function ( settings ) {
                var api = this.api();
                var rows = api.rows( {page:'current'} ).nodes();
                var last=null;

                api.column(5, {page:'current'} ).data().each( function ( group, i ) {
                    if ( last !== group ) {
                        $(rows).eq( i ).before(
                            '<tr class="group"><td colspan="5">'+group+'</td></tr>'
                        );

                        last = group;
                    }
                } );
            },
            "displayLength": 25,
            "order": [[ 5, 'asc' ]],
            dom:
                "<'row'<'col-sm-6'l><'col-sm-6'f>>" +
                "<'row'>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-6'i><'col-sm-6'p>>"
        });

        $($("#filter_row").text()).appendTo($("#cyano-enzyme-list_wrapper").children()[1]);

        $("#cyano-enzyme-list-filter-reactions").multiselect({
            buttonClass: 'btn btn-default btn-xs',
            onChange: function(option, checked, select) {
                datatable_enzymes.draw();
            },
            buttonText: function(options, select) {
                if (options.length === 0) {
                    return 'No option selected';
                }
                else if (options.length === 6) {
                    return 'No filter applied';
                }
                else {
                    var labels = [];
                    var prev = undefined;

                    options.each(function() {
                        if (prev !== undefined) {
                            if (prev.index % 2 == 1) {
                                labels.push("AND");
                            } else {
                                if (this.index - 1 == prev.index) {
                                    labels.push("OR");
                                } else {
                                    labels.push("AND");
                                }
                            }
                        }

                        labels.push($(this).html());

                        prev = this;
                    });
                    return labels.join(' ') + '';
                }
            }
        });

        // Order by the grouping
        table_enzymes.delegate('tr.group', 'click', function() {
            var currentOrder = datatable_enzymes.order()[0];
            if ( currentOrder[0] === 2 && currentOrder[1] === 'asc' ) {
                datatable_enzymes.order( [ 5, 'desc' ] ).draw();
            }
            else {
                datatable_enzymes.order( [ 5, 'asc' ] ).draw();
            }
        } );

        $.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                if (settings.nTable == table_enzymes[0]) {
                    var arr = $("#cyano-enzyme-list-filter-reactions").find("option").map(function () {
                        return this.selected;
                    }).get();

                    var d = datatable_enzymes.data()[dataIndex];
                    var f = reaction_filter;

                    if (!(arr[0] || arr[1]) || !(arr[2] || arr[3]) || !(arr[4] || arr[5])) {
                        return false;
                    }

                    return ((arr[0] ? f[0](d) : !f[0](d)) || (arr[1] ? f[1](d) : !f[1](d))) &&
                            ((arr[2] ? f[2](d) : !f[2](d)) || (arr[3] ? f[3](d) : !f[3](d))) &&
                            ((arr[4] ? f[4](d) : !f[4](d)) || (arr[5] ? f[5](d) : !f[5](d)));
                }

                return true;
            }
        );

        datatable_metabolites = table_metabolites.DataTable({
            "deferRender": true,
            columns: [
                    {},
                    {},
                    {},
                    {}
                ],
            columnDefs: [
                {
                    "targets": 0,
                    "data": function (rowData, type, set, meta) {
                        return rowData.name;
                    }
                },
                {
                    "targets": 1,
                    "orderable": false,
                    "data": function (rowData, type, set, meta) {
                        return rowData.consumed;
                    },
                    "render": function(data, type, row, meta ) {
                        return data.map(function(arg) {
                            var e = $("<span></span>").addClass("cyano-enzyme");
                            if (arg.disabled) {
                                e.addClass("cyano-enzyme-disabled");
                            }
                            return e.append(arg.name).wrap("<p>").parent().html();
                        }).join(", ");
                    }
                },
                {
                    "targets": 2,
                    "orderable": false,
                    "data": function (rowData, type, set, meta) {
                        return rowData.produced;
                    },
                    "render": function(data, type, row, meta ) {
                        return data.map(function(arg) {
                            var e = $("<span></span>").addClass("cyano-enzyme");
                            if (arg.disabled) {
                                e.addClass("cyano-enzyme-disabled");
                            }
                            return e.append(arg.name).wrap("<p>").parent().html();
                        }).join(", ");
                    }
                },
                {
                    "targets": 3,
                    "orderable": false,
                    "searchable": false,
                    "data": function (rowData, type, set, meta) {
                        return rowData.external
                    },
                    render: function(data, type, row, meta) {
                        return "<div class='checkbox'> \
                        <input type='checkbox' id='external" + meta.row + "' " + (data ? "checked='checked'" : "") + "> \
                        <label for='external"  + meta.row + "'>External</label> \
                        </div>";
                    }
                }
            ],
            "displayLength": 25,
            dom:
                "<'row'<'col-sm-6'l><'col-sm-6'f>>" +
                "<'row'>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-6'i><'col-sm-6'p>>"
        });

        $($("#filter_row_metabolites").text()).appendTo($("#cyano-metabolite-list_wrapper").children()[1]);

        $("#cyano-metabolite-list-filter-reactions").multiselect({
            buttonClass: 'btn btn-default btn-xs',
            onChange: function(option, checked, select) {
                datatable_metabolites.draw();
            },
            buttonText: function(options, select) {
                if (options.length === 0) {
                    return 'No option selected';
                }
                else if (options.length === 2) {
                    return 'No filter applied';
                }
                else {
                    var labels = [];

                    options.each(function() {
                        labels.push($(this).html());
                    });
                    return labels.join(' ') + '';
                }
            }
        });

        $.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                if (settings.nTable == table_metabolites[0]) {
                    var arr = $("#cyano-metabolite-list-filter-reactions").find("option").map(function () {
                        return this.selected;
                    }).get();

                    var d = datatable_metabolites.data()[dataIndex];
                    var f = metabolite_filter;

                    if (!(arr[0] || arr[1])) {
                        return false;
                    }

                    return ((arr[0] ? f[0](d) : !f[0](d)) || (arr[1] ? f[1](d) : !f[1](d)));
                }

                return true;
            }
        );

        $( ".check" ).button();

        var selectize_options = {
            valueField: 'id',
            searchField: ['id'],
            delimiter: '\x00', // impossible delimiter,
            plugins: ['drag_drop', 'remove_button', 'restore_on_backspace'],
            render: {
                option: function(item, escape) {
                    return $("<div>").addClass("option").text(item.id).wrap("<p>").parent().html();
                },
                item: function(item, escape) {
                    if (typeof item.item === "undefined") {
                        // workaround firefox remembering old input
                        return "<div></div>";
                    }
                    var amount = item.item.amount;
                    return $("<div>").addClass("item").attr("data-type", "text").attr("data-item", item.id).text(amount + " " + item.id).wrap("<p>").parent().html();
                }
            }
        };

        dialog_enzyme.find("#reaction-substrates").text("");
        selectize_options["onItemAdd"] = function(value, item) {
            item.data("dialog", dialog_enzyme.find("#reaction-substrates")[0]);
            item.data("value", dialog_enzyme.find("#reaction-substrates")[0].selectize.options[value].item.amount);
            item.editable({
                type: "text",
                container: dialog_enzyme[0],
                title: "Enter amount",
                unsavedclass: null,
                success: function (response, newValue) {
                    if (!isFinite(newValue)) {
                        return "Not a number";
                    }

                    var sel;
                    sel = dialog_enzyme.find("#reaction-substrates")[0].selectize;
                    sel.options[$(this).data("item")].item.amount = newValue;
                    // no this doesn't rerender selected items only flushes render cache...
                    sel.clearCache("item");
                    // readd items
                    // braindead api returns delimited string in get but expects array in set m(
                    sel.setValue(sel.getValue().split('\x00').map(function (a) {
                        return a;
                    }));
                    return {"newValue": newValue};
                }
            });
        };
        dialog_enzyme.find("#reaction-substrates").selectize(selectize_options);
        dialog_enzyme.find("#reaction-products").text("");
        selectize_options["onItemAdd"] = function(value, item) {
            item.data("dialog", dialog_enzyme.find("#reaction-products")[0]);
            item.data("value", dialog_enzyme.find("#reaction-products")[0].selectize.options[value].item.amount);
            item.editable({
                type: "text",
                container: dialog_enzyme[0],
                title: "Enter amount",
                unsavedclass: null,
                success: function(response, newValue) {
                    if (!isFinite(newValue)) {
                        return "Not a number";
                    }

                    var sel;
                    sel = dialog_enzyme.find("#reaction-products")[0].selectize;
                    sel.options[$(this).data("item")].item.amount = newValue;
                    sel.clearCache("item");
                    sel.setValue(sel.getValue().split('\x00').map(function(a) { return a; }));
                    return {"newValue": newValue};
                }
            });
        };
        dialog_enzyme.find("#reaction-products").selectize(selectize_options);

        dialog_enzyme.find("#reaction-substrates").editable();

        // Array Remove - By John Resig (MIT Licensed)
        Array.prototype.remove = function(from, to) {
          var rest = this.slice((to || from) + 1 || this.length);
          this.length = from < 0 ? this.length + from : from;
          return this.push.apply(this, rest);
        };

        //$(".spinner").spinedit();
        $(".checkbox").button();
        $(".validateTips").hide();
        $("input[type=submit], button")
            .button()
            .click(function( event ) {
                event.preventDefault();
            });

        var beginRequest = function() {
            waitIndicator.show($("#content"));

            var result = {
                "changes": JSON.stringify(command_list),
                "objectives": JSON.stringify([{
                    "name": cyano_design_objective_select.val(),
                    "maximize": $("#radio-maximize").prop("checked")
                }]),
                "display": JSON.stringify(design_objective_visible_combobox[0].selectize.getValue().split("\x00")),
                "auto_flux": JSON.stringify($("#auto_flux").prop("checked"))
            };

            if (revision !== undefined) {
                result["revision"] = revision;
            }

            return result;
        };

        var doExport = function(format) {
            var data = beginRequest();
            data["dry_run"] = true;

            $.ajax({
                url: "{% url "cyano-design-simulate" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                if (x["solution"] == "Optimal") {
                    notifyInfo("The solution is " + x["solution"] + ". The download starts in a few seconds. To update the result below press \"Run simulation\".");

                    delete data["dry_run"];
                    data["format"] = format;

                    for (var d in data) {
                        submit_form.append($("<input/>", {type:"text", name:d}).val(data[d]))
                    }

                    submit_form.submit();

                } else {
                    notifyWarning("The solution is " + x["solution"] + ". Check if your constraints are too strict.");
                }

                endRequest();
            }).error(function(x) {
                $("#visual").hide();
                notifyError(x.responseText);
                endRequest();
            });
        };

        var endRequest = function() {
            waitIndicator.hide($("#content"));
        };

        $("#design-submit").click(function(event) {
            var data = beginRequest();

            $.ajax({
                url: "{% url "cyano-design-simulate" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                //var graph = Viz(x["graph"], "svg", "dot");

                if (x["solution"] == "Optimal") {
                    var obj = cyano_design_objective_select.val();
                    notifyInfo("The solution is " + x["solution"] + ". Flux of objective is " + x["flux"][obj].toFixed(4));
                } else {
                    notifyWarning("The solution is " + x["solution"] + ". Check if your constraints are too strict.");
                }

                $("#visual").show();
                document.getElementById("visual").innerHTML = x["graph"];

                $("svg").attr("width", "100%").attr("height", "400px");
                var svgPan = svgPanZoom('svg', {minZoom: 0.1, fit: false});
                svgPan.zoom(1);
                /*$("svg").find(".edge text").each(function() {
                    if ($(this).text().indexOf(cyano_design_objective_select.val() + " ") == 0) {
                        var new_x = ($("svg").width() / 2) - $(this).attr("x");
                        var new_y = ($("svg").height() / 2) - $(this).attr("y");
                        svgPan.pan({x: new_x, y: new_y});
                    }
                });*/

                endRequest();
            }).error(function(x) {
                $("#visual").hide();
                notifyError(x.responseText);
                endRequest();
            });
        });

        $("#design-save").click(function(event) {
            var txt = "";

            if (revision !== undefined) {
                txt = "Rollback to revision " + revision;
            }

            $("#id_save_summary").val(txt);
            $("#dialog-save-model").modal("show");
        });

        $("#design-saveas").click(function(event) {
            var txt = "";

            if (revision !== undefined) {
                txt = "Rollback to revision " + revision;
            }

            $("#id_saveas_summary").val(txt);
            $("#dialog-saveas-model").modal("show");
        });

        $("#dialog-save-model").on("click", ".btn-primary", function(event) {
            var form = $("#dialog-save-model").find("form");
            var data = beginRequest();
            data["summary"] = form.find("#id_save_summary").val();
            $.ajax({
                url: "{% url "cyano-design-save" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                if (revision !== undefined) {
                    location.replace("{% url "cyano-design-design" pk=pk %}");
                }
                $("#dialog-save-model").modal("hide");
                endRequest();
                command_list = [];
            }).error(function(x) {
                $("#visual").hide();
                notifyError(x.responseText);
                endRequest();
            });
        });

        $("#dialog-saveas-model").on("click", ".btn-primary", function(event) {
            var form = $("#dialog-saveas-model").find("form");
            var data = beginRequest();
            data["saveas_name"] = form.find("#id_saveas_name").val();
            data["saveas_summary"] = form.find("#id_saveas_summary").val();
            $.ajax({
                url: "{% url "cyano-design-saveas" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                if (!(x['success'])) {
                    form.replaceWith(x['form_html']);
                } else {
                    location.replace(x['url'])
                }
                endRequest();
            }).error(function(x) {
                $("#visual").hide();
                notifyError(x.responseText);
                endRequest();
            });
        });

        $("#export-png").click(function(event) {
            doExport("png");
        });

        $("#export-svg").click(function(event) {
            doExport("svg");
        });

        $("#export-csv").click(function(event) {
            doExport("csv");
        });

        function updateTips(o, t) {
            if (typeof o !== "undefined") {
                o.parent(".form-group").addClass("has-error");
                o.siblings(".help-block").remove();
                $("<div></div>").addClass("help-block").text(t).insertAfter(o);
            }
        }

        function checkLength(o, n, min, max) {
            if (o.val().length > max || o.val().length < min) {
                o.addClass("ui-state-error");
                updateTips(o, "Length of " + n + " must be between " +
                        min + " and " + max + ".");
                return false;
            } else {
                return true;
            }
        }

        function checkBool(o, bool, error) {
            if (bool) {
                return true;
            } else {
                updateTips(o, error);
                return false;
            }
        }

        function checkRegexp(o, regexp, n) {
            if (!( regexp.test(o.val()) )) {
                updateTips(o, n);
                return false;
            } else {
                return true;
            }
        }

        function getEnzymeByName(name) {
            return Enzyme.enzymes.find(function(obj) {
                return obj.name == name;
            });
        }

        function updateEnzymeList() {
            datatable_enzymes.clear();
            datatable_enzymes.rows.add(Enzyme.enzymes);
            datatable_enzymes.draw();

            var old_design_objective = design_objective;

            Enzyme.enzymes.forEach(function(item) {
                cyano_design_objective_select[0].selectize.addOption(item);
                design_objective_visible_combobox[0].selectize.addOption(item);
                item.updateMetaboliteReference();
            });
            cyano_design_objective_select[0].selectize.refreshOptions();
            design_objective_visible_combobox[0].selectize.refreshOptions();

            if (old_design_objective !== undefined) {
                cyano_design_objective_select[0].selectize.setValue(old_design_objective.name, false);
            }
        }

        function updateMetabolitesList() {
            datatable_metabolites.clear();
            datatable_metabolites.rows.add(Metabolite.metabolites);
            datatable_metabolites.draw();
        }

        function updateEnzymeDesignList() {
            $(".cyano-design-reactions").text("");
            enzymes_design.forEach(function(obj) {
                $("<div></div>").addClass("cyano-design-reaction").text(obj.name).appendTo(".cyano-design-reactions");
            });
        }

        function showAddEnzymeDialog() {
            showEditEnzymeDialog(new Enzyme("New Enzyme"), true);
        }

        function showEditEnzymeDialog(enzyme, create_new) {
            dialog_enzyme.data("object", enzyme);
            dialog_enzyme.data("create", create_new);
            dialog_enzyme.find("#enzyme-name").val(enzyme.name);
            dialog_enzyme.find("#reversible").prop("checked", enzyme.reversible);

            var substrates = dialog_enzyme.find("#reaction-substrates")[0].selectize;
            var products = dialog_enzyme.find("#reaction-products")[0].selectize;
            var enabled = dialog_enzyme.find("#enabled");
            var constrained = dialog_enzyme.find("#constrained");
            var constrained_min = dialog_enzyme.find("#constrained-min");
            var constrained_max = dialog_enzyme.find("#constrained-max");
            var pathway = dialog_enzyme.find("#reaction-pathway")[0].selectize;

            substrates.clear();
            products.clear();
            pathway.clear();

            substrates.clearOptions();
            products.clearOptions();
            pathway.clearOptions();

            Metabolite.metabolites.forEach(function(obj) {
                substrates.addOption({"id": obj.name, item: {obj: obj, amount: 1}});
                products.addOption({"id": obj.name, item: {obj: obj, amount: 1}});
            });
            substrates.refreshOptions();
            products.refreshOptions();

            var pathways = Enzyme.getPathways();
            for (var i = 0; i < pathways.length; ++i) {
                pathway.addOption({"text": pathways[i]});
            }
            pathway.refreshOptions();

            for (var i = 0; i < enzyme.substrates.length; ++i) {
                var substrate = enzyme.substrates[i];
                substrates.options[substrate.name].item.amount = substrate.stoichiometry;
                substrates.addItem(substrate.name);
            }
            for (i = 0; i < enzyme.products.length; ++i) {
                var product = enzyme.products[i];
                products.options[product.name].item.amount = product.stoichiometry;
                products.addItem(product.name);
            }

            substrates.refreshItems();
            products.refreshItems();
            pathway.addItem(enzyme.pathway);
            pathway.refreshItems();

            enabled.prop("checked", !enzyme.disabled || create_new);

            constrained.prop("checked", enzyme.isConstrained());
            constrained_min.val(enzyme.constraints[0]);
            constrained_max.val(enzyme.constraints[1]);

            if (enzyme.isConstrained()) {
                constraints_div.show();
            } else {
                constraints_div.hide();
            }

            dialog_enzyme.find("div").removeClass("has-error");
            dialog_enzyme.find(".help-block").remove();

            dialog_enzyme.modal("show");
        }

        function showAddMetaboliteDialog() {
            dialog_metabolite_add.find("div").removeClass("has-error");
            dialog_metabolite_add.find(".help-block").remove();
            dialog_metabolite_add.find("#add-metabolite-name").val("New Metabolite");
            dialog_metabolite_add.find("#add-external").prop("checked", false);
            dialog_metabolite_add.modal("show");
        }

        function showEditMetaboliteDialog(item) {
            dialog_metabolite_edit.find("div").removeClass("has-error");
            dialog_metabolite_edit.find(".help-block").remove();
            dialog_metabolite_edit.find("#metabolite-name").val(item.name);
            dialog_metabolite_edit.find("#external").prop("checked", item.external);
            dialog_metabolite_edit.data("object", item);
            dialog_metabolite_edit.modal("show");
        }

        function saveEnzyme(enzyme) {
            var name = dialog_enzyme.find("#enzyme-name");
            var reversible = dialog_enzyme.find("#reversible");
            var enabled = dialog_enzyme.find("#enabled");
            var constrained = dialog_enzyme.find("#constrained");
            var constrained_min = dialog_enzyme.find("#constrained-min");
            var constrained_max = dialog_enzyme.find("#constrained-max");
            var substrates = dialog_enzyme.find("#reaction-substrates")[0].selectize;
            var products = dialog_enzyme.find("#reaction-products")[0].selectize;
            var pathway = dialog_enzyme.find("#reaction-pathway");

            var old_design_objective = design_objective;

            var visible_value = undefined;
            if (design_objective_visible_combobox[0].selectize.getValue().split('\x00').indexOf(enzyme.name) > -1) {
                visible_value = enzyme;
            }
            cyano_design_objective_select[0].selectize.removeOption(enzyme.name);
            design_objective_visible_combobox[0].selectize.removeOption(enzyme.name);

            enzyme.name = name.val();

            cyano_design_objective_select[0].selectize.addOption(enzyme);
            cyano_design_objective_select[0].selectize.refreshOptions();
            design_objective_visible_combobox[0].selectize.addOption(enzyme);
            design_objective_visible_combobox[0].selectize.refreshOptions();

            if (visible_value !== undefined) {
                design_objective_visible_combobox[0].selectize.addItem(visible_value.name);
            }

            if (old_design_objective !== undefined) {
                cyano_design_objective_select[0].selectize.setValue(old_design_objective.name, false);
            }

            enzyme.reversible = reversible.prop("checked");
            if (constrained.prop("checked")) {
                enzyme.constraints[0] = constrained_min.val();
                enzyme.constraints[1] = constrained_max.val();
            } else {
                enzyme.makeUnconstrained();
            }

            enzyme.disabled = !enabled.prop("checked");

            enzyme.substrates = [];
            enzyme.products = [];

            substrates.getValue().split('\x00').forEach(function(a) {
                enzyme.substrates.push({"name": a, "stoichiometry": substrates.options[a].item.amount});
            });

            products.getValue().split('\x00').forEach(function(a) {
                enzyme.products.push({"name": a, "stoichiometry": products.options[a].item.amount});
            });

            enzyme.pathway = pathway.val();

            enzyme.updateMetaboliteReference().forEach(function(m) {
                m.invalidate();
            });
            enzyme.invalidate();
        }

        dialog_enzyme.on('shown.bs.modal', function() {
            dialog_enzyme.find("input").blur();

            dialog_enzyme.find("#reaction-substrates")[0].selectize.close();
            dialog_enzyme.find("#reaction-products")[0].selectize.close();

            var val = dialog_enzyme.find("#enzyme-name").val();
            // move cursor to end
            dialog_enzyme.find("#enzyme-name").focus().val("").val(val);
        });

        dialog_metabolite_add.on('shown.bs.modal', function() {
            var val = dialog_metabolite_add.find("#add-metabolite-name").val();
            dialog_metabolite_add.find("#add-metabolite-name").focus().val("").val(val);
        });

        dialog_metabolite_edit.on('shown.bs.modal', function() {
            var val = dialog_metabolite_edit.find("#metabolite-name").val();
            dialog_metabolite_edit.find("#metabolite-name").focus().val("").val(val);
        });

        dialog_enzyme.find(".btn-primary").click(function() {
            var name = dialog_enzyme.find("#enzyme-name");
            var constrained = dialog_enzyme.find("#constrained");
            var constrained_min = dialog_enzyme.find("#constrained-min");
            var constrained_max = dialog_enzyme.find("#constrained-max");
            var substrates = dialog_enzyme.find("#reaction-substrates");
            var substrates_sel = substrates[0].selectize;
            var products = dialog_enzyme.find("#reaction-products");
            var products_sel = products[0].selectize;
            var create_new_enzyme = dialog_enzyme.data("create");

            var bValid = true;

            var numeric = /^\-?[0-9]+$/;

            dialog_enzyme.find("div").removeClass("has-error");
            dialog_enzyme.find(".help-block").remove();

            for (var i = 0; i < Enzyme.enzymes.length; ++i) {
                var enz = Enzyme.enzymes[i];

                if (enz === dialog_enzyme.data("object")) {
                    continue;
                }

                if (name.val() == enz.name) {
                     bValid &= checkBool(name, enz === dialog_enzyme.data("object"), "Name already in use");
                }
            }

            bValid &= checkRegexp(name, /^[^:]+$/, "Name must not contain a colon (:)");
            bValid &= checkLength(name, "Name", 1, 100);

            if (constrained.prop("checked")) {
                var cmin_float = isFinite(parseFloat(constrained_min.val()));
                var cmax_float = isFinite(parseFloat(constrained_max.val()));
                bValid &= checkBool(constrained_min, cmin_float, "Min constraint must be numeric");
                bValid &= checkBool(constrained_max, cmax_float, "Max constraint must be numeric");
                if (bValid) {
                    bValid &= checkBool(constrained_min, parseFloat(constrained_min.val()) <= parseFloat(constrained_max.val()), "Min constraint > Max constraint");
                }
            }

            if (substrates_sel.getValue().length > 0) {
                substrates_sel.getValue().split('\x00').forEach(function (a) {
                    var is_float = isFinite(parseFloat(substrates_sel.options[a].item.amount));
                    bValid &= checkBool(substrates, is_float, "Stoichiometry must be numeric");
                });
            } else {
                bValid &= checkBool(substrates, substrates_sel.getValue().length > 0, "No substrates defined");
            }

            if (products_sel.getValue().length > 0) {
                products_sel.getValue().split('\x00').forEach(function (a) {
                    var is_float = isFinite(parseFloat(products_sel.options[a].item.amount));
                    bValid &= checkBool(products, is_float, "Stoichiometry must be numeric");
                });
            } else {
                bValid &= checkBool(products, products_sel.getValue().length > 0, "No products defined");
            }

            if (bValid) {
                var reaction = dialog_enzyme.data("object");
                var old_name = reaction.name;

                var old_pathway = reaction.pathway;
                saveEnzyme(reaction);
                reaction.convertToFloat();

                var command = {
                    "type": "reaction",
                    "name": old_name,
                    "object": jQuery.extend(true, {}, reaction)
                };

                if (create_new_enzyme) {
                    Enzyme.enzymes.push(reaction);

                    datatable_enzymes.row.add(reaction);
                    datatable_enzymes.sort();
                    datatable_enzymes.draw();

                    command["op"] = "add";
                    command["name"] = reaction.name;

                    command_list.push(command);
                } else {
                    command["op"] = "edit";

                    command_list.push(command);

                    if (old_pathway != reaction.pathway) {
                        datatable_enzymes.draw();
                    }
                }

                dialog_enzyme.modal("hide");
            }
        });

        dialog_metabolite_add.find(".btn-primary").click(function() {
            var name = dialog_metabolite_add.find("#add-metabolite-name");
            var external = dialog_metabolite_add.find("#add-external");

            var valid = checkLength(name, "Name", 1, 100);
            valid &= !checkRegexp(name, /(^[0-9])/, "Name must not begin with a number");
            valid &= !checkRegexp(name, /(^<?\-> | <?\-> | <?\->$)/, "Name must not contain lonely <-> or ->");
            valid &= !checkRegexp(name, /(^\+ | \+ )/, "Lonely + only allowed at end of name");

            var met_idx = Metabolite.indexByName(name.val());

            if (met_idx != -1) {
                valid = checkBool(name, false, "Name already in use");
            }

            if (valid) {
                var metabolite = new Metabolite(name.val(), external.prop("checked"));
                Metabolite.metabolites.push(metabolite);

                command_list.push({
                    "type": "metabolite",
                    "op": "add",
                    "name": metabolite.name,
                    "object": {
                        "name": metabolite.name,
                        "external": metabolite.external
                    }
                });

                datatable_metabolites.row.add(metabolite);
                datatable_metabolites.sort();
                datatable_metabolites.draw();

                dialog_metabolite_add.modal("hide");
            }
        });

        dialog_metabolite_edit.find(".btn-primary").click(function() {
            var name = dialog_metabolite_edit.find("#metabolite-name");
            var external = dialog_metabolite_edit.find("#external");

            var valid = checkLength(name, "Name", 1, 100);
            valid &= !checkRegexp(name, /(^[0-9])/, "Name must not begin with a number");
            valid &= !checkRegexp(name, /(^<?\-> | <?\-> | <?\->$)/, "Name must not contain lonely <-> or ->");
            valid &= !checkRegexp(name, /(^\+ | \+ )/, "Lonely + only allowed at end of name");

            var met_idx = Metabolite.indexByName(name.val());

            if (met_idx != -1) {
                valid &= checkBool(name, Metabolite.metabolites[met_idx] === dialog_metabolite_edit.data("object"), "Name already in use");
            }

            if (valid) {
                var metabolite = dialog_metabolite_edit.data("object");
                var old_name = metabolite.name;
                metabolite.updateName(name.val());
                var old_external = metabolite.external;
                metabolite.external = external.prop("checked");

                if (old_name != metabolite.name || old_external != metabolite.external) {
                    command_list.push({
                        "type": "metabolite",
                        "op": "edit",
                        "name": old_name,
                        "object": {
                            "name": metabolite.name,
                            "external": metabolite.external
                        }
                    });
                }

                metabolite.invalidate();

                dialog_metabolite_edit.modal("hide");
            }
        });

        // First col
        table_enzymes.delegate('tr td:first-child', 'click', function() {
            var tr = $(this).closest("tr");
            if (tr.hasClass("group")) {
                return;
            }
            var row = datatable_enzymes.row(tr);

            showEditEnzymeDialog(row.data(), false);
        });

        // Metabolite in 2nd
        table_enzymes.on("click", ".cyano-metabolite", function(event) {
            var met = Metabolite.indexByName($(this).text());
            if (met >= 0) {
                showEditMetaboliteDialog(Metabolite.metabolites[met]);
            }
        });

        // Enabled in 4th col
        table_enzymes.delegate('tr td:nth-child(4) input', 'change', function() {
            var row = datatable_enzymes.row($(this).closest("tr"));

            row.data().disabled = !($(this).is(":checked"));

            command_list.push({
                "type": "reaction",
                "op": "edit",
                "name": row.data().name,
                "object": {
                    "name": row.data().name,
                    "disabled": row.data().disabled
                }
            });

            row.data().invalidate();
        });

        // First col
        table_metabolites.delegate('tr td:first-child', 'click', function() {
            var row = datatable_metabolites.row($(this).closest("tr"));

            showEditMetaboliteDialog(row.data());
        });

        // 4th col
        table_metabolites.delegate('tr td:nth-child(4) input', 'change', function() {
            var row = datatable_metabolites.row($(this).closest("tr"));

            row.data().external = $(this).is(":checked");

            command_list.push({
                "type": "metabolite",
                "op": "edit",
                "name": row.data().name,
                "object": {
                    "name": row.data().name,
                    "external": row.data().external
                }
            });

            row.data().invalidate();
        });

        // Enzyme in 2nd or 3rd col
        table_metabolites.on("click", ".cyano-enzyme", function(event) {
            var enzyme = Enzyme.indexByName($(this).text());
            if (enzyme >= 0) {
                showEditEnzymeDialog(Enzyme.enzymes[enzyme], false);
            }
        });

        table_metabolites.on({
            mouseenter: function () {
                $(this).data("toggle", "tooltip");
                $(this).data("placement", "top");

                var enzyme = Enzyme.indexByName($(this).text());
                if (enzyme == -1) {
                    var text = "Error!";
                } else {
                    var text = Enzyme.enzymes[enzyme].reactionToString();
                }

                $(this).prop("title", text);
                $(this).tooltip("show");
            },
            mouseleave: function () {
            }
        }, ".cyano-enzyme");
        $(".create-enzyme-button").click(function (event) {
            showAddEnzymeDialog();
        });
        $(".create-metabolite-button").click(function (event) {
            showAddMetaboliteDialog();
        });

        $(".delete-metabolites-button").click(function (event) {
            $("#dialog-delete-metabolites").modal('show');
        });

        $("#dialog-delete-metabolites").find(".btn-primary").click(function() {
            Metabolite.metabolites.filter(function(m) {
                return m.isUnused();
            }).forEach(function(m) {
                m.remove();
                m.removeFromList();

                command_list.push({
                    "type": "metabolite",
                    "op": "delete",
                    "name": m.name,
                    "object": {}
                });
            });
            datatable_metabolites.draw();

            $("#dialog-delete-metabolites").modal("hide");
        });

        $(".cyano-design-reactions").on("click", ".cyano-design-reaction", function() {
            var index = enzymes_design.indexOf(getEnzymeByName($(this).text()));
            if (index > -1) {
                enzymes_design.splice(index, 1);
            }
            updateEnzymeDesignList();
        });
        dialog_enzyme.on("click", "div.cyano-metabolite", function(event) {
            var item = $(event.target).data("object");
            saveEnzyme(dialog_enzyme.data("object"));
            dialog_metabolite_edit.find("input.name").val(item.name);
            dialog_metabolite_edit.find("#external").prop("checked", item.external);
            dialog_metabolite_edit.data("object", item);

            dialog_metabolite_edit.dialog("open");
        });
        dialog_enzyme.find("#constrained:checkbox").change(function() {
            if ($(this).is(":checked")) {
                constraints_div.show();
            } else {
                constraints_div.hide();
            }
        });

        $("#auto_flux").prop("checked", true);
        $(".cyano-design-reaction-filter").hide();
        $("#auto_flux").change(function() {
            $(".cyano-design-reaction-filter").hide();
        });
        $("#manual_flux").change(function() {
            $(".cyano-design-reaction-filter").show();
        });

        // delete button clicked
        datatable_enzymes.on("click", ".delete-button", function(event) {
            var parent = $(this).closest("tr");
            var dialog_delete = $("#dialog-delete");
            var row = datatable_enzymes.row(parent);

            dialog_delete.data("parent", parent);
            dialog_delete.find(".reaction-name").text(row.data().name);
            dialog_delete.modal('show');
        });

        $("#dialog-delete").find(".btn-primary").click(function () {
            var dialog_delete = $("#dialog-delete");

            var reaction = datatable_enzymes.row(dialog_delete.data("parent")).data();
            var rmets = reaction.getMetabolites();
            var del_mets = dialog_delete.find("input").prop("checked");
            reaction.remove();

            command_list.push({
                "op": "delete",
                "type": "reaction",
	            "name": reaction.name,
                "object": {}
            });

            rmets.filter(function(m) {
                m.invalidate();
                return del_mets && m.isUnused();
            }).forEach(function(m) {
                m.remove();
                m.removeFromList();

                command_list.push({
                    "type": "metabolite",
                    "op": "delete",
                    "name": m.name,
                    "object": {}
                });
            });

            cyano_design_objective_select[0].selectize.removeOption(reaction.name);
            design_objective_visible_combobox[0].selectize.removeOption(reaction.name);

            datatable_metabolites.draw();

            dialog_delete.modal("hide");

            dialog_delete.data("parent").fadeOut(200, function() { datatable_enzymes.row(this).remove().draw(); });
        });

        cyano_design_objective_select.selectize({
            delimiter: ',',
            labelField: "name",
            valueField: "name",
            sortField: "name",
            searchField: ["name"],
            onChange: function(value) {
                var idx = Enzyme.indexByName(value);
                if (idx >= 0) {
                    design_objective = Enzyme.enzymes[idx];
                } else {
                    design_objective = undefined;
                }
            }
        });

        design_objective_visible_combobox.selectize({
            delimiter: '\x00',
            labelField: "name",
            valueField: "name",
            searchField: ["name"],
            plugins: ['drag_drop', 'remove_button', 'restore_on_backspace'],
            maxItems: 20
        });

        dialog_enzyme.find("#reaction-pathway").selectize({
            labelField: "text",
            valueField: "text",
            sortField: "text",
            searchField: ["text"],
            create: true
        });

        $.ajax({
            url: "{% url "cyano-design-get-reactions" pk=pk %}{% if revision %}?revision={{ revision.pk }}{% endif %}",
            context: document.body,
            beforeSend: function() {
                waitIndicator.show($("#content"));
            }
        }).done(function(x) {
            Metabolite.fromList(x["metabolites"]);
            Enzyme.fromList(x["reactions"]);

            updateEnzymeList();
            updateMetabolitesList();

            $("#radio-maximize").prop("checked", true);

            if (x.objectives && x.objectives.length > 0) {
                cyano_design_objective_select[0].selectize.setValue(x.objectives[0].name);
                if (x.objectives[0].maximize == false) {
                    $("#radio-minimize").prop("checked", true);
                }
            }

            waitIndicator.hide($("#content"));
        });

        table_enzymes.css("width", "");
        table_metabolites.css("width", "");

        var isDragging = false;

        $("#visual").on("click", "g.node", function() {
            var idx = Metabolite.indexByName($(this).children("text").text());
            if (!isDragging & idx > -1) {
                showEditMetaboliteDialog(Metabolite.metabolites[idx]);
            }
        });

        $("#visual").on("click", "g.edge text", function() {
            // remove flux value
            var idx = Enzyme.indexByName($(this).text().replace(/ \(-?[0-9]+(\.[0-9]+)?\)$/, ""));
            if (!isDragging & idx > -1) {
                showEditEnzymeDialog(Enzyme.enzymes[idx], false);
            }
        });

        $("#visual").on("mousedown", "g", function(event) {
            isDragging = false;
            $(this).data('page', {x: event.pageX, y: event.pageY})
        });
        $("#visual").on("mousemove", "g", function(event) {
            var p = $(this).data('page');
            if (p !== undefined) {
                if (Math.abs(p.x - event.pageX) > 4 ||
                    Math.abs(p.y - event.pageY) > 4) {
                    isDragging = true;
                }
            }
        });

        $("#enzyme_regex").click(function() {
            datatable_enzymes.search("", $(this).prop("checked"), true).draw();
        });

        $("#metabolite_regex").click(function() {
            datatable_metabolites.search("", $(this).prop("checked"), true).draw();
        });
    });
</script>

<script id="filter_row" type="text/plain">
<div class="col-sm-6">
<label for="cyano-enzyme-list-filter-reactions">Filter reactions</label>
<select id="cyano-enzyme-list-filter-reactions" class="form-control combobox" multiple="multiple">
    <optgroup label="Enabled">
    <option selected="selected">Active</option>
    <option selected="selected">Inactive</option>
    </optgroup>
    <optgroup label="Constraints">
    <option selected="selected">Constraint</option>
    <option selected="selected">Unconstraint</option>
    </optgroup>
    <optgroup label="Reversible">
    <option selected="selected">Reversible</option>
    <option selected="selected">Irreversible</option>
    </optgroup>
</select>
</div>
<div class="col-sm-6">
    <div class="dataTables_filter">
    <div class="checkbox">
    <input id="enzyme_regex" type="checkbox">
    <label for="enzyme_regex">Search with RegExp</label>
    </div>
    </div>
</div>
</script>

<script id="filter_row_metabolites" type="text/plain">
<div class="col-sm-6">
<label for="cyano-metabolite-list-filter-reactions">Filter metabolites</label>
<select id="cyano-metabolite-list-filter-reactions" class="form-control combobox" multiple="multiple">
    <option selected="selected">Is internal</option>
    <option selected="selected">Is external</option>
</select>
</div>
<div class="col-sm-6">
    <div class="dataTables_filter">
    <div class="checkbox">
    <input id="metabolite_regex" type="checkbox">
    <label for="metabolite_regex">Search with RegExp</label>
    </div>
    </div>
</div>
</script>
{% endblock %}

{% block extrastyles %}
span.cyano-external-metabolite { color: green }

#cyano-metabolite-list tr td:first-child,
#cyano-enzyme-list tr td:first-child {
    font-weight: bold;
}

.hoverable,
#cyano-metabolite-list .cyano-enzyme,
#cyano-metabolite-list tr td:first-child,
#cyano-enzyme-list tr td:first-child,
#cyano-enzyme-list .cyano-metabolite,
svg g.node,
svg text
{
    cursor: pointer;
}
.hoverable:hover,
#cyano-metabolite-list .cyano-enzyme:hover,
#cyano-metabolite-list tr td:first-child:hover,
#cyano-enzyme-list tr.odd td:first-child:hover,
#cyano-enzyme-list tr.even td:first-child:hover,
#cyano-enzyme-list .cyano-metabolite:hover
{
    color: blue;
}

.cyano-enzyme-disabled
{
    color: grey;
}

#submit-form
{
    display: none;
}

.tab-content
{
    margin-top: 5px;
    margin-bottom: 5px;
}
{% endblock %}

{% block content %}

{% if revision %}
<div class="alert alert-info" role="alert">
Viewing old model from {{ revision.date }}. Simulating and saving will be based on this old version of the model.
</div>
{% endif %}

<div role="tabpanel">

<ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#reaction-tab" role="tab" data-toggle="tab">Reactions</a></li>
    <li role="presentation"><a href="#metabolite-tab" role="tab" data-toggle="tab">Metabolites</a></li>
    <li role="presentation"><a href="#settings-tab" role="tab" data-toggle="tab">Settings</a></li>
    <li role="presentation"><a href="#simulation-tab" role="tab" data-toggle="tab">Simulation</a></li>
</ul>

<div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="reaction-tab">
        <table id="cyano-enzyme-list" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Reaction</th>
                    <th>Constraint</th>
                    <th>Active</th>
                    <th></th>
                </tr>
            </thead>
        </table>

        <button type="button" class="btn btn-primary create-enzyme-button">
        Create new reaction
        </button>
        <button type="button" class="btn btn-primary create-metabolite-button">
        Create new metabolite
        </button>
    </div>
    <div role="tabpanel" class="tab-pane" id="metabolite-tab">
        <table id="cyano-metabolite-list" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Consumed by</th>
                    <th>Produced by</th>
                    <th>Is External</th>
                </tr>
            </thead>
        </table>

        <button type="button" class="btn btn-primary create-enzyme-button">
        Create new reaction
        </button>
        <button type="button" class="btn btn-primary create-metabolite-button">
        Create new metabolite
        </button>
        <button type="button" class="btn btn-danger delete-metabolites-button">
        Delete unused metabolites
        </button>
    </div>

    <div role="tabpanel" class="tab-pane" id="settings-tab">
        <div class="cyano-design-objective">
            <fieldset>
                <div class="form-group">
                    <label class="control-label" for="cyano-design-objective-select">Main objective</label>
                    <select id="cyano-design-objective-select" placeholder="Select a main objective"></select>
                </div>

               <div class="radio">
                    <input type="radio" name="maxmingroup" id="radio-maximize" value="maximize-obj">
                    <label for="radio-maximize">
                        Maximize objective
                    </label>
                </div>
                <div class="radio">
                    <input type="radio" name="maxmingroup" id="radio-minimize" value="minimize-obj">
                    <label for="radio-minimize">
                        Minimize objective
                    </label>
                </div>
            </fieldset>
        </div>

        <div>
            The main objective is always displayed in the simulation.
        </div>

        <div>
            <div class="radio">
                <input id="auto_flux" type="radio" name="flux" value="auto_flux">
                <label for="auto_flux">Display reactions with highest flux connected to the objective</label>
            </div>
            <div class="radio">
                <input id="manual_flux" type="radio" name="flux" value="manual_flux">
                <label for="manual_flux">Display selected reactions</label>
            </div>
        </div>

        <div class="cyano-design-reaction-filter">
            <fieldset>
                <div class="form-group">
                    <label class="control-label" for="design-objective-visible-combobox">Select visible reactions</label>
                    <input id="design-objective-visible-combobox">
                </div>
            </fieldset>
        </div>
    </div>

    <div role="tabpanel" class="tab-pane" id="simulation-tab">
        <button type="button" id="design-submit" class="btn btn-primary">Run simulation</button>
        <div id="export-button" class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
            Export <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" role="menu">
            <li><a id="export-csv" href="#">As flux list</a></li>
            <li><a id="export-png" href="#">As image</a></li>
            <li><a id="export-svg" href="#">As vector graphic</a></li>
            </ul>
        </div>

        <div id="simulation-result">
        </div>
        <div id="visual">

        </div>
    </div>
</div>
</div>

<!-- Modal -->
<div class="modal fade" id="dialog-reaction" tabindex="-1" role="dialog" aria-labelledby="dialog-reaction-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-reaction-label">Edit Reaction</h4>
            </div>
            <div class="modal-body">
                <form>
                    <fieldset>
                        <div class="form-group">
                            <label class="control-label" for="enzyme-name">Name</label>
                            <input class="form-control" type="text" id="enzyme-name">
                        </div>
                        <div class="form-group">
                            <label for="reaction-pathway">Pathway</label>
                            <select id="reaction-pathway" placeholder="Select or enter pathway"></select>
                        </div>
                        <div class="form-group">
                            <label for="reaction-substrates">Substrates</label>
                            <input id="reaction-substrates" type="text">
                        </div>
                        <div class="form-group">
                            <label for="reaction-products">Products</label>
                            <input id="reaction-products" type="text">
                        </div>
                        <div class="checkbox">
                            <input type="checkbox" name="enabled" id="enabled">
                            <label for="enabled">Enabled</label>
                        </div>
                        <div class="checkbox">
                            <input type="checkbox" name="reversible" id="reversible">
                            <label for="reversible">Reversible</label>
                        </div>
                        <div class="checkbox">
                            <input type="checkbox" name="constrained" id="constrained">
                            <label for="constrained">Constrained</label>
                        </div>
                        <div id="constraints-min-max" class="form-inline">
                            <div class="form-group">
                                <label class="control-label" for="constrained-min">Min</label>
                                <input name="constrained_min" id="constrained-min" class="form-control" type="text">
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="constrained-max">Max</label>
                                <input name="constrained_max" id="constrained-max" class="form-control" type="text">
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary">Save changes</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="dialog-add-metabolite" tabindex="-1" role="dialog" aria-labelledby="dialog-add-metabolite-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-add-metabolite-label">Create Metabolite</h4>
            </div>
            <div class="modal-body">
                <form>
                    <fieldset>
                        <div class="form-group">
                            <label for="add-metabolite-name">Name</label>
                            <input type="text" id="add-metabolite-name" class="form-control">
                        </div>

                        <div class="checkbox">
                            <input type="checkbox" id="add-external">
                            <label for="add-external">External</label>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary">Create</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="dialog-edit-metabolite" tabindex="-1" role="dialog" aria-labelledby="dialog-edit-metabolite-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-edit-metabolite-label">Edit Metabolite</h4>
            </div>
            <div class="modal-body">
                <form>
                    <fieldset>
                        <p>The metabolite is modified in all reactions.</p>

                        <div class="form-group">
                            <label for="metabolite-name">Name</label>
                            <input type="text" id="metabolite-name" class="form-control">
                        </div>

                        <div class="checkbox">
                            <input type="checkbox" id="external">
                            <label for="external">External</label>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary">Save changes</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="dialog-delete" tabindex="-1" role="dialog" aria-labelledby="dialog-delete-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-delete-label">Delete <span class="reaction-name"></span></h4>
            </div>
            <div class="modal-body">
                Do you really want to delete reaction <span class="reaction-name"></span>?

                <div class="form-group">
                <div class="checkbox">
                    <input id="dialog-delete-unused-metabolites" type="checkbox">
                    <label for="dialog-delete-unused-metabolites">Delete unused metabolites</label>
                </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-danger">Delete</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="dialog-delete-metabolites" tabindex="-1" role="dialog" aria-labelledby="dialog-delete-metabolites-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-delete-metabolites-label">Delete unused metabolites</h4>
            </div>
            <div class="modal-body">
                Do you really want to delete all unused metabolites?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-danger">Delete</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="dialog-save-model" tabindex="-1" role="dialog" aria-labelledby="dialog-save-model-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            {% crispy save_form %}
        </div>
    </div>
</div>

<div class="modal fade" id="dialog-saveas-model" tabindex="-1" role="dialog" aria-labelledby="dialog-saveas-model-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            {% crispy saveas_form %}
        </div>
    </div>
</div>


<input type="submit" id="design-save" class="btn btn-primary" value="Save">
<input type="submit" id="design-saveas" class="btn btn-primary" value="Save As">

<form method="post" action="{% url "cyano-design-simulate" pk=pk %}" id="submit-form">
{% csrf_token %}
</form>

{% endblock %}
