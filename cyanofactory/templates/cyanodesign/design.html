{% extends "cyano/base.html" %}

{% comment %}
Cyanodesign index page

Copyright (c) 2013 Gabriel Kind <gkind@hs-mittweida.de>
Hochschule Mittweida, University of Applied Sciences

Released under the MIT license
{% endcomment %}

{% load static %}
{% load staticfiles %}
{% load templatetags %}
{% load filters %}
{% load crispy_forms_tags %}

{% block head_title %}{{ block.super }} :: WeDesign{% endblock %}
{% block page_title %}WeDesign &ndash; {{ name }}{% endblock %}
{% block head %}
{{ block.super }}
<script src="{% get_static_prefix %}cyanodesign/js/d3.v3.js"></script>
<link href="{% get_static_prefix %}cyanodesign/css/c3.css" rel="stylesheet" type="text/css">
<script src="{% get_static_prefix %}cyanodesign/js/c3.js"></script>
<script async src="{% get_static_prefix %}cyanodesign/js/viz.js"></script>
<script type="text/javascript" src="{% get_static_prefix %}boehringer/js/svg-pan-zoom.js"></script>
<script src="{% get_static_prefix %}/cyanodesign/node_modules/requirejs/require.js"
        data-main="{% get_static_prefix %}cyanodesign/js/main"></script>
<!--<script src="{% get_static_prefix %}cyanodesign/js/metabolic_model.js"></script>-->
<script src="{% get_static_prefix %}cyanodesign/js/mba_chart.js"></script>

<script type="text/javascript">
    "use strict";

    var MetabolicModel = undefined;
    var app = undefined;
    var startup = undefined;
    var revision = {% if revision %}{{ revision.pk }}{% else %}undefined{% endif %};

    /*Enzyme.prototype.invalidate = function() {
        this.getMetabolites().forEach(function (obj) {
            datatable_metabolites.row(model.metabolites.indexOf(obj)).invalidate();
        });

        datatable_enzymes.row(model.reactions.indexOf(this)).invalidate();
    };

    Enzyme.prototype.removeFromList = function() {
        var that = this;
        datatable_enzymes.row(function(idx, data, node) {
            return data.name == that.name;
        }).remove();
    };

    Metabolite.prototype.invalidate = function() {
        this.getEnzymes().forEach(function (obj) {
            datatable_enzymes.row(model.reactions.indexOf(obj)).invalidate();
        });

        datatable_metabolites.row(model.metabolites.indexOf(this)).invalidate();
    };

    Metabolite.prototype.removeFromList = function() {
        var that = this;
        datatable_metabolites.row(function(idx, data, node) {
            return data.name == that.name;
        }).remove();
    };*/


    $(function () {
        $($("#filter_row_flux").text()).appendTo($("#cyano-flux-list_wrapper").children()[1]);

        /*$.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                if (settings.nTable == table_flux[0]) {
                    var min = parseFloat($("#filter-flux-min").val());
                    var max = parseFloat($("#filter-flux-max").val());

                    var d = datatable_flux.data()[dataIndex];

                    // Check flux values
                    if (!isNaN(min) && d[1] < min) {
                        return false;
                    }

                    if (!isNaN(max) && d[1] > max) {
                        return false;
                    }

                    return true;
                }

                return true;
            }
        );*/


        $($("#filter_row").text()).appendTo($("#cyano-enzyme-list_wrapper").children()[1]);

        $("#cyano-enzyme-list-filter-reactions").multiselect({
            buttonClass: 'btn btn-default btn-xs',
            onChange: function(option, checked, select) {
                datatable_enzymes.draw();
            },
            buttonText: function(options, select) {
                if (options.length === 0) {
                    return 'No option selected';
                }
                else if (options.length === 6) {
                    return 'No filter applied';
                }
                else {
                    var labels = [];
                    var prev = undefined;

                    options.each(function() {
                        if (prev !== undefined) {
                            if (prev.index % 2 == 1) {
                                labels.push("AND");
                            } else {
                                if (this.index - 1 == prev.index) {
                                    labels.push("OR");
                                } else {
                                    labels.push("AND");
                                }
                            }
                        }

                        labels.push($(this).html());

                        prev = this;
                    });
                    return labels.join(' ') + '';
                }
            }
        });

        // Order by the grouping
        /*table_enzymes.delegate('tr.group', 'click', function() {
            var currentOrder = datatable_enzymes.order()[0];
            if ( currentOrder[0] === 2 && currentOrder[1] === 'asc' ) {
                datatable_enzymes.order( [ 5, 'desc' ] ).draw();
            }
            else {
                datatable_enzymes.order( [ 5, 'asc' ] ).draw();
            }
        } );*/

        /*$.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                if (settings.nTable == table_enzymes[0]) {
                    var arr = $("#cyano-enzyme-list-filter-reactions").find("option").map(function () {
                        return this.selected;
                    }).get();

                    var d = datatable_enzymes.data()[dataIndex];
                    var f = reaction_filter;

                    if (!(arr[0] || arr[1]) || !(arr[2] || arr[3]) || !(arr[4] || arr[5])) {
                        return false;
                    }

                    return ((arr[0] ? f[0](d) : !f[0](d)) || (arr[1] ? f[1](d) : !f[1](d))) &&
                            ((arr[2] ? f[2](d) : !f[2](d)) || (arr[3] ? f[3](d) : !f[3](d))) &&
                            ((arr[4] ? f[4](d) : !f[4](d)) || (arr[5] ? f[5](d) : !f[5](d)));
                }

                return true;
            }
        );*/

        $($("#filter_row_metabolites").text()).appendTo($("#cyano-metabolite-list_wrapper").children()[1]);

        $("#cyano-metabolite-list-filter-reactions").multiselect({
            buttonClass: 'btn btn-default btn-xs',
            onChange: function(option, checked, select) {
                datatable_metabolites.draw();
            },
            buttonText: function(options, select) {
                if (options.length === 0) {
                    return 'No option selected';
                }
                else if (options.length === 2) {
                    return 'No filter applied';
                }
                else {
                    var labels = [];

                    options.each(function() {
                        labels.push($(this).html());
                    });
                    return labels.join(' ') + '';
                }
            }
        });

        /*$.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                if (settings.nTable == table_metabolites[0]) {
                    var arr = $("#cyano-metabolite-list-filter-reactions").find("option").map(function () {
                        return this.selected;
                    }).get();

                    var d = datatable_metabolites.data()[dataIndex];
                    var f = metabolite_filter;

                    if (!(arr[0] || arr[1])) {
                        return false;
                    }

                    return ((arr[0] ? f[0](d) : !f[0](d)) || (arr[1] ? f[1](d) : !f[1](d)));
                }

                return true;
            }
        );*/

        $( ".check" ).button();

        var selectize_options = {
            valueField: 'id',
            searchField: ['id'],
            delimiter: '\x00', // impossible delimiter,
            plugins: ['drag_drop', 'remove_button', 'restore_on_backspace'],
            render: {
                option: function(item, escape) {
                    return $("<div>").addClass("option").text(item.id).wrap("<p>").parent().html();
                },
                item: function(item, escape) {
                    if (typeof item.item === "undefined") {
                        // workaround firefox remembering old input
                        return "<div></div>";
                    }
                    var amount = item.item.amount;
                    return $("<div>").addClass("item").attr("data-type", "text").attr("data-item", item.id).text(amount + " " + item.id).wrap("<p>").parent().html();
                }
            }
        };

        var item_add = function(elements) {
            return function(value, item) {
                item.data("dialog", elements);
                item.data("value", elements.selectize.options[value].item.amount);
                item.editable({
                    type: "text",
                    container: dialog_enzyme[0],
                    title: "Enter amount",
                    unsavedclass: null,
                    success: function (response, newValue) {
                        if (!isFinite(newValue)) {
                            return "Not a number";
                        }

                        var sel;
                        sel = elements.selectize;
                        sel.options[$(this).data("item")].item.amount = newValue;
                        // no this doesn't rerender selected items only flushes render cache...
                        sel.clearCache("item");
                        // readd items
                        // braindead api returns delimited string in get but expects array in set m(
                        sel.setValue(sel.getValue().split('\x00').map(function (a) {
                            return a;
                        }));
                        return {"newValue": newValue};
                    }
                });
            };
        };

        /*selectize_options["onItemAdd"] = item_add(dialog_enzyme.find("#reaction-substrates")[0]);
        dialog_enzyme.find("#reaction-substrates").selectize(selectize_options);
        dialog_enzyme.find("#reaction-products").text("");
        selectize_options["onItemAdd"] = item_add(dialog_enzyme.find("#reaction-products")[0]);
        dialog_enzyme.find("#reaction-products").selectize(selectize_options);

        dialog_enzyme.find("#reaction-substrates").editable();*/

        // Array Remove - By John Resig (MIT Licensed)
        Array.prototype.remove = function(from, to) {
          var rest = this.slice((to || from) + 1 || this.length);
          this.length = from < 0 ? this.length + from : from;
          return this.push.apply(this, rest);
        };

        //$(".spinner").spinedit();
        $(".checkbox").button();
        $(".validateTips").hide();
        $("input[type=submit], button")
            .button()
            .click(function( event ) {
                event.preventDefault();
            });

        var beginRequest = function(wait_position) {
            if (wait_position === undefined)
                waitIndicator.show($("#content"));
            else
                waitIndicator.show(wait_position);

            let result = {
                "changes": JSON.stringify(command_list),
                "objectives": JSON.stringify([{
                    "id": app.settings_page.getObjective().id,
                    "maximize": app.settings_page.maximizeObjective()
                }]),
                "design_objectives": JSON.stringify([{
                    "id": "",
                    "maximize": true
                }]),
                "target_reactions": JSON.stringify([{
                    "id": "",
                    "maximize": true
                }]),
                "type": JSON.stringify(getSimulationType()),
                //"display": JSON.stringify(design_objective_visible_combobox[0].selectize.getValue().split("\x00")),
                //"auto_flux": JSON.stringify($("#auto_flux").prop("checked"))
                "display": JSON.stringify([]),
                "auto_flux": JSON.stringify(true)
            };

            if (revision !== undefined) {
                result["revision"] = revision;
            }

            return result;
        };

        var doExport = function(format) {
            var data = beginRequest();
            data["dry_run"] = true;

            $.ajax({
                url: "{% url "cyanodesign:simulate" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                if (x["solution"] == "Optimal") {
                    notifyInfo("The solution is " + x["solution"] + ". The download starts in a few seconds. To update the result below press \"Run simulation\".");

                    delete data["dry_run"];
                    data["format"] = format;

                    for (var d in data) {
                        submit_form.append($("<input/>", {type:"text", name:d}).val(data[d]))
                    }

                    submit_form.submit();

                } else {
                    notifyWarning("The solution is " + x["solution"] + ". Check if your constraints are too strict.");
                }

                endRequest();
            }).fail(function(x) {
                $("#visual_graph").hide();
                $("#visual_fba").hide();
                notifyError(x.responseText);
                endRequest();
            });
        };

        var endRequest = function(wait_position) {
            if (wait_position === undefined)
                waitIndicator.hide($("#content"));
            else
                waitIndicator.hide(wait_position);
        };

        var chart_clicked = function(d) {
            //alert(d);

            if (getSimulationType() == "mba") {
                var reaction = getEnzymeByName(cyano_design_objective_select.val());
                var constraint = simulation_chart.categories()[d.index];

                var command = {
                    "type": "reaction",
                    "id": reaction.id,
                    "op": "edit",
                    "object": jQuery.extend(true, {}, reaction)
                };

                command["object"].constraints = [constraint, constraint];

                command_list.push(command);
                var data = beginRequest();
                command_list.pop();
            } else if (getSimulationType() == "sa") {
                // Limit target reaction to measured growth
                var reaction = getEnzymeByName(cyano_design_target_objective_select.val());
                var constraint = simulation_chart.categories()[d.index]; // Upper constraint

                var command = {
                    "type": "reaction",
                    "id": reaction.id,
                    "op": "edit",
                    "object": jQuery.extend(true, {}, reaction)
                };

                if (command["object"].constraints.length == 0) {
                    command["object"].constraints = [0, 0];
                }

                command["object"].constraints[1] = last_sim_flux[last_sim_flux.length - 1] * last_sim_flux[d.index][0];

                command_list.push(command);

                reaction = getEnzymeByName(cyano_design_objective_select.val());
                constraint = last_sim_flux[d.index][1][reaction.name];

                var command = {
                    "type": "reaction",
                    "id": reaction.id,
                    "op": "edit",
                    "object": jQuery.extend(true, {}, reaction)
                };

                command["object"].constraints = [constraint, constraint];

                command_list.push(command);

                var data = beginRequest();

                command_list.pop();
                command_list.pop();
            }

            data["type"] = JSON.stringify("fba");

            data["objectives"] = JSON.stringify([{
                "name": cyano_design_design_objective_select.val(),
                "maximize": $("#radio-maximize").prop("checked")
            }]);

            $.ajax({
                url: "{% url "cyanodesign:simulate" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                 var graph = Viz(x["graphstr"], "svg", "dot");

                if (x["solution"] == "Optimal") {
                    var obj = cyano_design_objective_select.val();
                    notifyInfo("The solution is " + x["solution"] + ". Flux of objective is " + x["flux"][obj].toFixed(4));
                } else {
                    notifyWarning("The solution is " + x["solution"] + ". Check if your constraints are too strict.");
                }

                $("#visual_graph").show();
                $("#visual_fba").show();
                document.getElementById("visual_fba").innerHTML = graph;

                $("#visual_fba").attr("width", "100%").attr("height", "400px");
                var svgPan = svgPanZoom('#visual_fba > svg', {minZoom: 0.1, fit: false});
                svgPan.zoom(1);

                datatable_flux.clear();

                var idx = d.index;
                for (var key in last_sim_flux[idx][1]) {
                    if (last_sim_flux[idx][1].hasOwnProperty(key)) {
                        if (key.indexOf("_transp") == -1)
                        datatable_flux.row.add([Enzyme.instanceById(key).name, last_sim_flux[idx][1][key]]);
                    }
                }

                datatable_flux.draw();

                endRequest();
            }).fail(function(x) {
                $("#visual_graph").hide();
                $("#visual_fba").hide();
                notifyError(x.responseText);
                endRequest();
            });
        };


        $("#design-save").click(function(event) {
            var txt = "";

            if (revision !== undefined) {
                txt = "Rollback to revision " + revision;
            }

            $("#id_save_summary").val(txt);
            $("#dialog-save-model").modal("show");
        });

        $("#design-saveas").click(function(event) {
            var txt = "";

            if (revision !== undefined) {
                txt = "Rollback to revision " + revision;
            }

            $("#id_saveas_summary").val(txt);
            $("#dialog-saveas-model").modal("show");
        });

        $("#dialog-save-model").on("click", ".btn-primary", function(event) {
            var form = $("#dialog-save-model").find("form");
            var data = beginRequest($("#dialog-save-model").find(".modal-content"));
            data["summary"] = form.find("#id_save_summary").val();
            $.ajax({
                url: "{% url "cyanodesign:save" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                if (revision !== undefined) {
                    location.replace("{% url "cyanodesign:design" pk=pk %}");
                }
                $("#dialog-save-model").modal("hide");
                endRequest($("#dialog-save-model").find(".modal-content"));
                $("#simulation-result").html("")
                command_list = [];
            }).fail(function(x) {
                $("#dialog-save-model").modal("hide");
                $("#visual_graph").hide();
                $("#visual_fba").hide();
                notifyError(JSON.parse(x.responseText)["message"]);
                endRequest($("#dialog-save-model").find(".modal-content"));
            });
        });

        $("#dialog-saveas-model").on("click", ".btn-primary", function(event) {
            var form = $("#dialog-saveas-model").find("form");
            var data = beginRequest($("#dialog-saveas-model").find(".modal-content"));
            data["saveas_name"] = form.find("#id_saveas_name").val();
            data["saveas_summary"] = form.find("#id_saveas_summary").val();
            $.ajax({
                url: "{% url "cyanodesign:save_as" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                if (!(x['success'])) {
                    form.replaceWith(x['form_html']);
                } else {
                    location.replace(x['url'])
                }
                endRequest($("#dialog-saveas-model").find(".modal-content"));
            }).fail(function(x) {
                $("#visual_graph").hide();
                $("#visual_fba").hide();
                notifyError(x.responseText);
                endRequest($("#dialog-saveas-model").find(".modal-content"));
            });
        });

        $("#export-png").click(function(event) {
            if (last_symtype == "mba" || last_symtype == "sa") {
                $("#visual_graph > svg").find(".c3-axis path, .c3-axis line").css({"fill":"none","stroke":"black"});
                $("#visual_graph > svg").css({"font":"10px sans-serif"});
                $("#visual_graph > svg").find(".c3-legend-item").css({"font":"12px sans-serif"});

                downloadPNG();
            } else {
                // save old style
                var g = $("#visual_fba > svg > g");
                var g_style = g.attr("style");
                var g_transform = g.attr("transform");

                // Clear style, otherwise SVG only shows a viewport
                g.attr("style", "").attr("transform", "");

                downloadPNG();

                // Reset style
                g.attr("style", g_style).attr("transform", g_transform);
            }
        });

        $("#export-svg").click(function(event) {
            if (last_symtype == "mba" || last_symtype == "sa") {
                $("#visual_graph > svg").find(".c3-axis path, .c3-axis line").css({"fill":"none","stroke":"black"});
                $("#visual_graph > svg").css({"font":"10px sans-serif"});
                $("#visual_graph > svg").find(".c3-legend-item").css({"font":"12px sans-serif"});

                downloadSVG();
            } else {
                // save old style
                var g = $("#visual_fba > svg > g");
                var g_style = g.attr("style");
                var g_transform = g.attr("transform");

                // Clear style, otherwise SVG only shows a viewport
                g.attr("style", "").attr("transform", "");

                downloadSVG();

                // Reset style
                g.attr("style", g_style).attr("transform", g_transform);
            }
        });

        $("#export-csv").click(function(event) {
            doExport("csv");
        });


/*
        dialog_enzyme.on('shown.bs.modal', function() {
            dialog_enzyme.find("input").blur();

            dialog_enzyme.find("#reaction-substrates")[0].selectize.close();
            dialog_enzyme.find("#reaction-products")[0].selectize.close();

            var val = dialog_enzyme.find("#enzyme-name").val();
            // move cursor to end
            dialog_enzyme.find("#enzyme-name").focus().val("").val(val);
        });

        dialog_metabolite_add.on('shown.bs.modal', function() {
            var val = dialog_metabolite_add.find("#add-metabolite-name").val();
            dialog_metabolite_add.find("#add-metabolite-name").focus().val("").val(val);
        });

        dialog_metabolite_edit.on('shown.bs.modal', function() {
            var val = dialog_metabolite_edit.find("#metabolite-name").val();
            dialog_metabolite_edit.find("#metabolite-name").focus().val("").val(val);
        });


        $(".cyano-design-reactions").on("click", ".cyano-design-reaction", function() {
            var index = enzymes_design.indexOf(getEnzymeByName($(this).text()));
            if (index > -1) {
                enzymes_design.splice(index, 1);
            }
            updateEnzymeDesignList();
        });
        /*dialog_enzyme.on("click", "div.cyano-metabolite", function(event) {
            var item = $(event.target).data("object");
            saveEnzyme(dialog_enzyme.data("object"));
            dialog_metabolite_edit.find("input.name").val(item.name);
            dialog_metabolite_edit.find("#external").prop("checked", item.external);
            dialog_metabolite_edit.data("object", item);

            dialog_metabolite_edit.dialog("open");
        });
        dialog_enzyme.find("#constrained:checkbox").change(function() {
            if ($(this).is(":checked")) {
                constraints_div.show();
            } else {
                constraints_div.hide();
            }
        });
*/

        // delete button clicked
        /*datatable_enzymes.on("click", ".delete-button", function(event) {
            var parent = $(this).closest("tr");
            var dialog_delete = $("#dialog-delete");
            var row = datatable_enzymes.row(parent);

            dialog_delete.data("parent", parent);
            dialog_delete.find(".reaction-name").text(row.data().name);
            dialog_delete.modal('show');
        });*/

        $("#dialog-delete").find(".btn-primary").click(function () {
            var dialog_delete = $("#dialog-delete");

            var reaction = datatable_enzymes.row(dialog_delete.data("parent")).data();
            var rmets = reaction.getMetabolites();
            var del_mets = dialog_delete.find("input").prop("checked");
            reaction.remove();

            command_list.push({
                "op": "delete",
                "type": "reaction",
	            "id": reaction.id,
                "object": {}
            });

            rmets.filter(function(m) {
                m.invalidate();
                return del_mets && m.isUnused();
            }).forEach(function(m) {
                m.remove();
                m.removeFromList();

                command_list.push({
                    "type": "metabolite",
                    "op": "delete",
                    "id": m.id,
                    "object": {}
                });
            });

            cyano_design_objective_select[0].selectize.removeOption(reaction.name);
            cyano_design_design_objective_select[0].selectize.removeOption(reaction.name);
            design_objective_visible_combobox[0].selectize.removeOption(reaction.name);
            cyano_design_target_objective_select[0].selectize.removeOption(reaction.name);

            datatable_metabolites.draw();

            dialog_delete.modal("hide");

            dialog_delete.data("parent").fadeOut(200, function() { datatable_enzymes.row(this).remove().draw(); });
        });

        let load_model = function(callback) {
            $.ajax({
                url: "{% url "cyanodesign:get_reactions" pk=pk %}{% if revision %}?revision={{ revision.pk }}{% endif %}",
                context: document.body
            }).done(function(x) {
                let model = new MetabolicModel.Model();
                model.fromJson(x);

                callback(model);

                $(".design-submit").click(function(event) {
                    var data = beginRequest();

                    $.ajax({
                        url: "{% url "cyanodesign:simulate" pk=pk %}",
                        type: "POST",
                        data: data
                    }).done(function(x) {
                        app.simulation_page.simulate(x);
                        endRequest();
                    }).fail(function(x) {
                        $("#visual_graph").hide();
                        $("#visual_fba").hide();
                        notifyError(x.responseText);
                        endRequest();
                    });
                });

                waitIndicator.hide($("#content"));
            });
        };

        //table_enzymes.css("width", "");
        //table_metabolites.css("width", "");

        $("#enzyme_regex").click(function() {
            datatable_enzymes.search("", $(this).prop("checked"), true).draw();
        });

        $("#metabolite_regex").click(function() {
            datatable_metabolites.search("", $(this).prop("checked"), true).draw();
        });

        $("#flux_regex").click(function() {
            datatable_flux.search("", $(this).prop("checked"), true).draw();
        });

        $("#create-enzyme-bulk-button").click(function() {
            $("#enzyme-bulkdata").val("");
            $("#dialog-reaction-bulkadd").modal("show");
        });

        $("#enzyme-bulkdata").keyup(function() {
            var lines = $("#enzyme-bulkdata").val().split(/\r*\n/);

            $("#enzyme-bulkadd-preview").empty();
            var buffered_line = "";
            lines.forEach(function(line) {
                var e;
                try {
                    var last = line.split(/\s+/g).pop();
                    if (last === "undefined") {
                        return;
                    }
                    if (last == "<->" || last == "->" || last == "+") {
                        buffered_line += " " + line;
                        return;
                    }

                    buffered_line += " " + line;

                    buffered_line = buffered_line.trim();

                    if (buffered_line.length == 0) {
                        return;
                    }

                    e = Enzyme.fromBioOptString(buffered_line).toString();

                    buffered_line = "";
                } catch (err) {
                    e = err["enzyme"].toString() + " Error: " + err["message"];
                }
                if (e !== 'undefined') {
                    $("<div>").text(e).appendTo($("#enzyme-bulkadd-preview"));
                }
            });
        });

        waitIndicator.show($("#content"));
        startup = load_model;
    });
</script>

{% endblock %}

{% block extrastyles %}
span.cyano-external-metabolite { color: green }

.cyano-metabolite-list tr td:first-child,
.cyano-enzyme-list tr td:first-child {
    font-weight: bold;
}

.hoverable,
.cyano-metabolite-list .cyano-enzyme,
.cyano-metabolite-list tr td:first-child,
.cyano-enzyme-list tr td:first-child,
.cyano-enzyme-list .cyano-metabolite,
svg g.node,
svg text
{
    cursor: pointer;
}
.hoverable:hover,
.cyano-metabolite-list .cyano-enzyme:hover,
.cyano-metabolite-list tr td:first-child:hover,
.cyano-enzyme-list tr.odd td:first-child:hover,
.cyano-enzyme-list tr.even td:first-child:hover,
.cyano-enzyme-list .cyano-metabolite:hover
{
    color: blue;
}

.cyano-enzyme-disabled
{
    color: grey;
}

.submit-form
{
    display: none;
}

.tab-content
{
    margin-top: 5px;
    margin-bottom: 5px;
}
{% endblock %}

{% block content %}

{% if not request.user.is_authenticated %}
<div class="alert alert-info" role="alert">
        <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
        <span class="sr-only">Info:</span>You are not logged in. Making permanent changes to models or uploading new ones is disabled.</div>
</div>
{% endif %}

{% if revision %}
<div class="alert alert-info" role="alert">
Viewing old model from {{ revision.date }}. Simulating and saving will be based on this old version of the model.
</div>
{% endif %}

<div role="tabpanel">
<ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#reaction-tab" role="tab" data-toggle="tab">Reactions</a></li>
    <li role="presentation"><a href="#metabolite-tab" role="tab" data-toggle="tab">Metabolites</a></li>
    <li role="presentation"><a href="#settings-tab" role="tab" data-toggle="tab">Settings</a></li>
    <li role="presentation"><a href="#chemical-tab" role="tab" data-toggle="tab">Stoichiometry</a></li>
    <li role="presentation"><a href="#simulation-tab" role="tab" data-toggle="tab">Simulation</a></li>
</ul>

<div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="reaction-tab">
    </div>
    <div role="tabpanel" class="tab-pane" id="metabolite-tab">
    </div>

    <div role="tabpanel" class="tab-pane" id="settings-tab">
    </div>

    <div role="tabpanel" class="tab-pane" id="chemical-tab">
    </div>

    <div role="tabpanel" class="tab-pane" id="simulation-tab">
    </div>
</div>
</div>

<!-- Modal -->
<div class="modal fade" id="dialog-delete" tabindex="-1" role="dialog" aria-labelledby="dialog-delete-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-delete-label">Delete <span class="reaction-name"></span></h4>
            </div>
            <div class="modal-body">
                Do you really want to delete reaction <span class="reaction-name"></span>?

                <div class="form-group">
                <div class="checkbox">
                    <input id="dialog-delete-unused-metabolites" type="checkbox">
                    <label for="dialog-delete-unused-metabolites">Delete unused metabolites</label>
                </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-danger">Delete</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="dialog-delete-metabolites" tabindex="-1" role="dialog" aria-labelledby="dialog-delete-metabolites-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-delete-metabolites-label">Delete unused metabolites</h4>
            </div>
            <div class="modal-body">
                Do you really want to delete all unused metabolites?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-danger">Delete</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="dialog-save-model" tabindex="-1" role="dialog" aria-labelledby="dialog-save-model-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            {% crispy save_form %}
        </div>
    </div>
</div>

<div class="modal fade" id="dialog-saveas-model" tabindex="-1" role="dialog" aria-labelledby="dialog-saveas-model-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            {% crispy saveas_form %}
        </div>
    </div>
</div>

{% if request.user.is_authenticated %}
<input type="submit" id="design-save" class="btn btn-primary" value="Save">
<input type="submit" id="design-saveas" class="btn btn-primary" value="Save As">
{% endif %}

<form method="post" action="{% url "cyanodesign:simulate" pk=pk %}" id="submit-form">
{% csrf_token %}
</form>

{% endblock %}
