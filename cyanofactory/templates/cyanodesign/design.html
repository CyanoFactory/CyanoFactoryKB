{% extends "cyano/base.html" %}

{% comment %}
Cyanodesign index page

Copyright (c) 2013 Gabriel Kind <gkind@hs-mittweida.de>
Hochschule Mittweida, University of Applied Sciences

Released under the MIT license
{% endcomment %}

{% load static %}
{% load staticfiles %}
{% load templatetags %}
{% load filters %}
{% load crispy_forms_tags %}

{% block head_title %}{{ block.super }} :: WeDesign{% endblock %}
{% block page_title %}WeDesign &ndash; {{ name }}{% endblock %}
{% block head %}
{{ block.super }}
<script src="{% get_static_prefix %}cyanodesign/js/d3.v3.js"></script>
<link href="{% get_static_prefix %}cyanodesign/css/c3.css" rel="stylesheet" type="text/css">
<script src="{% get_static_prefix %}cyanodesign/js/c3.js"></script>
<script async src="{% get_static_prefix %}cyanodesign/js/viz.js"></script>
<script type="text/javascript" src="{% get_static_prefix %}boehringer/js/svg-pan-zoom.js"></script>
<script src="{% get_static_prefix %}/cyanodesign/node_modules/requirejs/require.js"
        data-main="{% get_static_prefix %}cyanodesign/js/app"></script>
<!--<script src="{% get_static_prefix %}cyanodesign/js/metabolic_model.js"></script>-->
<script src="{% get_static_prefix %}cyanodesign/js/mba_chart.js"></script>

<script type="text/javascript">
    var MetabolicModel = undefined;
    var model = undefined;
    var loadModel = undefined;

    "use strict";

    var enzymes_design = [];
    var design_objective = undefined;
    var dialog_metabolite_edit;
    var dialog_enzyme;
    var dialog_metabolite_add;
    var cyano_design_objective_select;
    var cyano_design_design_objective_select;
    var cyano_design_target_objective_select;
    var design_objective_visible_combobox;
    var constraints_div;
    var create_new_enzyme = false;
    var command_list = [];
    var svg;
    var table_enzymes;
    var datatable_enzymes;
    var table_metabolites;
    var datatable_metabolites;
    var table_flux;
    var table_chemical;
    var datatable_flux;
    var submit_form;
    var revision = {% if revision %}{{ revision.pk }}{% else %}undefined{% endif %};
    var simulation_chart = undefined;
    var last_symtype;
    var last_sim_flux;

    /*Enzyme.prototype.invalidate = function() {
        this.getMetabolites().forEach(function (obj) {
            datatable_metabolites.row(model.metabolites.indexOf(obj)).invalidate();
        });

        datatable_enzymes.row(model.reactions.indexOf(this)).invalidate();
    };

    Enzyme.prototype.removeFromList = function() {
        var that = this;
        datatable_enzymes.row(function(idx, data, node) {
            return data.name == that.name;
        }).remove();
    };

    Metabolite.prototype.invalidate = function() {
        this.getEnzymes().forEach(function (obj) {
            datatable_enzymes.row(model.reactions.indexOf(obj)).invalidate();
        });

        datatable_metabolites.row(model.metabolites.indexOf(this)).invalidate();
    };

    Metabolite.prototype.removeFromList = function() {
        var that = this;
        datatable_metabolites.row(function(idx, data, node) {
            return data.name == that.name;
        }).remove();
    };*/

    var reaction_filter = [
        function(e) { return e.enabled },
        function(e) { return !e.enabled },
        function(e) { return e.isConstrained() },
        function(e) { return !e.isConstrained() },
        function(e) { return e.reversible },
        function(e) { return !e.reversible }
    ];

    var metabolite_filter = [
        function(e) { return !e.isExternal() },
        function(e) { return e.isExternal() }
    ];

    function notifyInfo(text) {
        $("#simulation-result").html('<div class="alert alert-info" role="alert">\
            <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>\
            <span class="sr-only">Info:</span>' + text + '</div>');
    }

    function notifyWarning(text) {
        $("#simulation-result").html('<div class="alert alert-warning" role="alert">\
            <span class="glyphicon glyphicon-warning-sign" aria-hidden="true"></span>\
            <span class="sr-only">Info:</span>' + text + '</div>');
    }

    function notifyError(text) {
        $("#simulation-result").html('<div class="alert alert-danger" role="alert">\
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>\
            <span class="sr-only">Error:</span>' + text + '</div>');
    }

    $(function () {
        dialog_metabolite_edit = $("#dialog-edit-metabolite");
        dialog_enzyme = $("#dialog-reaction");
        dialog_metabolite_add = $("#dialog-add-metabolite");
        cyano_design_objective_select = $("#cyano-design-objective-select");
        cyano_design_design_objective_select = $("#cyano-design-design-objective-select");
        cyano_design_target_objective_select = $("#cyano-design-target-objective-select");
        design_objective_visible_combobox = $("#design-objective-visible-combobox");
        constraints_div = $("#constraints-min-max");
        table_enzymes = $('#cyano-enzyme-list');
        table_metabolites = $('#cyano-metabolite-list');
        table_flux = $('#cyano-flux-list');
        table_chemical = $('#cyano-chemical-list');
        submit_form = $('#submit-form');

        datatable_enzymes = table_enzymes.DataTable({
            "deferRender": true,
            columns: [
                    {},
                    {},
                    {},
                    {},
                    {},
                    {}
                ],
            columnDefs: [
                {
                    "targets": 0,
                    "width": "25%",
                    "data": function (rowData, type, set, meta) {
                        return rowData;
                    },
                    render: function(data, type, row, meta) {
                        var e = $("<span>");

                        if (!data.enabled) {
                            e.addClass("cyano-enzyme-disabled");
                        }

                        return e.text(data.name).wrap("<p>").parent().html();
                    }
                },
                {
                    "targets": 1,
                    "width": "45%",
                    "orderable": false,
                    "data": function (rowData, type, set, meta) {
                        return rowData;
                    },
                    render: function(data, type, row, meta) {
                        return $(data.toHTML(model)).wrap("<p>").parent().html();
                    }
                },
                {
                    "targets": 2,
                    "width": "10%",
                    "orderable": false,
                    "searchable": false,
                    "data": function (rowData, type, set, meta) {
                        return rowData.constraintsToString();
                    }
                },
                {
                    "targets": 3,
                    "width": "12%",
                    "orderable": false,
                    "searchable": false,
                    "data": function (rowData, type, set, meta) {
                        return rowData.enabled;
                    },
                    render: function(data, type, row, meta) {
                        if (type === 'copy') {
                            return data === true ? "Enabled" : "Disabled";
                        }

                        return "<div class='checkbox'> \
                        <input type='checkbox' id='enabled" + meta.row + "' " + (data ? "checked='checked'" : "") + "> \
                        <label for='enabled"  + meta.row + "'>Enabled</label> \
                        </div>";
                    }
                },
                {
                    "targets": 4,
                    "width": "8%",
                    "orderable": false,
                    "searchable": false,
                    "data": function (rowData, type, set, meta) {
                        return rowData;
                    },
                    "render": function(data, type, row, meta) {
                        return "<a class='btn btn-default btn-xs delete-button'>Delete</a>"
                    }
                },
                {
                    "targets": 5,
                    "visible": false,
                    "orderable": true,
                    "data": function (rowData, type, set, meta) {
                        return "No Pathway";
                        // FIXME return rowData.pathway.length == 0 ? "No Pathway" : rowData.pathway;
                    }
                }
            ],
            drawCallback: function ( settings ) {
                var api = this.api();
                var rows = api.rows( {page:'current'} ).nodes();
                var last=null;

                /*api.column(5, {page:'current'} ).data().each( function ( group, i ) {
                    if ( last !== group ) {
                        $(rows).eq( i ).before(
                            '<tr class="group"><td colspan="5">'+group+'</td></tr>'
                        );

                        last = group;
                    }
                } );*/
            },
            "displayLength": 25,
            "order": [[ 0, 'asc' ]],
            dom:
                "<'row'<'col-sm-6'l><'col-sm-6'f>>" +
                "<'row'>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-12'B>>" +
                "<'row'<'col-sm-6'i><'col-sm-6'p>>",
            buttons: [
                {
                    extend: 'copy',
                    exportOptions: {
                        columns: [0, 1, 2, 3],
                        modifier: {
                            selected: true
                        },
                        orthogonal: 'copy'
                    }
                },
                {
                    extend: 'csv',
                    exportOptions: {
                        columns: [0, 1, 2, 3],
                        modifier: {
                            selected: true
                        },
                        orthogonal: 'copy'
                    }
                }
            ]
        });

        datatable_flux = table_flux.DataTable({
            "deferRender": true,
            "displayLength": 25,
            "order": [[ 1, 'desc' ]],
            "language": {
                "emptyTable": "The fluxes are displayed here after running a simulation"
            },
            columnDefs: [
                {
                    "targets": 0
                },
                {
                    "targets": 1
                }
            ],
            dom: "<'row'<'col-sm-6'l><'col-sm-6'f>>" +
                "<'row'>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-12'B>>" +
                "<'row'<'col-sm-5'i><'col-sm-7'p>>",
            buttons: [
                {
                    extend: 'copy',
                    exportOptions: {
                        modifier: {
                            selected: true
                        },
                        orthogonal: 'copy'
                    }
                },
                {
                    extend: 'csv',
                    exportOptions: {
                        modifier: {
                            selected: true
                        },
                        orthogonal: 'copy'
                    }
                }
            ]
        });

        $($("#filter_row_flux").text()).appendTo($("#cyano-flux-list_wrapper").children()[1]);

        $.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                if (settings.nTable == table_flux[0]) {
                    var min = parseFloat($("#filter-flux-min").val());
                    var max = parseFloat($("#filter-flux-max").val());

                    var d = datatable_flux.data()[dataIndex];

                    // Check flux values
                    if (!isNaN(min) && d[1] < min) {
                        return false;
                    }

                    if (!isNaN(max) && d[1] > max) {
                        return false;
                    }

                    return true;
                }

                return true;
            }
        );

        $("#filter-flux-min").change(function() { datatable_flux.draw(); });
        $("#filter-flux-max").change(function() { datatable_flux.draw(); });

        $("#radio-fba").change(updateSettingsVisibility);
        $("#radio-mba").change(updateSettingsVisibility);
        $("#radio-sa").change(updateSettingsVisibility);

        $($("#filter_row").text()).appendTo($("#cyano-enzyme-list_wrapper").children()[1]);

        $("#cyano-enzyme-list-filter-reactions").multiselect({
            buttonClass: 'btn btn-default btn-xs',
            onChange: function(option, checked, select) {
                datatable_enzymes.draw();
            },
            buttonText: function(options, select) {
                if (options.length === 0) {
                    return 'No option selected';
                }
                else if (options.length === 6) {
                    return 'No filter applied';
                }
                else {
                    var labels = [];
                    var prev = undefined;

                    options.each(function() {
                        if (prev !== undefined) {
                            if (prev.index % 2 == 1) {
                                labels.push("AND");
                            } else {
                                if (this.index - 1 == prev.index) {
                                    labels.push("OR");
                                } else {
                                    labels.push("AND");
                                }
                            }
                        }

                        labels.push($(this).html());

                        prev = this;
                    });
                    return labels.join(' ') + '';
                }
            }
        });

        // Order by the grouping
        /*table_enzymes.delegate('tr.group', 'click', function() {
            var currentOrder = datatable_enzymes.order()[0];
            if ( currentOrder[0] === 2 && currentOrder[1] === 'asc' ) {
                datatable_enzymes.order( [ 5, 'desc' ] ).draw();
            }
            else {
                datatable_enzymes.order( [ 5, 'asc' ] ).draw();
            }
        } );*/

        $.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                if (settings.nTable == table_enzymes[0]) {
                    var arr = $("#cyano-enzyme-list-filter-reactions").find("option").map(function () {
                        return this.selected;
                    }).get();

                    var d = datatable_enzymes.data()[dataIndex];
                    var f = reaction_filter;

                    if (!(arr[0] || arr[1]) || !(arr[2] || arr[3]) || !(arr[4] || arr[5])) {
                        return false;
                    }

                    return ((arr[0] ? f[0](d) : !f[0](d)) || (arr[1] ? f[1](d) : !f[1](d))) &&
                            ((arr[2] ? f[2](d) : !f[2](d)) || (arr[3] ? f[3](d) : !f[3](d))) &&
                            ((arr[4] ? f[4](d) : !f[4](d)) || (arr[5] ? f[5](d) : !f[5](d)));
                }

                return true;
            }
        );

        datatable_metabolites = table_metabolites.DataTable({
            "deferRender": true,
            columns: [
                    {},
                    {},
                    {},
                    {}
                ],
            columnDefs: [
                {
                    "targets": 0,
                    "data": function (rowData, type, set, meta) {
                        return rowData.name;
                    }
                },
                {
                    "targets": 1,
                    "orderable": false,
                    "data": function (rowData, type, set, meta) {
                        return rowData.consumed;
                    },
                    "render": function(data, type, row, meta ) {
                        return data.map(function(arg) {
                            var e = $("<span></span>").addClass("cyano-enzyme");
                            if (!arg.enabled) {
                                e.addClass("cyano-enzyme-disabled");
                            }
                            return e.append(arg.name).wrap("<p>").parent().html();
                        }).join(", ");
                    }
                },
                {
                    "targets": 2,
                    "orderable": false,
                    "data": function (rowData, type, set, meta) {
                        return rowData.produced;
                    },
                    "render": function(data, type, row, meta ) {
                        return data.map(function(arg) {
                            var e = $("<span></span>").addClass("cyano-enzyme");
                            if (!arg.enabled) {
                                e.addClass("cyano-enzyme-disabled");
                            }
                            return e.append(arg.name).wrap("<p>").parent().html();
                        }).join(", ");
                    }
                },
                {
                    "targets": 3,
                    "orderable": false,
                    "searchable": false,
                    "data": function (rowData, type, set, meta) {
                        return rowData.isExternal();
                    },
                    render: function(data, type, row, meta) {
                        if (type === 'copy') {
                            return data === true ? "External" : "Internal";
                        }

                        return "<div class='checkbox'> \
                        <input type='checkbox' id='external" + meta.row + "' " + (data ? "checked='checked'" : "") + "> \
                        <label for='external"  + meta.row + "'>External</label> \
                        </div>";
                    }
                }
            ],
            "displayLength": 25,
            dom:
                "<'row'<'col-sm-6'l><'col-sm-6'f>>" +
                "<'row'>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-sm-12'B>>" +
                "<'row'<'col-sm-6'i><'col-sm-6'p>>",
            buttons: [
                {
                    extend: 'copy',
                    exportOptions: {
                        modifier: {
                            selected: true
                        },
                        orthogonal: 'copy'
                    }
                },
                {
                    extend: 'csv',
                    exportOptions: {
                        modifier: {
                            selected: true
                        },
                        orthogonal: 'copy'
                    }
                }
            ]
        });

        $($("#filter_row_metabolites").text()).appendTo($("#cyano-metabolite-list_wrapper").children()[1]);

        $("#cyano-metabolite-list-filter-reactions").multiselect({
            buttonClass: 'btn btn-default btn-xs',
            onChange: function(option, checked, select) {
                datatable_metabolites.draw();
            },
            buttonText: function(options, select) {
                if (options.length === 0) {
                    return 'No option selected';
                }
                else if (options.length === 2) {
                    return 'No filter applied';
                }
                else {
                    var labels = [];

                    options.each(function() {
                        labels.push($(this).html());
                    });
                    return labels.join(' ') + '';
                }
            }
        });

        $.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                if (settings.nTable == table_metabolites[0]) {
                    var arr = $("#cyano-metabolite-list-filter-reactions").find("option").map(function () {
                        return this.selected;
                    }).get();

                    var d = datatable_metabolites.data()[dataIndex];
                    var f = metabolite_filter;

                    if (!(arr[0] || arr[1])) {
                        return false;
                    }

                    return ((arr[0] ? f[0](d) : !f[0](d)) || (arr[1] ? f[1](d) : !f[1](d)));
                }

                return true;
            }
        );

        $( ".check" ).button();

        var selectize_options = {
            valueField: 'id',
            searchField: ['id'],
            delimiter: '\x00', // impossible delimiter,
            plugins: ['drag_drop', 'remove_button', 'restore_on_backspace'],
            render: {
                option: function(item, escape) {
                    return $("<div>").addClass("option").text(item.id).wrap("<p>").parent().html();
                },
                item: function(item, escape) {
                    if (typeof item.item === "undefined") {
                        // workaround firefox remembering old input
                        return "<div></div>";
                    }
                    var amount = item.item.amount;
                    return $("<div>").addClass("item").attr("data-type", "text").attr("data-item", item.id).text(amount + " " + item.id).wrap("<p>").parent().html();
                }
            }
        };

        dialog_enzyme.find("#reaction-substrates").text("");

        var item_add = function(elements) {
            return function(value, item) {
                item.data("dialog", elements);
                item.data("value", elements.selectize.options[value].item.amount);
                item.editable({
                    type: "text",
                    container: dialog_enzyme[0],
                    title: "Enter amount",
                    unsavedclass: null,
                    success: function (response, newValue) {
                        if (!isFinite(newValue)) {
                            return "Not a number";
                        }

                        var sel;
                        sel = elements.selectize;
                        sel.options[$(this).data("item")].item.amount = newValue;
                        // no this doesn't rerender selected items only flushes render cache...
                        sel.clearCache("item");
                        // readd items
                        // braindead api returns delimited string in get but expects array in set m(
                        sel.setValue(sel.getValue().split('\x00').map(function (a) {
                            return a;
                        }));
                        return {"newValue": newValue};
                    }
                });
            };
        };

        selectize_options["onItemAdd"] = item_add(dialog_enzyme.find("#reaction-substrates")[0]);
        dialog_enzyme.find("#reaction-substrates").selectize(selectize_options);
        dialog_enzyme.find("#reaction-products").text("");
        selectize_options["onItemAdd"] = item_add(dialog_enzyme.find("#reaction-products")[0]);
        dialog_enzyme.find("#reaction-products").selectize(selectize_options);

        dialog_enzyme.find("#reaction-substrates").editable();

        // Array Remove - By John Resig (MIT Licensed)
        Array.prototype.remove = function(from, to) {
          var rest = this.slice((to || from) + 1 || this.length);
          this.length = from < 0 ? this.length + from : from;
          return this.push.apply(this, rest);
        };

        //$(".spinner").spinedit();
        $(".checkbox").button();
        $(".validateTips").hide();
        $("input[type=submit], button")
            .button()
            .click(function( event ) {
                event.preventDefault();
            });

        var beginRequest = function(wait_position) {
            if (wait_position === undefined)
                waitIndicator.show($("#content"));
            else
                waitIndicator.show(wait_position);

            var cdos = cyano_design_objective_select.val();
            var cddos = cyano_design_design_objective_select.val();
            var cdto = cyano_design_target_objective_select.val();

            var result = {
                "changes": JSON.stringify(command_list),
                "objectives": JSON.stringify([{
                    "id": cdos,
                    "maximize": $("#radio-maximize").prop("checked")
                }]),
                "design_objectives": JSON.stringify([{
                    "id": cddos,
                    "maximize": true
                }]),
                "target_reactions": JSON.stringify([{
                    "id": cdto,
                    "maximize": true
                }]),
                "type": JSON.stringify(getSimulationType()),
                "display": JSON.stringify(design_objective_visible_combobox[0].selectize.getValue().split("\x00")),
                "auto_flux": JSON.stringify($("#auto_flux").prop("checked"))
            };

            if (revision !== undefined) {
                result["revision"] = revision;
            }

            return result;
        };

        var doExport = function(format) {
            var data = beginRequest();
            data["dry_run"] = true;

            $.ajax({
                url: "{% url "cyanodesign:simulate" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                if (x["solution"] == "Optimal") {
                    notifyInfo("The solution is " + x["solution"] + ". The download starts in a few seconds. To update the result below press \"Run simulation\".");

                    delete data["dry_run"];
                    data["format"] = format;

                    for (var d in data) {
                        submit_form.append($("<input/>", {type:"text", name:d}).val(data[d]))
                    }

                    submit_form.submit();

                } else {
                    notifyWarning("The solution is " + x["solution"] + ". Check if your constraints are too strict.");
                }

                endRequest();
            }).error(function(x) {
                $("#visual_graph").hide();
                $("#visual_fba").hide();
                notifyError(x.responseText);
                endRequest();
            });
        };

        var endRequest = function(wait_position) {
            if (wait_position === undefined)
                waitIndicator.hide($("#content"));
            else
                waitIndicator.hide(wait_position);
        };

        var chart_clicked = function(d) {
            //alert(d);

            if (getSimulationType() == "mba") {
                var reaction = getEnzymeByName(cyano_design_objective_select.val());
                var constraint = simulation_chart.categories()[d.index];

                var command = {
                    "type": "reaction",
                    "id": reaction.id,
                    "op": "edit",
                    "object": jQuery.extend(true, {}, reaction)
                };

                command["object"].constraints = [constraint, constraint];

                command_list.push(command);
                var data = beginRequest();
                command_list.pop();
            } else if (getSimulationType() == "sa") {
                // Limit target reaction to measured growth
                var reaction = getEnzymeByName(cyano_design_target_objective_select.val());
                var constraint = simulation_chart.categories()[d.index]; // Upper constraint

                var command = {
                    "type": "reaction",
                    "id": reaction.id,
                    "op": "edit",
                    "object": jQuery.extend(true, {}, reaction)
                };

                if (command["object"].constraints.length == 0) {
                    command["object"].constraints = [0, 0];
                }

                command["object"].constraints[1] = last_sim_flux[last_sim_flux.length - 1] * last_sim_flux[d.index][0];

                command_list.push(command);

                reaction = getEnzymeByName(cyano_design_objective_select.val());
                constraint = last_sim_flux[d.index][1][reaction.name];

                var command = {
                    "type": "reaction",
                    "id": reaction.id,
                    "op": "edit",
                    "object": jQuery.extend(true, {}, reaction)
                };

                command["object"].constraints = [constraint, constraint];

                command_list.push(command);

                var data = beginRequest();

                command_list.pop();
                command_list.pop();
            }

            data["type"] = JSON.stringify("fba");

            data["objectives"] = JSON.stringify([{
                "name": cyano_design_design_objective_select.val(),
                "maximize": $("#radio-maximize").prop("checked")
            }]);

            $.ajax({
                url: "{% url "cyanodesign:simulate" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                 var graph = Viz(x["graphstr"], "svg", "dot");

                if (x["solution"] == "Optimal") {
                    var obj = cyano_design_objective_select.val();
                    notifyInfo("The solution is " + x["solution"] + ". Flux of objective is " + x["flux"][obj].toFixed(4));
                } else {
                    notifyWarning("The solution is " + x["solution"] + ". Check if your constraints are too strict.");
                }

                $("#visual_graph").show();
                $("#visual_fba").show();
                document.getElementById("visual_fba").innerHTML = graph;

                $("#visual_fba").attr("width", "100%").attr("height", "400px");
                var svgPan = svgPanZoom('#visual_fba > svg', {minZoom: 0.1, fit: false});
                svgPan.zoom(1);

                datatable_flux.clear();

                var idx = d.index;
                for (var key in last_sim_flux[idx][1]) {
                    if (last_sim_flux[idx][1].hasOwnProperty(key)) {
                        if (key.indexOf("_transp") == -1)
                        datatable_flux.row.add([Enzyme.instanceById(key).name, last_sim_flux[idx][1][key]]);
                    }
                }

                datatable_flux.draw();

                endRequest();
            }).error(function(x) {
                $("#visual_graph").hide();
                $("#visual_fba").hide();
                notifyError(x.responseText);
                endRequest();
            });
        };

        $("#design-submit").click(function(event) {
            var data = beginRequest();

            $.ajax({
                url: "{% url "cyanodesign:simulate" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                var symtype = getSimulationType();
                last_symtype = symtype;

                if (symtype == "fba") {
                    var graph = Viz(x["graphstr"], "svg", "dot");

                    if (x["solution"] == "Optimal") {
                        var obj = cyano_design_objective_select.val();
                        notifyInfo("The solution is " + x["solution"] + ". Flux of objective is " + x["flux"][obj].toFixed(4));
                    } else {
                        notifyWarning("The solution is " + x["solution"] + ". Check if your constraints are too strict.");
                    }

                    $("#visual_graph").hide();
                    $("#visual_fba").show();
                    document.getElementById("visual_fba").innerHTML = graph;

                    $("#visual_fba").attr("width", "100%").attr("height", "400px");
                    var svgPan = svgPanZoom('#visual_fba > svg', {minZoom: 0.1, fit: false});
                    svgPan.zoom(1);

                    datatable_flux.clear();

                    for (var key in x["flux"]) {
                        if (x["flux"].hasOwnProperty(key)) {
                            if (key.indexOf("_transp") == -1)
                                datatable_flux.row.add([model.reaction.get("id", key).name, x["flux"][key]]);
                        }
                    }

                    datatable_flux.draw();
                /*$("svg").find(".edge text").each(function() {
                        if ($(this).text().indexOf(cyano_design_objective_select.val() + " ") == 0) {
                            var new_x = ($("svg").width() / 2) - $(this).attr("x");
                            var new_y = ($("svg").height() / 2) - $(this).attr("y");
                            svgPan.pan({x: new_x, y: new_y});
                        }
                    });*/
                } else if (symtype == "mba") {
                    $("#visual_graph").show();
                    $("#visual_fba").hide();

                    if (!$("#remember-simulation").prop("checked") || simulation_chart === undefined) {
                        var chart = {
                            bindto: '#visual_graph',
                            data: {
                                x: 'x',
                                columns: x["graph"],
                                type: 'bar',
                                axes: {},
                                onclick: chart_clicked
                            },
                            axis: {
                                x: {
                                    label: {
                                        position: "outer-center"
                                    },
                                    type: 'category'
                                },
                                y: {
                                    label: {
                                        position: "outer-middle"
                                    }
                                }
                            }
                        };
                        chart["data"]["axes"][cyano_design_objective_select.val()] = "y";

                        simulation_chart = c3.generate(chart);
                    } else {
                        simulation_chart.load({
                            columns: [
                                [cyano_design_design_objective_select.val()].concat(x["graph"][1])
                            ],
                            type: 'bar'
                        });
                    }
                    last_sim_flux = x["flux"];
                    updateLabels();
                } else if (symtype == "sa") {
                    $("#visual_graph").show();
                    $("#visual_fba").hide();

                    var chart = {
                        bindto: '#visual_graph',
                        data: {
                            x: 'x',
                            columns: x["graph"],
                            type: 'bar',
                            axes: {},
                            onclick: chart_clicked
                        },
                        axis: {
                            x: {
                                label: {
                                    position: "outer-center"
                                },
                                type: 'category'
                            },
                            y: {
                                label: {
                                    position: "outer-middle"
                                }
                            },
                            y2: {
                                label: {
                                    position: "outer-middle"
                                },
                                show: true
                            }
                        }
                    };
                    chart["data"]["axes"][cyano_design_objective_select.val()] = "y";
                    chart["data"]["axes"][cyano_design_design_objective_select.val()] = "y2";

                    simulation_chart = c3.generate(chart);
                    last_sim_flux = x["flux"];
                    updateLabels();
                }

                endRequest();
            }).error(function(x) {
                $("#visual_graph").hide();
                $("#visual_fba").hide();
                notifyError(x.responseText);
                endRequest();
            });
        });

        $("#design-save").click(function(event) {
            var txt = "";

            if (revision !== undefined) {
                txt = "Rollback to revision " + revision;
            }

            $("#id_save_summary").val(txt);
            $("#dialog-save-model").modal("show");
        });

        $("#design-saveas").click(function(event) {
            var txt = "";

            if (revision !== undefined) {
                txt = "Rollback to revision " + revision;
            }

            $("#id_saveas_summary").val(txt);
            $("#dialog-saveas-model").modal("show");
        });

        $("#dialog-save-model").on("click", ".btn-primary", function(event) {
            var form = $("#dialog-save-model").find("form");
            var data = beginRequest($("#dialog-save-model").find(".modal-content"));
            data["summary"] = form.find("#id_save_summary").val();
            $.ajax({
                url: "{% url "cyanodesign:save" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                if (revision !== undefined) {
                    location.replace("{% url "cyanodesign:design" pk=pk %}");
                }
                $("#dialog-save-model").modal("hide");
                endRequest($("#dialog-save-model").find(".modal-content"));
                $("#simulation-result").html("")
                command_list = [];
            }).error(function(x) {
                $("#dialog-save-model").modal("hide");
                $("#visual_graph").hide();
                $("#visual_fba").hide();
                notifyError(JSON.parse(x.responseText)["message"]);
                endRequest($("#dialog-save-model").find(".modal-content"));
            });
        });

        $("#dialog-saveas-model").on("click", ".btn-primary", function(event) {
            var form = $("#dialog-saveas-model").find("form");
            var data = beginRequest($("#dialog-saveas-model").find(".modal-content"));
            data["saveas_name"] = form.find("#id_saveas_name").val();
            data["saveas_summary"] = form.find("#id_saveas_summary").val();
            $.ajax({
                url: "{% url "cyanodesign:save_as" pk=pk %}",
                type: "POST",
                data: data
            }).done(function(x) {
                if (!(x['success'])) {
                    form.replaceWith(x['form_html']);
                } else {
                    location.replace(x['url'])
                }
                endRequest($("#dialog-saveas-model").find(".modal-content"));
            }).error(function(x) {
                $("#visual_graph").hide();
                $("#visual_fba").hide();
                notifyError(x.responseText);
                endRequest($("#dialog-saveas-model").find(".modal-content"));
            });
        });

        $("#export-png").click(function(event) {
            if (last_symtype == "mba" || last_symtype == "sa") {
                $("#visual_graph > svg").find(".c3-axis path, .c3-axis line").css({"fill":"none","stroke":"black"});
                $("#visual_graph > svg").css({"font":"10px sans-serif"});
                $("#visual_graph > svg").find(".c3-legend-item").css({"font":"12px sans-serif"});

                downloadPNG();
            } else {
                // save old style
                var g = $("#visual_fba > svg > g");
                var g_style = g.attr("style");
                var g_transform = g.attr("transform");

                // Clear style, otherwise SVG only shows a viewport
                g.attr("style", "").attr("transform", "");

                downloadPNG();

                // Reset style
                g.attr("style", g_style).attr("transform", g_transform);
            }
        });

        $("#export-svg").click(function(event) {
            if (last_symtype == "mba" || last_symtype == "sa") {
                $("#visual_graph > svg").find(".c3-axis path, .c3-axis line").css({"fill":"none","stroke":"black"});
                $("#visual_graph > svg").css({"font":"10px sans-serif"});
                $("#visual_graph > svg").find(".c3-legend-item").css({"font":"12px sans-serif"});

                downloadSVG();
            } else {
                // save old style
                var g = $("#visual_fba > svg > g");
                var g_style = g.attr("style");
                var g_transform = g.attr("transform");

                // Clear style, otherwise SVG only shows a viewport
                g.attr("style", "").attr("transform", "");

                downloadSVG();

                // Reset style
                g.attr("style", g_style).attr("transform", g_transform);
            }
        });

        $("#export-csv").click(function(event) {
            doExport("csv");
        });

        function updateTips(o, t) {
            if (typeof o !== "undefined") {
                o.parent(".form-group").addClass("has-error");
                o.siblings(".help-block").remove();
                $("<div></div>").addClass("help-block").text(t).insertAfter(o);
            }
        }

        function checkLength(o, n, min, max) {
            if (o.val().length > max || o.val().length < min) {
                o.addClass("ui-state-error");
                updateTips(o, "Length of " + n + " must be between " +
                        min + " and " + max + ".");
                return false;
            } else {
                return true;
            }
        }

        function checkBool(o, bool, error) {
            if (bool) {
                return true;
            } else {
                updateTips(o, error);
                return false;
            }
        }

        function checkRegexpPos(o, regexp, n) {
            if ( regexp.test(o.val()) ) {
                updateTips(o, n);
                return false;
            } else {
                return true;
            }
        }

        function checkRegexp(o, regexp, n) {
            if (!( regexp.test(o.val()) )) {
                updateTips(o, n);
                return false;
            } else {
                return true;
            }
        }

        function getEnzymeByName(name) {
            return model.reactions.find(function(obj) {
                return obj.name == name;
            });
        }

        function updateEnzymeList() {
            datatable_enzymes.clear();
            datatable_enzymes.rows.add(model.reactions);
            datatable_enzymes.draw();

            var old_design_objective = design_objective;

            model.reactions.forEach(function(item) {
                cyano_design_objective_select[0].selectize.addOption(item);
                cyano_design_design_objective_select[0].selectize.addOption(item);
                design_objective_visible_combobox[0].selectize.addOption(item);
                cyano_design_target_objective_select[0].selectize.addOption(item);
                item.updateMetaboliteReference(model);
            });
            cyano_design_objective_select[0].selectize.refreshOptions();
            cyano_design_design_objective_select[0].selectize.refreshOptions();
            design_objective_visible_combobox[0].selectize.refreshOptions();
            cyano_design_target_objective_select[0].selectize.refreshOptions();

            if (old_design_objective !== undefined) {
                cyano_design_objective_select[0].selectize.setValue(old_design_objective.name, false);
            }
        }

        function updateMetabolitesList() {
            datatable_metabolites.clear();
            datatable_metabolites.rows.add(model.metabolites);
            datatable_metabolites.draw();
        }

        function updateEnzymeDesignList() {
            $(".cyano-design-reactions").text("");
            enzymes_design.forEach(function(obj) {
                $("<div></div>").addClass("cyano-design-reaction").text(obj.name).appendTo(".cyano-design-reactions");
            });
        }

        function showAddEnzymeDialog() {
            showEditEnzymeDialog(new Enzyme("new_enzyme", "New Enzyme"), true);
        }

        function showEditEnzymeDialog(enzyme, create_new) {
            dialog_enzyme.data("object", enzyme);
            dialog_enzyme.data("create", create_new);
            dialog_enzyme.find("#enzyme-name").val(enzyme.id);
            dialog_enzyme.find("#reversible").prop("checked", enzyme.reversible);

            var substrates = dialog_enzyme.find("#reaction-substrates")[0].selectize;
            var products = dialog_enzyme.find("#reaction-products")[0].selectize;
            var enabled = dialog_enzyme.find("#enabled");
            var constrained = dialog_enzyme.find("#constrained");
            var constrained_min = dialog_enzyme.find("#constrained-min");
            var constrained_max = dialog_enzyme.find("#constrained-max");
            var pathway = dialog_enzyme.find("#reaction-pathway")[0].selectize;

            substrates.clear();
            products.clear();
            pathway.clear();

            substrates.clearOptions();
            products.clearOptions();
            pathway.clearOptions();

            model.metabolites.forEach(function(obj) {
                substrates.addOption({"id": obj.name, item: {obj: obj, amount: 1}});
                products.addOption({"id": obj.name, item: {obj: obj, amount: 1}});
            });
            substrates.refreshOptions();
            products.refreshOptions();

            var pathways = Enzyme.getPathways();
            for (var i = 0; i < pathways.length; ++i) {
                pathway.addOption({"text": pathways[i]});
            }
            pathway.refreshOptions();

            for (var i = 0; i < enzyme.substrates.length; ++i) {
                var substrate = enzyme.substrates[i];
                substrates.options[substrate.name].item.amount = substrate.stoichiometry;
                substrates.addItem(substrate.name);
            }
            for (i = 0; i < enzyme.products.length; ++i) {
                var product = enzyme.products[i];
                products.options[product.name].item.amount = product.stoichiometry;
                products.addItem(product.name);
            }

            substrates.refreshItems();
            products.refreshItems();
            pathway.addItem(enzyme.pathway);
            pathway.refreshItems();

            enabled.prop("checked", enzyme.enabled || create_new);

            constrained.prop("checked", enzyme.isConstrained());
            constrained_min.val(enzyme.constraints[0]);
            constrained_max.val(enzyme.constraints[1]);

            if (enzyme.isConstrained()) {
                constraints_div.show();
            } else {
                constraints_div.hide();
            }

            dialog_enzyme.find("div").removeClass("has-error");
            dialog_enzyme.find(".help-block").remove();

            dialog_enzyme.modal("show");
        }

        function showAddMetaboliteDialog() {
            dialog_metabolite_add.find("div").removeClass("has-error");
            dialog_metabolite_add.find(".help-block").remove();
            dialog_metabolite_add.find("#add-metabolite-name").val("New Metabolite");
            dialog_metabolite_add.find("#add-external").prop("checked", false);
            dialog_metabolite_add.modal("show");
        }

        function showEditMetaboliteDialog(item) {
            dialog_metabolite_edit.find("div").removeClass("has-error");
            dialog_metabolite_edit.find(".help-block").remove();
            dialog_metabolite_edit.find("#metabolite-name").val(item.name);
            dialog_metabolite_edit.find("#external").prop("checked", model.metabolite.get("id", item.id).isExternal());
            dialog_metabolite_edit.find("#metabolite-chemical").val(item.chemical);
            dialog_metabolite_edit.data("object", item);
            dialog_metabolite_edit.modal("show");
        }

        function saveEnzyme(enzyme) {
            var name = dialog_enzyme.find("#enzyme-name");
            var reversible = dialog_enzyme.find("#reversible");
            var enabled = dialog_enzyme.find("#enabled");
            var constrained = dialog_enzyme.find("#constrained");
            var constrained_min = dialog_enzyme.find("#constrained-min");
            var constrained_max = dialog_enzyme.find("#constrained-max");
            var substrates = dialog_enzyme.find("#reaction-substrates")[0].selectize;
            var products = dialog_enzyme.find("#reaction-products")[0].selectize;
            var pathway = dialog_enzyme.find("#reaction-pathway");

            var old_design_objective = design_objective;

            var visible_value = undefined;
            if (design_objective_visible_combobox[0].selectize.getValue().split('\x00').indexOf(enzyme.name) > -1) {
                visible_value = enzyme;
            }
            cyano_design_objective_select[0].selectize.removeOption(enzyme.name);
            cyano_design_design_objective_select[0].selectize.removeOption(enzyme.name);
            design_objective_visible_combobox[0].selectize.removeOption(enzyme.name);
            cyano_design_target_objective_select[0].selectize.removeOption(enzyme.name);

            if (enzyme.name != name.val()) {
                enzyme.id = name.val();
                enzyme.name = name.val();
            }

            cyano_design_objective_select[0].selectize.addOption(enzyme);
            cyano_design_objective_select[0].selectize.refreshOptions();
            cyano_design_design_objective_select[0].selectize.addOption(enzyme);
            cyano_design_design_objective_select[0].selectize.refreshOptions();
            design_objective_visible_combobox[0].selectize.addOption(enzyme);
            design_objective_visible_combobox[0].selectize.refreshOptions();
            cyano_design_target_objective_select[0].selectize.addOption(enzyme);
            cyano_design_target_objective_select[0].selectize.refreshOptions();

            if (visible_value !== undefined) {
                design_objective_visible_combobox[0].selectize.addItem(visible_value.name);
            }

            if (old_design_objective !== undefined) {
                cyano_design_objective_select[0].selectize.setValue(old_design_objective.name, false);
            }

            enzyme.reversible = reversible.prop("checked");
            if (constrained.prop("checked")) {
                enzyme.constraints[0] = constrained_min.val();
                enzyme.constraints[1] = constrained_max.val();
            } else {
                enzyme.makeUnconstrained();
            }

            enzyme.enabled = enabled.prop("checked");

            enzyme.substrates = [];
            enzyme.products = [];

            substrates.getValue().split('\x00').forEach(function(a) {
                enzyme.substrates.push({
                    "id": substrates.options[a].item.obj.id,
                    "name": substrates.options[a].item.obj.name,
                    "stoichiometry": substrates.options[a].item.amount
                });
            });

            products.getValue().split('\x00').forEach(function(a) {
                enzyme.products.push({
                    "id": products.options[a].item.obj.id,
                    "name": products.options[a].item.obj.name,
                    "stoichiometry": products.options[a].item.amount
                });
            });

            enzyme.pathway = pathway.val();

            enzyme.updateMetaboliteReference(model).forEach(function(m) {
                m.invalidate();
            });
            enzyme.invalidate();
        }

        function updateSettingsVisibility() {
            $("#fba-settings-panel").hide();
            $("#sa-settings-panel").hide();
            $("#sa-settings-axis-panel").hide();

            if ($("#radio-fba").prop("checked")) {
                $("#fba-settings-panel").show();
            } else if ($("#radio-mba").prop("checked")) {
                $("#sa-settings-panel").show();
                $("#sa-settings-target-function-panel").hide();
                $("#sa-settings-axis-panel").show();
            } else if ($("#radio-sa").prop("checked")) {
                $("#sa-settings-panel").show();
                $("#sa-settings-target-function-panel").show();
                $("#sa-settings-axis-panel").show();
            }
        }

        function getSimulationType() {
            if ($("#radio-fba").prop("checked")) {
                return "fba";
            } else if ($("#radio-mba").prop("checked")) {
                return "mba";
            } else if ($("#radio-sa").prop("checked")) {
                return "sa";
            }

            return "fba";
        }

        function setSimulationType(t) {
            if (t == "fba") {
                $("#radio-fba").prop("checked", true);
            } else if (t == "mba") {
                $("#radio-mba").prop("checked", true);
            } else if (t == "sa") {
                $("#radio-sa").prop("checked", true);
            }

            updateSettingsVisibility();
        }

        $("#radio-fba").change(updateSettingsVisibility);
        $("#radio-mba").change(updateSettingsVisibility);
        $("#radio-sa").change(updateSettingsVisibility);

        dialog_enzyme.on('shown.bs.modal', function() {
            dialog_enzyme.find("input").blur();

            dialog_enzyme.find("#reaction-substrates")[0].selectize.close();
            dialog_enzyme.find("#reaction-products")[0].selectize.close();

            var val = dialog_enzyme.find("#enzyme-name").val();
            // move cursor to end
            dialog_enzyme.find("#enzyme-name").focus().val("").val(val);
        });

        dialog_metabolite_add.on('shown.bs.modal', function() {
            var val = dialog_metabolite_add.find("#add-metabolite-name").val();
            dialog_metabolite_add.find("#add-metabolite-name").focus().val("").val(val);
        });

        dialog_metabolite_edit.on('shown.bs.modal', function() {
            var val = dialog_metabolite_edit.find("#metabolite-name").val();
            dialog_metabolite_edit.find("#metabolite-name").focus().val("").val(val);
        });

        dialog_enzyme.find(".btn-primary").click(function() {
            var name = dialog_enzyme.find("#enzyme-name");
            var constrained = dialog_enzyme.find("#constrained");
            var constrained_min = dialog_enzyme.find("#constrained-min");
            var constrained_max = dialog_enzyme.find("#constrained-max");
            var substrates = dialog_enzyme.find("#reaction-substrates");
            var substrates_sel = substrates[0].selectize;
            var products = dialog_enzyme.find("#reaction-products");
            var products_sel = products[0].selectize;
            var create_new_enzyme = dialog_enzyme.data("create");

            var bValid = true;

            var numeric = /^\-?[0-9]+$/;

            dialog_enzyme.find("div").removeClass("has-error");
            dialog_enzyme.find(".help-block").remove();

            for (var i = 0; i < model.reactions.length; ++i) {
                var enz = model.reactions[i];

                if (enz === dialog_enzyme.data("object")) {
                    continue;
                }

                if (name.val() == enz.name) {
                     bValid &= checkBool(name, enz === dialog_enzyme.data("object"), "Name already in use");
                }
            }

            bValid &= checkRegexp(name, /^[^:]+$/, "Name must not contain a colon (:)");
            bValid &= checkLength(name, "Name", 1, 100);

            if (constrained.prop("checked")) {
                var cmin_float = isFinite(parseFloat(constrained_min.val()));
                var cmax_float = isFinite(parseFloat(constrained_max.val()));
                bValid &= checkBool(constrained_min, cmin_float, "Min constraint must be numeric");
                bValid &= checkBool(constrained_max, cmax_float, "Max constraint must be numeric");
                if (bValid) {
                    bValid &= checkBool(constrained_min, parseFloat(constrained_min.val()) <= parseFloat(constrained_max.val()), "Min constraint > Max constraint");
                }
            }

            if (substrates_sel.getValue().length > 0) {
                substrates_sel.getValue().split('\x00').forEach(function (a) {
                    var is_float = isFinite(parseFloat(substrates_sel.options[a].item.amount));
                    bValid &= checkBool(substrates, is_float, "Stoichiometry must be numeric");
                });
            } else {
                bValid &= checkBool(substrates, substrates_sel.getValue().length > 0, "No substrates defined");
            }

            if (products_sel.getValue().length > 0) {
                products_sel.getValue().split('\x00').forEach(function (a) {
                    var is_float = isFinite(parseFloat(products_sel.options[a].item.amount));
                    bValid &= checkBool(products, is_float, "Stoichiometry must be numeric");
                });
            } else {
                bValid &= checkBool(products, products_sel.getValue().length > 0, "No products defined");
            }

            if (bValid) {
                var reaction = dialog_enzyme.data("object");
                var old_name = reaction.id;

                var old_pathway = reaction.pathway;
                saveEnzyme(reaction);
                reaction.convertToFloat();

                var command = {
                    "type": "reaction",
                    "id": old_name,
                    "object": jQuery.extend(true, {}, reaction)
                };

                if (create_new_enzyme) {
                    model.reactions.push(reaction);

                    datatable_enzymes.row.add(reaction);
                    datatable_enzymes.sort();
                    datatable_enzymes.draw();

                    command["op"] = "add";
                    command["id"] = reaction.id;

                    command_list.push(command);
                } else {
                    command["op"] = "edit";

                    command_list.push(command);

                    if (old_pathway != reaction.pathway) {
                        datatable_enzymes.draw();
                    }
                }

                dialog_enzyme.modal("hide");
            }
        });

        dialog_metabolite_add.find(".btn-primary").click(function() {
            var name = dialog_metabolite_add.find("#add-metabolite-name");
            var external = dialog_metabolite_add.find("#add-external");

            var valid = checkLength(name, "Name", 1, 100);
            valid &= checkRegexpPos(name, /(^[0-9])/, "Name must not begin with a number");
            valid &= checkRegexpPos(name, /(^<?\-> | <?\-> | <?\->$)/, "Name must not contain lonely <-> or ->");
            valid &= checkRegexpPos(name, /(^\+ | \+ )/, "Lonely + only allowed at end of name");

            var met_idx = Metabolite.indexByName(name.val());

            if (met_idx != -1) {
                valid = checkBool(name, false, "Name already in use");
            }

            if (valid) {
                var metabolite = new Metabolite(name.val(), name.val(), external.prop("checked"));
                model.metabolites.push(metabolite);

                command_list.push({
                    "type": "metabolite",
                    "op": "add",
                    "id": metabolite.id,
                    "object": {
                        "name": metabolite.name,
                        "external": metabolite.external,
                        "chemical": metabolite.chemical
                    }
                });

                datatable_metabolites.row.add(metabolite);
                datatable_metabolites.sort();
                datatable_metabolites.draw();

                dialog_metabolite_add.modal("hide");
            }
        });

        dialog_metabolite_edit.find(".btn-primary").click(function() {
            var name = dialog_metabolite_edit.find("#metabolite-name");
            var external = dialog_metabolite_edit.find("#external");

            var valid = checkLength(name, "Name", 1, 100);
            valid &= checkRegexpPos(name, /(^[0-9])/, "Name must not begin with a number");
            valid &= checkRegexpPos(name, /(^<?\-> | <?\-> | <?\->$)/, "Name must not contain lonely <-> or ->");
            valid &= checkRegexpPos(name, /(^\+ | \+ )/, "Lonely + only allowed at end of name");

            var met_idx = Metabolite.indexByName(name.val());

            if (met_idx != -1) {
                valid &= checkBool(name, model.metabolites[met_idx] === dialog_metabolite_edit.data("object"), "Name already in use");
            }

            if (valid) {
                var metabolite = dialog_metabolite_edit.data("object");
                var old_name = metabolite.id;
                metabolite.updateName(name.val());
                var old_external = metabolite.external;
                metabolite.external = external.prop("checked");

                if (old_name != metabolite.name || old_external != metabolite.external) {
                    command_list.push({
                        "type": "metabolite",
                        "op": "edit",
                        "id": old_name,
                        "object": {
                            "id": metabolite.id,
                            "name": metabolite.name,
                            "external": metabolite.external,
                            "chemical": metabolite.chemical
                        }
                    });
                }

                metabolite.invalidate();

                dialog_metabolite_edit.modal("hide");
            }
        });

        // First col
        table_enzymes.delegate('tr td:first-child', 'click', function() {
            var tr = $(this).closest("tr");
            if (tr.hasClass("group")) {
                return;
            }
            var row = datatable_enzymes.row(tr);

            showEditEnzymeDialog(row.data(), false);
        });

        // Metabolite in 2nd
        table_enzymes.on("click", ".cyano-metabolite", function(event) {
            var met = Metabolite.indexByName($(this).text());
            if (met >= 0) {
                showEditMetaboliteDialog(model.metabolites[met]);
            }
        });

        // Enabled in 4th col
        table_enzymes.delegate('tr td:nth-child(4) input', 'change', function() {
            var row = datatable_enzymes.row($(this).closest("tr"));

            row.data().enabled = ($(this).is(":checked"));

            command_list.push({
                "type": "reaction",
                "op": "edit",
                "id": row.data().id,
                "object": {
                    "id": row.data().id,
                    "enabled": row.data().enabled
                }
            });

            row.data().invalidate();
        });

        // First col
        table_metabolites.delegate('tr td:first-child', 'click', function() {
            var row = datatable_metabolites.row($(this).closest("tr"));

            showEditMetaboliteDialog(row.data());
        });

        // 4th col
        table_metabolites.delegate('tr td:nth-child(4) input', 'change', function() {
            var row = datatable_metabolites.row($(this).closest("tr"));

            row.data().external = $(this).is(":checked");

            command_list.push({
                "type": "metabolite",
                "op": "edit",
                "id": row.data().id,
                "object": {
                    "id": row.data().id,
                    "name": row.data().name,
                    "external": row.data().external
                }
            });

            row.data().invalidate();
        });

        // Enzyme in 2nd or 3rd col
        table_metabolites.on("click", ".cyano-enzyme", function(event) {
            var enzyme = Enzyme.indexByName($(this).text());
            if (enzyme >= 0) {
                showEditEnzymeDialog(model.reactions[enzyme], false);
            }
        });

        table_metabolites.on({
            mouseenter: function () {
                $(this).data("toggle", "tooltip");
                $(this).data("placement", "top");

                var enzyme = Enzyme.indexByName($(this).text());
                if (enzyme == -1) {
                    var text = "Error!";
                } else {
                    var text = model.reactions[enzyme].reactionToString();
                }

                $(this).prop("title", text);
                $(this).tooltip("show");
            },
            mouseleave: function () {
            }
        }, ".cyano-enzyme");
        $(".create-enzyme-button").click(function (event) {
            showAddEnzymeDialog();
        });
        $(".create-metabolite-button").click(function (event) {
            showAddMetaboliteDialog();
        });

        $(".delete-metabolites-button").click(function (event) {
            $("#dialog-delete-metabolites").modal('show');
        });

        $("#dialog-delete-metabolites").find(".btn-primary").click(function() {
            model.metabolites.filter(function(m) {
                return m.isUnused();
            }).forEach(function(m) {
                m.remove();
                m.removeFromList();

                command_list.push({
                    "type": "metabolite",
                    "op": "delete",
                    "id": m.id,
                    "object": {}
                });
            });
            datatable_metabolites.draw();

            $("#dialog-delete-metabolites").modal("hide");
        });

        $(".cyano-design-reactions").on("click", ".cyano-design-reaction", function() {
            var index = enzymes_design.indexOf(getEnzymeByName($(this).text()));
            if (index > -1) {
                enzymes_design.splice(index, 1);
            }
            updateEnzymeDesignList();
        });
        dialog_enzyme.on("click", "div.cyano-metabolite", function(event) {
            var item = $(event.target).data("object");
            saveEnzyme(dialog_enzyme.data("object"));
            dialog_metabolite_edit.find("input.name").val(item.name);
            dialog_metabolite_edit.find("#external").prop("checked", item.external);
            dialog_metabolite_edit.data("object", item);

            dialog_metabolite_edit.dialog("open");
        });
        dialog_enzyme.find("#constrained:checkbox").change(function() {
            if ($(this).is(":checked")) {
                constraints_div.show();
            } else {
                constraints_div.hide();
            }
        });

        $("#auto_flux").prop("checked", true);
        $(".cyano-design-reaction-filter").hide();
        $("#auto_flux").change(function() {
            $(".cyano-design-reaction-filter").hide();
        });
        $("#manual_flux").change(function() {
            $(".cyano-design-reaction-filter").show();
        });

        // delete button clicked
        datatable_enzymes.on("click", ".delete-button", function(event) {
            var parent = $(this).closest("tr");
            var dialog_delete = $("#dialog-delete");
            var row = datatable_enzymes.row(parent);

            dialog_delete.data("parent", parent);
            dialog_delete.find(".reaction-name").text(row.data().name);
            dialog_delete.modal('show');
        });

        $("#dialog-delete").find(".btn-primary").click(function () {
            var dialog_delete = $("#dialog-delete");

            var reaction = datatable_enzymes.row(dialog_delete.data("parent")).data();
            var rmets = reaction.getMetabolites();
            var del_mets = dialog_delete.find("input").prop("checked");
            reaction.remove();

            command_list.push({
                "op": "delete",
                "type": "reaction",
	            "id": reaction.id,
                "object": {}
            });

            rmets.filter(function(m) {
                m.invalidate();
                return del_mets && m.isUnused();
            }).forEach(function(m) {
                m.remove();
                m.removeFromList();

                command_list.push({
                    "type": "metabolite",
                    "op": "delete",
                    "id": m.id,
                    "object": {}
                });
            });

            cyano_design_objective_select[0].selectize.removeOption(reaction.name);
            cyano_design_design_objective_select[0].selectize.removeOption(reaction.name);
            design_objective_visible_combobox[0].selectize.removeOption(reaction.name);
            cyano_design_target_objective_select[0].selectize.removeOption(reaction.name);

            datatable_metabolites.draw();

            dialog_delete.modal("hide");

            dialog_delete.data("parent").fadeOut(200, function() { datatable_enzymes.row(this).remove().draw(); });
        });

        var cdos = {
            delimiter: ',',
            labelField: "name",
            valueField: "id",
            sortField: "name",
            searchField: ["name"],
            onChange: function(value) {
                design_objective = model.reaction.get("id", value);
            }
        };

        cyano_design_objective_select.selectize(cdos);
        cyano_design_design_objective_select.selectize(cdos);
        cyano_design_target_objective_select.selectize(cdos);

        design_objective_visible_combobox.selectize({
            delimiter: '\x00',
            labelField: "name",
            valueField: "id",
            searchField: ["name"],
            plugins: ['drag_drop', 'remove_button', 'restore_on_backspace'],
            maxItems: 20
        });

        dialog_enzyme.find("#reaction-pathway").selectize({
            labelField: "text",
            valueField: "id",
            sortField: "text",
            searchField: ["text"],
            create: true
        });

        var load_model = function() {
            $.ajax({
                url: "{% url "cyanodesign:get_reactions" pk=pk %}{% if revision %}?revision={{ revision.pk }}{% endif %}",
                context: document.body
            }).done(function(x) {
                model = new MetabolicModel.Model();
                model.fromJson(x);

                updateEnzymeList();
                updateMetabolitesList();

                $("#radio-maximize").prop("checked", true);
                setSimulationType("fba");

                if (x.objectives && x.objectives.length > 0) {
                    cyano_design_objective_select[0].selectize.setValue(x.objectives[0].name);
                    if (x.objectives[0].maximize == false) {
                        $("#radio-minimize").prop("checked", true);
                    }
                }

                if (x.design_objectives && x.design_objectives.length > 0) {
                    cyano_design_design_objective_select[0].selectize.setValue(x.design_objectives[0].name);
                }

                waitIndicator.hide($("#content"));
            });
        }

        table_enzymes.css("width", "");
        table_metabolites.css("width", "");

        var isDragging = false;

        $("#visual_fba").on("click", "g.node", function() {
            var idx = Metabolite.indexByName($(this).children("text").text());
            if (!isDragging & idx > -1) {
                showEditMetaboliteDialog(model.metabolites[idx]);
            }
        });

        $("#visual_fba").on("click", "g.edge text", function() {
            // remove flux value
            var idx = Enzyme.indexByName($(this).text().replace(/ \(-?[0-9]+(\.[0-9]+)?\)$/, ""));
            if (!isDragging & idx > -1) {
                showEditEnzymeDialog(model.reactions[idx], false);
            }
        });

        $("#visual_fba").on("mousedown", "g", function(event) {
            isDragging = false;
            $(this).data('page', {x: event.pageX, y: event.pageY})
        });
        $("#visual_fba").on("mousemove", "g", function(event) {
            var p = $(this).data('page');
            if (p !== undefined) {
                if (Math.abs(p.x - event.pageX) > 4 ||
                    Math.abs(p.y - event.pageY) > 4) {
                    isDragging = true;
                }
            }
        });

        var updateLabels = function () {
            if (typeof(simulation_chart) === "undefined") {
                return;
            }

            simulation_chart.axis.labels({
                x: $("#mba-x-label").val(),
                y: $("#mba-y-label").val(),
                y2: $("#mba-y2-label").val()
            });
        };

        $("#mba-x-label").change(function() {
            updateLabels();
        });
         $("#mba-y-label").change(function() {
            updateLabels();
        });
         $("#mba-y2-label").change(function() {
            updateLabels();
        });

        $("#enzyme_regex").click(function() {
            datatable_enzymes.search("", $(this).prop("checked"), true).draw();
        });

        $("#metabolite_regex").click(function() {
            datatable_metabolites.search("", $(this).prop("checked"), true).draw();
        });

        $("#flux_regex").click(function() {
            datatable_flux.search("", $(this).prop("checked"), true).draw();
        });

        $("#create-enzyme-bulk-button").click(function() {
            $("#enzyme-bulkdata").val("");
            $("#dialog-reaction-bulkadd").modal("show");
        });

        $("#enzyme-bulkdata").keyup(function() {
            var lines = $("#enzyme-bulkdata").val().split(/\r*\n/);

            $("#enzyme-bulkadd-preview").empty();
            var buffered_line = "";
            lines.forEach(function(line) {
                var e;
                try {
                    var last = line.split(/\s+/g).pop();
                    if (last === "undefined") {
                        return;
                    }
                    if (last == "<->" || last == "->" || last == "+") {
                        buffered_line += " " + line;
                        return;
                    }

                    buffered_line += " " + line;

                    buffered_line = buffered_line.trim();

                    if (buffered_line.length == 0) {
                        return;
                    }

                    e = Enzyme.fromBioOptString(buffered_line).toString();

                    buffered_line = "";
                } catch (err) {
                    e = err["enzyme"].toString() + " Error: " + err["message"];
                }
                if (e !== 'undefined') {
                    $("<div>").text(e).appendTo($("#enzyme-bulkadd-preview"));
                }
            });
        });

        $("#dialog-reaction-bulkadd").on("click", ".btn-primary", function(event) {
            var lines = $("#enzyme-bulkdata").val().split(/\r*\n/);

            $("#enzyme-bulkadd-preview").empty();
            lines.forEach(function(line) {
                try {
                    var mlen = model.metabolites.length;
                    var reaction = Enzyme.fromBioOptString(line);

                    Metabolite.fromReaction(reaction);
                    if (model.metabolites.length > mlen) {
                        model.metabolites.slice(mlen).forEach(function (metabolite) {
                            command_list.push({
                                "type": "metabolite",
                                "op": "add",
                                "id": metabolite.id,
                                "object": {
                                    "id": metabolite.id,
                                    "name": metabolite.name,
                                    "external": metabolite.external
                                }
                            });

                            datatable_metabolites.row.add(metabolite);
                        });
                    }

                    reaction.convertToFloat();

                    var command = {
                        "type": "reaction",
                        "id": reaction.id,
                        "object": jQuery.extend(true, {}, reaction)
                    };

                    if (Enzyme.indexByName(reaction.name) != -1) {
                        // Reaction exists
                        var orig_enzyme = model.reactions[Enzyme.indexByName(reaction.name)];

                        orig_enzyme.name = reaction.name;
                        orig_enzyme.substrates = reaction.substrates;
                        orig_enzyme.products = reaction.products;
                        orig_enzyme.reversible = reaction.reversible;

                        command["op"] = "edit";
                    } else {

                        model.reactions.push(reaction);

                        datatable_enzymes.row.add(reaction);

                        cyano_design_objective_select[0].selectize.addOption(reaction);
                        cyano_design_objective_select[0].selectize.refreshOptions();
                        cyano_design_design_objective_select[0].selectize.addOption(reaction);
                        cyano_design_design_objective_select[0].selectize.refreshOptions();
                        design_objective_visible_combobox[0].selectize.addOption(reaction);
                        design_objective_visible_combobox[0].selectize.refreshOptions();
                        cyano_design_target_objective_select[0].selectize.addOption(reaction);
                        cyano_design_target_objective_select[0].selectize.refreshOptions();

                        command["op"] = "add";
                    }

                    command_list.push(command);

                    reaction.updateMetaboliteReference(model).forEach(function(m) {
                        m.invalidate();
                    });
                    reaction.invalidate();
                } catch (err) {

                }
            });

            datatable_metabolites.sort();
            datatable_metabolites.draw();

            datatable_enzymes.sort();
            datatable_enzymes.draw();

            $("#dialog-reaction-bulkadd").modal("hide");
        });

        waitIndicator.show($("#content"));
        loadModel = load_model;
    });
</script>

<script id="filter_row" type="text/plain">
<div class="col-sm-6">
<label for="cyano-enzyme-list-filter-reactions">Filter reactions</label>
<select id="cyano-enzyme-list-filter-reactions" class="form-control combobox" multiple="multiple">
    <optgroup label="Enabled">
    <option selected="selected">Active</option>
    <option selected="selected">Inactive</option>
    </optgroup>
    <optgroup label="Constraints">
    <option selected="selected">Constraint</option>
    <option selected="selected">Unconstraint</option>
    </optgroup>
    <optgroup label="Reversible">
    <option selected="selected">Reversible</option>
    <option selected="selected">Irreversible</option>
    </optgroup>
</select>
</div>
<div class="col-sm-6">
    <div class="dataTables_filter">
    <div class="checkbox">
    <input id="enzyme_regex" type="checkbox">
    <label for="enzyme_regex">Search with RegExp</label>
    </div>
    </div>
</div>
</script>

<script id="filter_row_metabolites" type="text/plain">
<div class="col-sm-6">
<label for="cyano-metabolite-list-filter-reactions">Filter metabolites</label>
<select id="cyano-metabolite-list-filter-reactions" class="form-control combobox" multiple="multiple">
    <option selected="selected">Is internal</option>
    <option selected="selected">Is external</option>
</select>
</div>
<div class="col-sm-6">
    <div class="dataTables_filter">
    <div class="checkbox">
    <input id="metabolite_regex" type="checkbox">
    <label for="metabolite_regex">Search with RegExp</label>
    </div>
    </div>
</div>
</script>

<script id="filter_row_flux" type="text/plain">
<div class="col-sm-3">
    <div class="form-group">
        <label class="control-label" for="filter-flux-min">Min Flux:</label>
        <input id="filter-flux-min" class="form-control" type="text">
    </div>
</div>
<div class="col-sm-3">
        <label class="control-label" for="filter-flux-max">Max Flux:</label>
        <input id="filter-flux-max" class="form-control" type="text">
</div>
<!--
<label for="cyano-metabolite-list-filter-reactions">Filter metabolites</label>
<select id="cyano-metabolite-list-filter-reactions" class="form-control combobox" multiple="multiple">
    <option selected="selected">Is internal</option>
    <option selected="selected">Is external</option>
</select>-->
</div>
<div class="col-sm-6">
    <div class="dataTables_filter">
    <div class="checkbox">
    <input id="flux_regex" type="checkbox">
    <label for="flux_regex">Search with RegExp</label>
    </div>
    </div>
</div>
</script>
{% endblock %}

{% block extrastyles %}
span.cyano-external-metabolite { color: green }

#cyano-metabolite-list tr td:first-child,
#cyano-enzyme-list tr td:first-child {
    font-weight: bold;
}

.hoverable,
#cyano-metabolite-list .cyano-enzyme,
#cyano-metabolite-list tr td:first-child,
#cyano-enzyme-list tr td:first-child,
#cyano-enzyme-list .cyano-metabolite,
svg g.node,
svg text
{
    cursor: pointer;
}
.hoverable:hover,
#cyano-metabolite-list .cyano-enzyme:hover,
#cyano-metabolite-list tr td:first-child:hover,
#cyano-enzyme-list tr.odd td:first-child:hover,
#cyano-enzyme-list tr.even td:first-child:hover,
#cyano-enzyme-list .cyano-metabolite:hover
{
    color: blue;
}

.cyano-enzyme-disabled
{
    color: grey;
}

#submit-form
{
    display: none;
}

.tab-content
{
    margin-top: 5px;
    margin-bottom: 5px;
}
{% endblock %}

{% block content %}

{% if not request.user.is_authenticated %}
<div class="alert alert-info" role="alert">
        <span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
        <span class="sr-only">Info:</span>You are not logged in. Making permanent changes to models or uploading new ones is disabled.</div>
</div>
{% endif %}

{% if revision %}
<div class="alert alert-info" role="alert">
Viewing old model from {{ revision.date }}. Simulating and saving will be based on this old version of the model.
</div>
{% endif %}

<div role="tabpanel">

<ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#reaction-tab" role="tab" data-toggle="tab">Reactions</a></li>
    <li role="presentation"><a href="#metabolite-tab" role="tab" data-toggle="tab">Metabolites</a></li>
    <li role="presentation"><a href="#settings-tab" role="tab" data-toggle="tab">Settings</a></li>
    <li role="presentation"><a href="#chemical-tab" role="tab" data-toggle="tab">Stoichiometry</a></li>
    <li role="presentation"><a href="#simulation-tab" role="tab" data-toggle="tab">Simulation</a></li>
</ul>

<div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="reaction-tab">
        <table id="cyano-enzyme-list" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Reaction</th>
                    <th>Constraint</th>
                    <th>Active</th>
                    <th></th>
                </tr>
            </thead>
        </table>

        <div class="btn-group">
            <button type="button" class="btn btn-primary create-enzyme-button">
            Create new reaction
            </button>
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="caret"></span>
                <span class="sr-only">Toggle Dropdown</span>
            </button>
            <ul class="dropdown-menu">
                <li><a href="#" id="create-enzyme-bulk-button">Bulk add reactions</a></li>
            </ul>
        </div>
        <button type="button" class="btn btn-primary create-metabolite-button">
        Create new metabolite
        </button>
    </div>
    <div role="tabpanel" class="tab-pane" id="metabolite-tab">
        <table id="cyano-metabolite-list" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Consumed by</th>
                    <th>Produced by</th>
                    <th>Is External</th>
                </tr>
            </thead>
        </table>

        <button type="button" class="btn btn-primary create-enzyme-button">
        Create new reaction
        </button>
        <button type="button" class="btn btn-primary create-metabolite-button">
        Create new metabolite
        </button>
        <button type="button" class="btn btn-danger delete-metabolites-button">
        Delete unused metabolites
        </button>
    </div>

    <div role="tabpanel" class="tab-pane" id="settings-tab">
        <div class="cyano-design-objective">
            <fieldset>
                <div class="form-group">
                    <label class="control-label" for="cyano-design-objective-select">Main objective</label>
                    <select id="cyano-design-objective-select" placeholder="Select a main objective"></select>
                </div>

               <div class="radio">
                    <input type="radio" name="maxmingroup" id="radio-maximize" value="maximize-obj">
                    <label for="radio-maximize">
                        Maximize objective
                    </label>
                </div>
                <div class="radio">
                    <input type="radio" name="maxmingroup" id="radio-minimize" value="minimize-obj">
                    <label for="radio-minimize">
                        Minimize objective
                    </label>
                </div>
            </fieldset>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Simulation Type</h3>
            </div>
            <div class="panel-body" id="simulation-type">
                <div class="radio">
                    <input type="radio" name="simulationtype" id="radio-fba">
                    <label for="radio-fba">
                        Flux Balance Analysis
                    </label>
                </div>
                <div class="radio">
                    <input type="radio" name="simulationtype" id="radio-mba">
                    <label for="radio-mba">
                        Robustness Analysis
                    </label>
                </div>
                <div class="radio">
                    <input type="radio" name="simulationtype" id="radio-sa">
                    <label for="radio-sa">
                        Sensitivity Analysis
                    </label>
                </div>
            </div>
        </div>

        <div class="panel panel-default" id="fba-settings-panel">
            <div class="panel-heading">
                <h3 class="panel-title">FBA settings</h3>
            </div>

            <div class="panel-body" id="settings-fba">
                <div>
                    The main objective is always displayed in the simulation.
                </div>

                <div>
                    <div class="radio">
                        <input id="auto_flux" type="radio" name="flux" value="auto_flux">
                        <label for="auto_flux">Display reactions with highest flux connected to the objective</label>
                    </div>
                    <div class="radio">
                        <input id="manual_flux" type="radio" name="flux" value="manual_flux">
                        <label for="manual_flux">Display selected reactions</label>
                    </div>
                </div>

                <div class="cyano-design-reaction-filter">
                    <fieldset>
                        <div class="form-group">
                            <label class="control-label" for="design-objective-visible-combobox">Select visible reactions</label>
                            <input id="design-objective-visible-combobox">
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>

        <div class="panel panel-default" id="sa-settings-panel">
            <div class="panel-heading">
                <h3 class="panel-title">Sensitivity/RA settings</h3>
            </div>

            <div class="panel-body" id="settings-mba">
                <fieldset>
                    <div class="form-group">
                        <label class="control-label" for="cyano-design-design-objective-select">Design objective</label>
                        <select id="cyano-design-design-objective-select" placeholder="Select a design objective"></select>
                    </div>
                    <div class="form-group" id="sa-settings-target-function-panel">
                        <label class="control-label" for="cyano-design-target-objective-select">Target reaction</label>
                        <select id="cyano-design-target-objective-select" placeholder="Select a target reaction"></select>
                    </div>
                </fieldset>
            </div>
        </div>

        <div class="panel panel-default" id="sa-settings-axis-panel">
            <div class="panel-heading">
                <h3 class="panel-title">Axis label</h3>
            </div>

            <div class="panel-body">
                <fieldset>
                    <label class="control-label" for="mba-x-label">X-Axis</label>
                    <input class="form-control" type="text" id="mba-x-label">
                    <label class="control-label" for="mba-y-label">Y-Axis (Left)</label>
                    <input class="form-control" type="text" id="mba-y-label">
                    <label class="control-label" for="mba-y2-label">Y-Axis (Right)</label>
                    <input class="form-control" type="text" id="mba-y2-label">
                    Changes apply without running a new simulation
                </fieldset>
            </div>
        </div>


    </div>

    <div role="tabpanel" class="tab-pane" id="chemical-tab">
        <table id="cyano-chemical-list" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Left</th>
                    <th>Right</th>
                    <th>Difference</th>
                </tr>
            </thead>
        </table>
    </div>

    <div role="tabpanel" class="tab-pane" id="simulation-tab">
        <div class="checkbox">
            <input type="checkbox" name="remember-simulation" id="remember-simulation">
            <label for="remember-simulation">Combine results with previous simulation</label>
        </div>
        <button type="button" id="design-submit" class="btn btn-primary">Run simulation</button>
        <div id="export-button" class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
            Export <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" role="menu">
            <!--<li><a id="export-csv" href="#">As flux list</a></li>-->
            <li><a id="export-png" href="#">As image</a></li>
            <li><a id="export-svg" href="#">As vector graphic</a></li>
            </ul>
        </div>

        <div id="simulation-result">
        </div>
        <div id="visual_graph">

        </div>
        <div id="visual_fba">

        </div>

        <table id="cyano-flux-list" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Flux</th>
                </tr>
            </thead>
        </table>
    </div>
</div>
</div>

<!-- Modal -->
<div class="modal fade" id="dialog-reaction" tabindex="-1" role="dialog" aria-labelledby="dialog-reaction-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-reaction-label">Edit Reaction</h4>
            </div>
            <div class="modal-body">
                <form>
                    <fieldset>
                        <div class="form-group">
                            <label class="control-label" for="enzyme-name">Name</label>
                            <input class="form-control" type="text" id="enzyme-name">
                        </div>
                        <div class="form-group" style="display: none">
                            <label for="reaction-pathway">Pathway</label>
                            <select id="reaction-pathway" placeholder="Select or enter pathway"></select>
                        </div>
                        <div class="form-group">
                            <label for="reaction-substrates">Substrates</label>
                            <input id="reaction-substrates" type="text">
                        </div>
                        <div class="form-group">
                            <label for="reaction-products">Products</label>
                            <input id="reaction-products" type="text">
                        </div>
                        <div class="checkbox">
                            <input type="checkbox" name="enabled" id="enabled">
                            <label for="enabled">Enabled</label>
                        </div>
                        <div class="checkbox">
                            <input type="checkbox" name="reversible" id="reversible">
                            <label for="reversible">Reversible</label>
                        </div>
                        <div class="checkbox">
                            <input type="checkbox" name="constrained" id="constrained">
                            <label for="constrained">Constrained</label>
                        </div>
                        <div id="constraints-min-max" class="form-inline">
                            <div class="form-group">
                                <label class="control-label" for="constrained-min">Min</label>
                                <input name="constrained_min" id="constrained-min" class="form-control" type="text">
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="constrained-max">Max</label>
                                <input name="constrained_max" id="constrained-max" class="form-control" type="text">
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary">Save changes</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="dialog-reaction-bulkadd" tabindex="-1" role="dialog" aria-labelledby="dialog-reaction-bulkadd-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-reaction-bulkadd-label">Bulk add reactions</h4>
            </div>
            <div class="modal-body">
                <form>
                    <fieldset>
                        Enter reactions in BioOpt format for adding them to the model. Constraints can be put after the reactions.<br>
                        <div class="form-group">
                            <label class="control-label" for="enzyme-bulkdata">BioOpt data:</label>
                            <textarea class="form-control" id="enzyme-bulkdata" placeholder="reac1: a + 2 b -> 3.5 c [-1, 1]" rows="5"></textarea>
                        </div>
                        <div class="form-group" id="enzyme-bulkadd-preview">

                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary">Save changes</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="dialog-add-metabolite" tabindex="-1" role="dialog" aria-labelledby="dialog-add-metabolite-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-add-metabolite-label">Create Metabolite</h4>
            </div>
            <div class="modal-body">
                <form>
                    <fieldset>
                        <div class="form-group">
                            <label for="add-metabolite-name">Name</label>
                            <input type="text" id="add-metabolite-name" class="form-control">
                        </div>

                        <div class="checkbox">
                            <input type="checkbox" id="add-external">
                            <label for="add-external">External</label>
                        </div>

                        <div class="form-group">
                            <label for="add-chemical">Chemical formula</label>
                            <input type="text" id="metabolite-chemical" class="form-control">
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary">Create</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="dialog-edit-metabolite" tabindex="-1" role="dialog" aria-labelledby="dialog-edit-metabolite-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-edit-metabolite-label">Edit Metabolite</h4>
            </div>
            <div class="modal-body">
                <form>
                    <fieldset>
                        <p>The metabolite is modified in all reactions.</p>

                        <div class="form-group">
                            <label for="metabolite-name">Name</label>
                            <input type="text" id="metabolite-name" class="form-control">
                        </div>

                        <div class="checkbox">
                            <input type="checkbox" id="external">
                            <label for="external">External</label>
                        </div>

                        <div class="form-group">
                            <label for="metabolite-chemical">Chemical formula</label>
                            <input type="text" id="metabolite-chemical" class="form-control">
                        </div>
                    </fieldset>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary">Save changes</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="dialog-delete" tabindex="-1" role="dialog" aria-labelledby="dialog-delete-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-delete-label">Delete <span class="reaction-name"></span></h4>
            </div>
            <div class="modal-body">
                Do you really want to delete reaction <span class="reaction-name"></span>?

                <div class="form-group">
                <div class="checkbox">
                    <input id="dialog-delete-unused-metabolites" type="checkbox">
                    <label for="dialog-delete-unused-metabolites">Delete unused metabolites</label>
                </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-danger">Delete</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="dialog-delete-metabolites" tabindex="-1" role="dialog" aria-labelledby="dialog-delete-metabolites-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="dialog-delete-metabolites-label">Delete unused metabolites</h4>
            </div>
            <div class="modal-body">
                Do you really want to delete all unused metabolites?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary btn-danger">Delete</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="dialog-save-model" tabindex="-1" role="dialog" aria-labelledby="dialog-save-model-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            {% crispy save_form %}
        </div>
    </div>
</div>

<div class="modal fade" id="dialog-saveas-model" tabindex="-1" role="dialog" aria-labelledby="dialog-saveas-model-label"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            {% crispy saveas_form %}
        </div>
    </div>
</div>

{% if request.user.is_authenticated %}
<input type="submit" id="design-save" class="btn btn-primary" value="Save">
<input type="submit" id="design-saveas" class="btn btn-primary" value="Save As">
{% endif %}

<form method="post" action="{% url "cyanodesign:simulate" pk=pk %}" id="submit-form">
{% csrf_token %}
</form>

{% endblock %}
