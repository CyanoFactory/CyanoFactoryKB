{% extends "cyano/base.html" %}

{% comment %}
Protein-Interaction Page

Copyright (c) 2013 Gabriel Kind <gkind@hs-mittweida.de>,  Eric Zuchantke <ezuchant@hs-mitteida.de>
Hochschule Mittweida, University of Applied Sciences

Released under the MIT license
{% endcomment %}

{% load static %}
{% load templatetags %}
{% load filters %}

{% block head_title %}{{ block.super }} :: Interaction: {{ prot_name }}{% endblock %}
{% block page_title %} {{ prot_name }} - {{ name }} {% endblock %}

{% block head %}
{{ block.super }}
<script language="javascript" type="text/javascript" src="{% get_static_prefix %}cyano/js/endless.js"></script>
<script language="javascript" type="text/javascript" src="{% get_static_prefix %}cyano/js/endless_on_scroll.js"></script>
<script type="text/javascript" charset="utf-8">var endless_on_scroll_margin = 200;</script>
<script src="{% get_static_prefix %}stringdb/d3/d3.v3.min.js"></script>
<script type="text/javascript">
{% include "kegg/script.js" %}
</script>

{% endblock %}

{% block extrastyles %}
#listfilter .nofilters{
	font-style:italic;
	text-align:center;
}

#list{
	width:100%;
}
#listfilter{
	display:none;
}

#sidebar {
	position:absolute;
	right: -200px;
	width: 200px;
	margin: 0px -30px;
	padding: 10px 10px;
	border: 5px;
	border:1px solid #3d80b3;
	border-radius: 8px;
    color: black;
    font-weight: normal;
}
#search_box {
	width: 100%;
	border:1px solid #3d80b3;
	border-radius:6px;
}

        .node {
          stroke: #fff;
        }

        .node text {
          pointer-events: none;
          stroke: #000;
          stroke-width: .1px;
        }

        .link {
          stroke-opacity: .4;
        }
#checkboxcontainer > .checkboxcontainer_field {display:inline;}

#buttoncontainer > .buttoncontainer_field {display:inline;}

#checkboxcontainer{
    margin-left: 15px;
    }

#buttoncontainer{
    margin-top: 8px;
    margin-left: 15px;
    float: left;
    }
#javascriptcontainer{
    border-radius: 8px;
    }
#helpbox{
    margin-top: 15px;
    float: right;
    }

.ui-progressbar-value {
    background: rgb(61, 128, 179);
    }

    .no-close .ui-dialog-titlebar-close {
    display: none;
    }
#networkvisualization{
	border:1px solid #3d80b3;
    margin-bottom: 20px;
    }
.overlay {
    fill: none;
    pointer-events: all;
    }
#content table th, #content table td {
    padding-right: 10px;
    text-align: center;
}
#detail tbody tr th, #detail tbody tr td {
    padding-left: 2px;
    padding-right: 2px;
    vertical-align: middle;
}
{% endblock %}

{% block content %}

    <div id="networkvisualization">
        <div id="dialog-progressbar" title="Please wait...">
        <div id="progressbar"></div>
        </div>

         <div id="checkboxcontainer" class="checkboxcontainer">
            <h3>Select Source</h3>
        </div>
        <div id="helpbox" class="helpbox">
        </div>
        <div id="buttoncontainer" class="buttoncontainer">
            <h3>Add/Remove Proteins</h3>
            <input name="-10" type="button" class="demo" value=-10 onclick="expandNetwork(value)"/>
            <input name="-5" type="button" class="demo" value=-5 onclick="expandNetwork(value)"/>
            <input name="-1" type="button" class="demo" value=-1 onclick="expandNetwork(value)"/>
            <input name="+1" type="button" class="demo" value=+1 onclick="expandNetwork(value)"/>
            <input name="+5" type="button" class="demo" value=+5 onclick="expandNetwork(value)"/>
            <input name="+10" type="button" class="demo" value=+10 onclick="expandNetwork(value)"/>
        </div>

        <div id="javascriptcontainer" class="javascriptcontainer">
        </div>
    </div>

    <script>

            /** Generate Checkboxes */
            createCheckboxes();

            /** Create checkboxes with given list items and checks the status of these checkboxes */
            function createCheckboxes(){
                d3.select(".checkboxcontainer").selectAll("div")
                        .data([
                            {% for key in list %}
                            {% if not forloop.first %}, {% endif %}
                                "{{ key }}"
                            {% endfor %}
                        ])
                        .enter()
                        .append("div")
                        .attr("class", "checkboxcontainer_field")
                        .append("label")
                        .each(function (d) {
                            d3.select(this).append("input")
                                    .attr("type", "checkbox")
                                    .attr("id", function(d) {
                                        return d;
                                    })
                            .property("checked", false)
                                    /** after un-/checking of an checkbox calling function filterlinks()*/
                                    .on("click", function(d) {
                                        filterLinks()
                                    })
                            d3.select(this).append("span")
                                    .text(function (d) {
                                        return d;
                                    });
                        })
            }

            var dialog_progressbar = $("#dialog-progressbar");

            dialog_progressbar.dialog({
                autoOpen: false,
                height: 100,
                width: 350,
                modal: true,
                closeOnEscape: false,
                dialogClass: "no-close"
            });
            var pbar = dialog_progressbar.find("#progressbar");
            pbar.progressbar();
            pbar.progressbar( "option", "value", false );

            var width = 800,
                height = 400;


            /** Generate Network */
            var jsonfile = '{{ json|safe }}';

            /** 2 fache parsen abstellen */
            var help = JSON.parse(jsonfile),
                ldomainlist = new Array,
                ndomainlist = new Array,
                nrangelist = new Array,
                lrangelist = new Array;

            for (var i in help.linkcolor){
            ldomainlist.push(help.linkcolor[i].value);
            lrangelist.push(help.linkcolor[i].color);
            };
            for (var i in help.nodecolor){
                ndomainlist.push(help.nodecolor[i].value);
                nrangelist.push(help.nodecolor[i].color);
            }

            var lcolor = d3.scale.linear()
                .domain(ldomainlist)
                .range(lrangelist);

            var ncolor = d3.scale.linear()
                .domain(ndomainlist)
                .range(nrangelist);

            var helpwidth = 200;
            var helpheight = 100;
            var helplegend = d3.select(".helpbox").append("svg")
                    .attr("width", helpwidth)
                    .attr("height", helpheight);

            drawhelp(jsonfile);

            function drawhelp(help){

                help = JSON.parse(help);
                ldomainlist = new Array;
                ndomainlist = new Array;
                nrangelist = new Array;
                lrangelist = new Array;

                helplegend.selectAll("text").remove();

                for (var i in help.linkcolor){
                    ldomainlist.push(help.linkcolor[i].value);
                    lrangelist.push(help.linkcolor[i].color);
                };
                for (var i in help.nodecolor){
                    ndomainlist.push(help.nodecolor[i].value);
                    nrangelist.push(help.nodecolor[i].color);
                }

                lcolor = d3.scale.linear()
                    .domain(ldomainlist)
                    .range(lrangelist);

                ncolor = d3.scale.linear()
                    .domain(ndomainlist)
                    .range(nrangelist);

                    helplegend.selectAll("rect").remove();
                    helplegend.selectAll("circle").remove();

                var fontsize = "10px",
                rectx = 90,
                recty = 40,
                rectwidth = 20,
                rectheight = 5,
                stepsize = 15,
                rectexty = recty+5,
                rectextx = rectx + 27;

                var rects = helplegend.selectAll("rect")
                        .data(help.linkcolor)
                        .enter()
                            .append("g");

                rects.append("rect")
                    .attr("width", rectwidth)
                    .attr("height", rectheight)
                    .attr("y", function(){
                            var result = recty;
                            recty += stepsize;
                            return result;
                        })
                    .attr("x", rectx)
                    .attr("fill", function (d){ return d.color});

                rects.append("text")
                        .attr("x", rectextx)
                        .attr("y", function(){
                            var result = rectexty;
                            rectexty += 15;
                            return result;})
                        .style("color", "black")
                        .style("font-size", fontsize)
                        .text(function(d) {return d.value == 0 ? "" : "... "+d.value});

                var circley = 25,
                    circlex = 10,
                    radius = 5,
                    dxtext = circlex+10,
                    dytext = circley+3;

                var circls = helplegend.selectAll("circle")
                        .data(help.nodecolor)
                        .enter().append("g");

                circls.append("circle")
                        .attr("cy", function () {
                                var result = circley;
                                circley += 15;
                                return result;
                            })
                        .attr("cx", circlex)
                        .attr("r", radius)
                        .attr("fill", function(d) {return d.color});

                circls.append("text")
                        .attr("dx", dxtext)
                        .attr("dy", function () {
                                var result = dytext;
                                dytext += 15;
                                return result;
                            })
                        .style("color", "black")
                        .style("font-size", fontsize)
                        .text(function (d){ return d.value == 0 ? "selected" : "... " + d.value })

                var legendNode = helplegend.append("text")
                            .attr("x", 5)
                            .attr("y", 10)
                            .style("font-size", "10px")
                            .text("Nr. of Interaction-Partner");

                var legendLink = helplegend.append("text")
                            .attr("x", 90)
                            .attr("y", 30)
                            .style("font-size", "10px")
                            .text("Interaction-Score");

            }

            var force = d3.layout.force()
                    .charge(calculateCharge())
                    .gravity(0.9)
                    .friction(0.9)
                    .size([width, height]);

            var protamount = +{{ limit }};

            var svg = d3.select(".javascriptcontainer").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("pointer-events","all")
                    /** Zoom feature disabled, conflict with drag */

                    //.call(d3.behavior.zoom().on("zoom", zoomed))
                    .append("svg:g");


            //svg.append("svg:rect")
            //        .attr("class", "overlay")
            //        .attr("width", width)
            //        .attr("height", height)
            //        .attr("fill", "white");

            function zoomed(){
                svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
            }

            update(jsonfile);

            /** Creating Interaction-Network */
            function update(json){

                drawhelp(json)

                svg.selectAll(".link")
                        .remove();
                svg.selectAll(".node")
                        .remove();

                var nodesize = calculateNodesize();
                var textsize = ""+calculateTextSize()+"px";

                var graph = JSON.parse(json);

                var nodes = graph.nodes;
                var links = graph.links;

                force
                    .nodes(nodes)
                    .links(links)
                    .linkDistance(function (d) {
                          return calculateLinkDistance(d, graph.links);
                      })
                    .start();

                var link = svg.selectAll("line")
                        .data(graph.links)
                    .enter().append("line")
                        .attr("class", "link")
                        .attr("stroke-width", calculateLinkThikness())
                        .style("stroke", function(d) { return lcolor(d.score);});

                var drag = force.drag()
                      .on("dragstart", dragstart);

                var node = svg.selectAll(".node")
                        .data(graph.nodes)
                    .enter().append("g")
                        .attr("class", "node")
                        .attr("id", function(d) { return d.id; })
                        .call(drag)
                        .attr("transform", function(d) { return "translate(" + d + ")"; })
                        .on("mouseover", nodeOver)
                        .on("mouseout", nodeOut)
                        .on("dbclick", dragstop);

                node.append("svg:a")
                /** #### NEEDS TO BE MODIFIED #### Link to each Node **/
                        .attr("xlink:href", function(d) {return "http://127.0.0.1:8000/stringdb/interaction/"+d.id+"/"})
                    .append("svg:circle")
                        .attr("r", nodesize)
                        .style("fill", function(d) { return ncolor(d.hood); });

                node.append("text")
                    .attr("dx", ""+(nodesize+7-0.7)+"")
                    .attr("dy", ".35em")
                    .style("color", "black")
                    .style("font-size", textsize)
                    .text(function(d) { return d.name });


                force.on("tick", function() {
                var qtree = d3.geom.quadtree(nodes),
                      i = 0,
                      n = nodes.length;

                while (++i < n) qtree.visit(collide(nodes[i]));

                link.attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });

                node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
                    .attr("cx", function(d) { return d.x = Math.max(nodesize, Math.min(width - (nodesize), d.x)); })
                    .attr("cy", function(d) { return d.y = Math.max(nodesize, Math.min(height - (nodesize), d.y)); });
                });
            }

            function nodeOut() {
                doHighlight(d3.select(this), false);
            }

            function nodeOver() {
                doHighlight(d3.select(this), true);
            }

            /** Highlight all links which are bounded with selected Node and hide all others*/
            function doHighlight(node, hl) {
                var nd = node.datum();
                var opacity = hl ? 0 : 0.4;
                var oopacity = hl ? 1 : 0.4;
                var nodeopacity = hl ? 0 : 1;
                var nodeoopacity = hl ? 1 : 0;
                var nodesize = calculateNodesize();
                var fontsize = calculateTextSize();
                var font = hl ? fontsize+Math.exp(1/fontsize*15) : fontsize;
                var nodeRadius = hl ?  nodesize+nodesize/2: nodesize;
                var nodecolor = hl ? "lawngreen" : "white";
                //var nwidth = hl ? ".5px" : ".1px";

                /** show/hide all links which are not connected with the selected node */
                svg.selectAll(".link")
                        .filter(function(d) {  return d.source.index != nd.index && d.target.index != nd.index; })
                        .transition().duration(750).style("stroke-opacity", opacity);

                svg.selectAll(".link")
                        .filter(function(d) {  return d.source.index == nd.index || d.target.index == nd.index; })
                        .transition().duration(750).style("stroke-opacity", oopacity);

                node.select("circle")
                    .transition()
                    .duration(750)
                    .attr("r", nodeRadius)
                    .style("stroke", nodecolor);
                node.select("text")
                    .transition()
                    .duration(750)
                    .style("font-size", ""+font+"px");
            }

            /** Expanding/Contract the Network based on the Klicked Button */
            function expandNetwork(d){
                var nnumber = +d;
                var amount = protamount + nnumber;
                protamount = amount
                if(amount != 0){
                    var text = "{% url "stringdb.views.onlygraph" %}?protid={{ protid }}&amount="+amount;
                    $.ajax({url:text,
                         beforeSend: function() {
                            dialog_progressbar.dialog("open")},
                         success:function(result){
                            jsonfile = result;
                            update(jsonfile);
                            dialog_progressbar.dialog("close");
                         }});
                }
                else{
                    alert("Not possible")
                }
            }

            /** Checking if selected link has stats for the selected Checkbox*/
            function checkBoxes(alink){
                var hide = false;
                d3.selectAll('input')
                        .each(function (d){
                            var abox = d
                            {% for key in list %}
                                if(abox === "{{ key }}"){
                                    if (this.checked && alink.{{ key }} == 0){
                                        hide = true;
                                    }

                                }
                            {% endfor %}
                            return false;
                        })
                return hide
            }

             /** Changing the opacity of each link depending on link stats, using checkBoxes() */
            function filterLinks(){
                var transition = 1000;
                d3.selectAll(".link")
                        .filter(function (d) {
                            return checkBoxes(d);
                        })
                        .transition().duration(transition).style("opacity", 0);
                d3.selectAll(".link")
                        .filter(function (d) {
                            return !checkBoxes(d);
                        })
                        .transition().duration(transition).style("opacity", 1);
            }

            /** dragging nodes ends with pin the node to specific place */
            function dragstart(d){
                d3.select(this).classed("fixed", d.fixed = true)
            }

            /** unpinning node ### NOT IN USE AT THIS MOMENT ### */
            function dragstop(d){
                d3.select(this).classed("fixed", d.fixed = false);
            }

            /** dynamical calculation of Distance between nodes, using the score Value of each link */
            function calculateLinkDistance(alink, links){
                var mean = 0;
                for (var i = 0; i < links.length; i++){
                    var dat = +links[i].score;
                    var scorev = dat;
                    mean = mean + scorev;
                }
                mean = mean/links.length;
                var k1 = 160;
                var unscaledDistance = (1/alink.score)*mean*k1;
                var k2 = 400
                var scaledDistance = unscaledDistance/(Math.exp(protamount/k2));
                return scaledDistance;
            }

            /** dynamical calculation of Charge-Value after refresh of the network */
            function calculateCharge(){
                return -5*protamount*2;
            }

            /** dynamical calculation of Nodesize */
            function calculateNodesize(){
                return 1/protamount*80;
            }

            /** dynamical calculation Linkstrengt */
            function calculateLinkThikness(){
                return 1/protamount*20
            }

            function calculateTextSize(){
                return 1/protamount*150
            }

            /** Calculating Collision between nodes an prevent node overlapping*/
            function collide(node) {
                var r = calculateNodesize()*2,
                nx1 = node.x - r,
                nx2 = node.x + r,
                ny1 = node.y - r,
                ny2 = node.y + r;
                return function(quad, x1, y1, x2, y2){
                    if (quad.point && (quad.point !== node)){

                        var x = node.x - quad.point.x,
                            y = node.y - quad.point.y,
                            l = Math.sqrt(x * x + y * y),
                            r =  calculateNodesize()*6;
                        if (l < r) {
                            l = (l - r) / l * 0.5;
                            node.x -= x *= l;
                            node.y -= y *= l;
                            quad.point.x += x;
                            quad.point.y += y;
                        }
                    }
                    return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
                };
            }

            /** Creates Buttons for Selecting Size of Network - NOT WORKING CORRECT, NOT ENABLED*/
            function createButtons(){
                d3.select(".buttoncontainer").selectAll("div")
                        .data(["-10", "-5", "-1", "+1", "+5", "+10"])
                        .enter()
                        .append("div")
                        .attr("class", "buttoncontainer_field")
                        .append("label")
                        .each(function (d) {
                            d3.select(this).append("input")
                                    .attr("type", "button")
                                    .attr("id", function(d) {
                                        return d;
                                    })
                                    .attr("value", function (d) {
                                        return d;
                                    })
                            .onclick(expandNetwork(d));
                        })
            }
        </script>

    <div id="tablediv" class="tablediv">
        </table>
            <table id="detail">
                <tbody class="data">
                    <tr>
                        <th>Protein</th>
                        <th>Name</th>
                        {% for key in list %}
                            <th>{{ key }}</th>
                        {% endfor %}
                        <th>Score</th>
                    </tr>
                {% include "stringdb/list_page.html" %}
                </tbody>
                <tbody class="spacing">
                        <tr><td colspan="2">&nbsp;</td></tr>
                </tbody>
            </table>
        </div>
{% endblock %}
